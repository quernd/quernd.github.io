<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-12-11 Tue 12:06 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Twelve Days of Christmas #8</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Daniel Quernheim">
<link rel='stylesheet' href='/style.css' type='text/css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><div id="preamble" class="status">
<div id='nav'><a href="/">home</a></div>
</div>
<div id="content">
<h1 class="title">Twelve Days of Christmas #8</h1>
<div class="warning">
<p>
This was the first version of this tutorial.  Please visit the <a href="../index.html">new
version</a> instead.
</p>

</div>

<p>
This is the eighth part of <a href="../index-old.html">a chess-themed tutorial</a> on writing an SPA in
<a href="https://github.com/OvermindDL1/bucklescript-tea">Bucklescript-TEA</a>.  After this part, your app will look similar to <a href="demo.html">this demo</a>.
</p>


<p>
Yesterday, we implemented the move list by using a functional
programming technique called the &ldquo;zipper&rdquo;.  Today, we will now add the
possibility to load chess games from the popular Lichess server, as well
as client-side routing.  This will turn our program into what is
usually called a <a href="https://en.wikipedia.org/wiki/Single-page_application">&ldquo;single-page application&rdquo;</a> (SPA).  Start from tag <code>day7</code> if you are following along with my
repository.
</p>

<div id="outline-container-org283f9b4" class="outline-2">
<h2 id="org283f9b4">Responsive CSS</h2>
<div class="outline-text-2" id="text-org283f9b4">
<p>
First, let&rsquo;s account for the fact that users with different devices
might use our app, and let&rsquo;s scale and arrange the content on the
screen according to the size of the browser window.  On a wide screen,
it makes sense to have the move list and the board side by side, but
on a narrow screen such as a phone in portrait format, the move list
should be under the screen. Also the board should scale up and down according to
the browser window size.
</p>

<p>
Let&rsquo;s first refactor the main view so we can assign styles easier:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">buttons_view</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #6434A3;">List.</span>map <span style="color: #a52a2a;">(</span>map board_msg<span style="color: #a52a2a;">)</span> <span style="color: #6434A3;">Board.</span>buttons_view <span style="color: #a52a2a;">@</span>
  <span style="color: #a52a2a;">[</span> button <span style="color: #a52a2a;">[</span>onClick <span style="color: #000000; background-color: #FFFFFF;">Random_button</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"random move"</span><span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">;</span> button <span style="color: #a52a2a;">[</span>onClick <span style="color: #000000; background-color: #FFFFFF;">Back_button</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"back"</span><span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">;</span> button <span style="color: #a52a2a;">[</span>onClick <span style="color: #000000; background-color: #FFFFFF;">Fwd_button</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"forward"</span><span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">|&gt;</span> nav <span style="color: #a52a2a;">[</span>id <span style="color: #008000;">"buttons"</span><span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">header_nav_view</span> <span style="color: #a52a2a;">=</span>
  nav <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"top"</span><span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span>
        <span style="color: #a52a2a;">[</span> li <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"home"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"TEA-Chess"</span><span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">;</span> li <span style="color: #a52a2a;">[]</span>
            <span style="color: #a52a2a;">[</span> a <span style="color: #a52a2a;">[</span>href <span style="color: #008000;">"https://quernd.github.io/tutorials/tea-chess"</span><span style="color: #a52a2a;">]</span>
                <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"Tutorial"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">;</span> li <span style="color: #a52a2a;">[]</span>
            <span style="color: #a52a2a;">[</span> a <span style="color: #a52a2a;">[</span>href <span style="color: #008000;">"https://github.com/quernd/tea-chess"</span><span style="color: #a52a2a;">]</span>
                <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"Code"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_nav_view</span><span style="color: #BA36A5;"> _model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_nav_item</span><span style="color: #BA36A5;"> current link label</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> current <span style="color: #0000FF;">then</span> class' <span style="color: #008000;">"current"</span> <span style="color: #0000FF;">else</span> noProp <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> current <span style="color: #0000FF;">then</span> text label <span style="color: #0000FF;">else</span> a <span style="color: #a52a2a;">[</span>href link<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text label<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  nav <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"top tabbed"</span><span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span>
        <span style="color: #a52a2a;">[</span> game_nav_item <span style="color: #D0372D;">true</span> <span style="color: #008000;">"#/game"</span> <span style="color: #008000;">"Game"</span>
        <span style="color: #a52a2a;">;</span> game_nav_item <span style="color: #D0372D;">false</span> <span style="color: #008000;">"#/tournament"</span> <span style="color: #008000;">"Tournament"</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">view</span><span style="color: #BA36A5;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">game_status</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>game_status model.position <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">interactable</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #0000FF;">match</span> game_status <span style="color: #0000FF;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Board.</span><span style="color: #000000; background-color: #FFFFFF;">Interactable</span> <span style="color: #a52a2a;">(</span>model.position.turn<span style="color: #a52a2a;">,</span> move_list<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Board.</span><span style="color: #000000; background-color: #FFFFFF;">Not_interactable</span>
  <span style="color: #000000; font-weight: bold;">in</span>
  main <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> section <span style="color: #a52a2a;">[</span>id <span style="color: #008000;">"board"</span><span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> header_nav_view
        <span style="color: #a52a2a;">;</span> <span style="color: #6434A3;">Board.</span>view interactable model.position.ar model.board
          <span style="color: #a52a2a;">|&gt;</span> map board_msg
        <span style="color: #a52a2a;">;</span> buttons_view
          <span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">; Board.result_view game_status </span><span style="color: #8D8D84;">*)</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span>id <span style="color: #008000;">"game"</span><span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> game_nav_view model
        <span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"scroll"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>move_list_view model.ply model.moves<span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
I added two navigation elements.  The <code>game_nav_view</code> will be a list
of tabs that will enable the user to switch between games later.  Now
let&rsquo;s add some CSS to style the <code>&lt;nav&gt;</code> tags to look like tabs. 
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff; font-weight: bold;">nav.top </span>{
    <span style="color: #00AA00;">text-align</span>: left;
    <span style="color: #00AA00;">border-bottom</span>: .15em solid #808080;
    <span style="color: #00AA00;">margin-bottom</span>: .5em;
    <span style="color: #00AA00;">overflow-x</span>: scroll;
}

<span style="color: #0000ff; font-weight: bold;">nav ul </span>{
    <span style="color: #00AA00;">margin-bottom</span>: .5em;
    <span style="color: #00AA00;">padding-left</span>: 0;
}

<span style="color: #0000ff; font-weight: bold;">nav ul li </span>{
    <span style="color: #00AA00;">display</span>: inline;
    <span style="color: #00AA00;">padding</span>: .5em 1em .5em 1em;
    <span style="color: #00AA00;">margin-right</span>: .5em;
    <span style="color: #00AA00;">margin-left</span>: .5em;
}

<span style="color: #0000ff; font-weight: bold;">nav.tabbed ul li </span>{
    <span style="color: #00AA00;">border</span>: .15em solid #808080;
    <span style="color: #00AA00;">border-bottom</span>: 0;
    <span style="color: #00AA00;">border-top-right-radius</span>: .5em;
    <span style="color: #00AA00;">border-top-left-radius</span>: .5em;
    <span style="color: #00AA00;">background-color</span>: #f0f0f0;
}

<span style="color: #0000ff; font-weight: bold;">nav.tabbed ul li.current </span>{
    <span style="color: #00AA00;">background-color</span>: #808080;
    <span style="color: #00AA00;">color</span>: white;
}

<span style="color: #0000ff; font-weight: bold;">li.home </span>{
    <span style="color: #00AA00;">font-weight</span>: bold;
}
</pre>
</div>

<p>
To switch between a left/right and top/down layout of board and rest,
we use the flexbox model.  We will have one main flexbox holding two
flex items (the board and the game view).  The game view will expand,
while the board view is fixed in size.  This happens automatically
because of the <code>flex: auto;</code> property of <code>#game</code>, which in turn is a
flexbox holding two elements, the <code>&lt;nav&gt;</code> bar and a scrollable area
that will hold the move list.  The layout switch from left/right to
top/down happens through a media query that changes <code>flex-direction</code>
from <code>row</code> to <code>column</code>
when appropriate.
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff; font-weight: bold;">main </span>{
    <span style="color: #00AA00;">display</span>: flex;
    <span style="color: #00AA00;">height</span>: 100%;
    <span style="color: #00AA00;">flex-direction</span>: row;
}

<span style="color: #0000ff; font-weight: bold;">#board </span>{
    <span style="color: #00AA00;">text-align</span>: center;
}

<span style="color: #0000ff; font-weight: bold;">#game </span>{
    <span style="color: #00AA00;">overflow-y</span>: hidden;
    <span style="color: #00AA00;">flex</span>: auto;
    <span style="color: #00AA00;">display</span>: flex;
    <span style="color: #00AA00;">flex-direction</span>: column;
}

<span style="color: #0000ff; font-weight: bold;">#game &gt; nav </span>{
    <span style="color: #00AA00;">flex</span>: none;
    <span style="color: #00AA00;">overflow-y</span>: auto;
    <span style="color: #00AA00;">white-space</span>: nowrap;
}

<span style="color: #0000ff; font-weight: bold;">.scroll </span>{
    <span style="color: #00AA00;">overflow-y</span>: scroll;
    <span style="color: #00AA00;">flex</span>: auto;
    <span style="color: #00AA00;">padding</span>: .5em;
}

<span style="color: #006FE0;">@media</span> screen and (max-width:648px) and (min-height:480px) {
    <span style="color: #0000ff; font-weight: bold;">main </span>{
        <span style="color: #00AA00;">flex-direction</span>: column;
    }
}
</pre>
</div>

<p>
We also use CSS media queries to scale down the board and all its
elements as the screen gets smaller:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #006FE0;">@media</span> screen and (max-width:832px) {
    <span style="color: #0000ff; font-weight: bold;">cb-square </span>{
        <span style="color: #00AA00;">width</span>: 48px;
        <span style="color: #00AA00;">height</span>: 48px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-board </span>{
        <span style="color: #00AA00;">width</span>: 384px;
        <span style="color: #00AA00;">height</span>: 384px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo </span>{
        <span style="color: #00AA00;">width</span>: 384px;
        <span style="color: #00AA00;">height</span>: 384px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo cb-square </span>{
        <span style="color: #00AA00;">box-shadow</span>: inset 0 0 20px 2.4px #808080;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo cb-square:hover </span>{
        <span style="color: #00AA00;">box-shadow</span>: inset 0 0 38.4px 6.4px #d85000;
    }
}

<span style="color: #006FE0;">@media</span> screen and (max-width:740px) {
    <span style="color: #0000ff; font-weight: bold;">cb-square </span>{
        <span style="color: #00AA00;">width</span>: 36px;
        <span style="color: #00AA00;">height</span>: 36px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-board </span>{
        <span style="color: #00AA00;">width</span>: 288px;
        <span style="color: #00AA00;">height</span>: 288px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo </span>{
        <span style="color: #00AA00;">width</span>: 288px;
        <span style="color: #00AA00;">height</span>: 288px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo cb-square </span>{
        <span style="color: #00AA00;">box-shadow</span>: inset 0 0 15px 1.8px #808080;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo cb-square:hover </span>{
        <span style="color: #00AA00;">box-shadow</span>: inset 0 0 28.8px 4.8px #d85000;
    }
}

<span style="color: #006FE0;">@media</span> screen and (max-height:740px) {
    <span style="color: #0000ff; font-weight: bold;">cb-square </span>{
        <span style="color: #00AA00;">width</span>: 36px;
        <span style="color: #00AA00;">height</span>: 36px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-board </span>{
        <span style="color: #00AA00;">width</span>: 288px;
        <span style="color: #00AA00;">height</span>: 288px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo </span>{
        <span style="color: #00AA00;">width</span>: 288px;
        <span style="color: #00AA00;">height</span>: 288px;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo cb-square </span>{
        <span style="color: #00AA00;">box-shadow</span>: inset 0 0 15px 1.8px #808080;
    }
    <span style="color: #0000ff; font-weight: bold;">cb-promo cb-square:hover </span>{
        <span style="color: #00AA00;">box-shadow</span>: inset 0 0 28.8px 4.8px #d85000;
    }
}
</pre>
</div>

<p>
You should now have a layout that rearranges when the browser window
shrinks and expands, like this:
</p>

<p>
<img class="full" src="responsive.gif" />
</p>
</div>
</div>

<div id="outline-container-org22d83ff" class="outline-2">
<h2 id="org22d83ff">Making AJAX requests</h2>
<div class="outline-text-2" id="text-org22d83ff">
<p>
Let&rsquo;s get some AJAX action going by making a GET request to an API.
The awesome <a href="https://lichess.org/">Lichess online chess server</a> exposes <a href="https://github.com/ornicar/lila">a public API</a> for all
sorts of requests.  For instance, we can get a JSON record for the
<a href="https://lichess.org/blog/WjRTPScAAJXo7r5s/magnus-carlsen-wins-the-first-lichess-titled-arena">titled player tournament</a> that was hosted recently (won by World
Champion Magnus Carlsen) by accessing
<code>https://lichess.org/api/tournament/GToVqkC9</code>.
</p>

<p>
First, we define some types and messages.  Let&rsquo;s define a variant type
for an HTTP request.  Let&rsquo;s simplify a bit and assume it can have
three states: <code>Loading</code> when the request is sent, and eventually one
of <code>Failed</code> or <code>Received</code> with a payload.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">'a transfer</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> <span style="color: #0000FF;">of</span> 'a

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #6434A3;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #6434A3;">Board.</span>model
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Chess.</span>move <span style="color: #a52a2a;">*</span> string<span style="color: #a52a2a;">)</span> <span style="color: #6434A3;">Zipper.</span>zipper
  <span style="color: #a52a2a;">;</span> ply <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> tournament <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">*</span> string list<span style="color: #a52a2a;">)</span> list transfer
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Board_msg</span> <span style="color: #0000FF;">of</span> <span style="color: #6434A3;">Board.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Back_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Fwd_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Random_move</span> <span style="color: #0000FF;">of</span> <span style="color: #6434A3;">Chess.</span>move
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Key_pressed</span> <span style="color: #0000FF;">of</span> <span style="color: #6434A3;">Keyboard.</span>key_event
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Jump</span> <span style="color: #0000FF;">of</span> int
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament_data</span> <span style="color: #0000FF;">of</span> <span style="color: #a52a2a;">(</span>string<span style="color: #a52a2a;">,</span> string <span style="color: #6434A3;">Http.</span>error<span style="color: #a52a2a;">)</span> <span style="color: #6434A3;">Result.</span>t 
<span style="color: #808080;">[@@bs.deriving {accessors}]</span>
</pre>
</div>

<p>
<code>Tea.Http</code> gives us all we need to send an HTTP request that will come
back with the message <code>Tournament_data</code> which is a <code>Result.t</code>.  We
previously dealt with result types when we decoded JSON events to
implement drag and drop.  Now, we can build an HTTP request and issue
it as our initial command:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">init</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">url</span> <span style="color: #a52a2a;">=</span> <span style="color: #008000;">"https://lichess.org/api/tournament/GToVqkC9"</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">init_cmd</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #6434A3;">Http.</span>getString url <span style="color: #a52a2a;">|&gt;</span> <span style="color: #6434A3;">Http.</span>send tournament_data <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>init_position
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Board.</span>init <span style="color: #a52a2a;">()</span>
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Zipper.</span>init <span style="color: #a52a2a;">()</span>
  <span style="color: #a52a2a;">;</span> ply <span style="color: #a52a2a;">=</span> 0
  <span style="color: #a52a2a;">;</span> tournament <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span>
  <span style="color: #a52a2a;">},</span> init_cmd
</pre>
</div>

<p>
In the <code>update</code> function, we update the model according to the result
that came in.  When the request failed, we set <code>tournament</code> to
<code>Failed</code> (and log the error to the Developer console), but if it succeeded, we need to decode the JSON payload.  If
you take a look at the <a href="https://github.com/ornicar/lila">Lichess API docs</a>, you will see that in order to
get a list of games, we need to extract the field <code>pairings</code> which is
a list of records whose fields <code>id</code> (a string) and <code>u</code> (the list of
players) are interesting.  Hence, we build up our decoder from the
usual building blocks as follows:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament_data</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Result.</span><span style="color: #000000; background-color: #FFFFFF;">Error</span> e<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Js.</span>log e<span style="color: #a52a2a;">;</span>
  <span style="color: #a52a2a;">{</span>model <span style="color: #0000FF;">with</span> tournament <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span><span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>none
<span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament_data</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Result.</span><span style="color: #000000; background-color: #FFFFFF;">Ok</span> data<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #6434A3;">Json.Decoder</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">players_decoder</span> <span style="color: #a52a2a;">=</span> list string <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pairing_decoder</span> <span style="color: #a52a2a;">=</span> map2 <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">x y</span> <span style="color: #a52a2a;">-&gt;</span> x<span style="color: #a52a2a;">,</span> y<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">(</span>field <span style="color: #008000;">"id"</span> string<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">(</span>field <span style="color: #008000;">"u"</span> players_decoder<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">list_decoder</span> <span style="color: #a52a2a;">=</span> list pairing_decoder <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pairings_decoder</span> <span style="color: #a52a2a;">=</span> field <span style="color: #008000;">"pairings"</span> list_decoder <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span>model <span style="color: #0000FF;">with</span>
   tournament <span style="color: #a52a2a;">=</span> <span style="color: #0000FF;">match</span> decodeString pairings_decoder data <span style="color: #0000FF;">with</span>
     <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Ok</span> tournament <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> tournament
     <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Error</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span>
  <span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>none
</pre>
</div>

<p>
Let&rsquo;s do something useful with the tournament info: we will display
the list of games in a table in the &ldquo;Tournament&rdquo; tab.  Here&rsquo;s a simple
tournament view:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">tournament_view</span><span style="color: #BA36A5;"> tournament</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #0000FF;">match</span> tournament <span style="color: #0000FF;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">"Loading tournament..."</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> tournament' <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #6434A3;">List.</span>map
      <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #BA36A5;">id</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> players</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
         td <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> a <span style="color: #a52a2a;">[</span>href <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Printf.</span>sprintf <span style="color: #008000;">"#/pgn/%s"</span> id<span style="color: #a52a2a;">)]</span> <span style="color: #a52a2a;">[</span>text id<span style="color: #a52a2a;">]]::</span>
         <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">player</span> <span style="color: #a52a2a;">-&gt;</span> td <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span>text player<span style="color: #a52a2a;">])</span> players<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> tr <span style="color: #a52a2a;">[])</span>
      tournament'
    <span style="color: #a52a2a;">|&gt;</span> table <span style="color: #a52a2a;">[]</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">"Tournament could not be loaded."</span>
</pre>
</div>

<p>
Notice how we&rsquo;re already preparing links to open the individual games
with client-side routing (also called <i>hash routing</i>).  To make the
table look nice, add this to <code>release/css/main.css</code>:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff; font-weight: bold;">table tr:nth-of-type(even) </span>{
    <span style="color: #00AA00;">background-color</span>: #f0f0f0;
}
</pre>
</div>

<p>
Now make sure the tournament view is showing instead of the move list:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"scroll"</span><span style="color: #a52a2a;">]</span> <span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">[move_list_view model.ply model.moves] </span><span style="color: #8D8D84;">*)</span>
    <span style="color: #a52a2a;">[</span>tournament_view model.tournament<span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
You should now see a list of games, maybe after a short &ldquo;Loading&#x2026;&rdquo;
status info.
</p>
</div>
</div>

<div id="outline-container-org0f98fdc" class="outline-2">
<h2 id="org0f98fdc">Client-side routing</h2>
<div class="outline-text-2" id="text-org0f98fdc">
<p>
The tournament view is nice, but we need a way to switch between the
move list view and the tournament view, and also between games if we
load games from the server.  We keep track of the current view by a
<code>view</code> field in the <code>model</code> record.  The current view is also
represented in the URL, so that it can be bookmarked or shared.  Also,
the browser&rsquo;s history buttons can be used.  For this, we use the
portion of the URL after the hash (#) symbol.  Remember that the hash
symbol is used for page-internal links and will thus not cause a
refresh, but we can still listen to updates in the URL and update the
model accordingly. In fact, we will trigger actions that
change the view through links to a URL instead of sending a message.
</p>

<p>
Let&rsquo;s add a <code>view</code> field to our model:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">view</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #6434A3;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #6434A3;">Board.</span>model
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Chess.</span>move <span style="color: #a52a2a;">*</span> string<span style="color: #a52a2a;">)</span> <span style="color: #6434A3;">Zipper.</span>zipper
  <span style="color: #a52a2a;">;</span> ply <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> tournament <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">*</span> string list<span style="color: #a52a2a;">)</span> list transfer
  <span style="color: #a52a2a;">;</span> view <span style="color: #a52a2a;">:</span> view
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
We now change the type of our program to
<code>Navigation.navigationProgram</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">main</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #6434A3;">Navigation.</span>navigationProgram location_change
    <span style="color: #a52a2a;">{</span> init
    <span style="color: #a52a2a;">;</span> update
    <span style="color: #a52a2a;">;</span> view
    <span style="color: #a52a2a;">;</span> subscriptions
    <span style="color: #a52a2a;">;</span> shutdown <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">_</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Cmd.</span>none<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
Whenever the URL is updated, the message <code>Location_change</code> is sent:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Location_change</span> <span style="color: #0000FF;">of</span> <span style="color: #6434A3;">Web.Location.</span>location
</pre>
</div>

<p>
The type of <code>init</code> also changed.  It takes an additional argument
which is the initial URL.  We use the function <code>view_of_location</code> to
pick the right view in case the user navigates to a special URL
directly.  Note the use of <code>Cmd.batch</code> to issue more than one
command at once.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">view_of_location</span><span style="color: #BA36A5;"> location</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #6434A3;">Web.Location</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #0000FF;">match</span> location.hash <span style="color: #0000FF;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #008000;">"#/game"</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: #008000;">"#/tournament"</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Navigation.</span>modifyUrl <span style="color: #008000;">"#/game"</span>  <span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">default route </span><span style="color: #8D8D84;">*)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">init</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">()</span><span style="color: #BA36A5;"> location</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">view</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> cmd</span> <span style="color: #a52a2a;">=</span> view_of_location location <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">url</span> <span style="color: #a52a2a;">=</span> <span style="color: #008000;">"https://lichess.org/api/tournament/GToVqkC9"</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">init_cmd</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #6434A3;">Http.</span>getString url <span style="color: #a52a2a;">|&gt;</span> <span style="color: #6434A3;">Http.</span>send tournament_data <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>init_position
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Board.</span>init <span style="color: #a52a2a;">()</span>
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Zipper.</span>init <span style="color: #a52a2a;">()</span>
  <span style="color: #a52a2a;">;</span> ply <span style="color: #a52a2a;">=</span> 0
  <span style="color: #a52a2a;">;</span> tournament <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span>
  <span style="color: #a52a2a;">;</span> view
  <span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>batch <span style="color: #a52a2a;">[</span>init_cmd<span style="color: #a52a2a;">;</span> cmd<span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
We handle the <code>Location_change</code> message in the <code>update</code>
function:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Location_change</span> location <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">view</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> cmd</span> <span style="color: #a52a2a;">=</span> view_of_location location <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span>model <span style="color: #0000FF;">with</span> view<span style="color: #a52a2a;">},</span> cmd
</pre>
</div>

<p>
We also have to choose the right view in our main <code>view</code> function,
and we style the tabs to highlight the active tab:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_nav_view</span><span style="color: #BA36A5;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_nav_item</span><span style="color: #BA36A5;"> current link label</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> current <span style="color: #0000FF;">then</span> class' <span style="color: #008000;">"current"</span> <span style="color: #0000FF;">else</span> noProp <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> current <span style="color: #0000FF;">then</span> text label <span style="color: #0000FF;">else</span> a <span style="color: #a52a2a;">[</span>href link<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text label<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  nav <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"top tabbed"</span><span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span>
        <span style="color: #a52a2a;">[</span> game_nav_item <span style="color: #a52a2a;">(</span>model.view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span><span style="color: #a52a2a;">)</span> <span style="color: #008000;">"#/game"</span> <span style="color: #008000;">"Game"</span>
        <span style="color: #a52a2a;">;</span> game_nav_item <span style="color: #a52a2a;">(</span>model.view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span><span style="color: #a52a2a;">)</span> <span style="color: #008000;">"#/tournament"</span> <span style="color: #008000;">"Tournament"</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">view</span><span style="color: #BA36A5;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">game_status</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>game_status model.position <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">interactable</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #0000FF;">match</span> game_status <span style="color: #0000FF;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Board.</span><span style="color: #000000; background-color: #FFFFFF;">Interactable</span> <span style="color: #a52a2a;">(</span>model.position.turn<span style="color: #a52a2a;">,</span> move_list<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Board.</span><span style="color: #000000; background-color: #FFFFFF;">Not_interactable</span>
  <span style="color: #000000; font-weight: bold;">in</span>
  main <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> section <span style="color: #a52a2a;">[</span>id <span style="color: #008000;">"board"</span><span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> header_nav_view
        <span style="color: #a52a2a;">;</span> <span style="color: #6434A3;">Board.</span>view interactable model.position.ar model.board
          <span style="color: #a52a2a;">|&gt;</span> map board_msg
        <span style="color: #a52a2a;">;</span> buttons_view
          <span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">; Board.result_view game_status </span><span style="color: #8D8D84;">*)</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span>id <span style="color: #008000;">"game"</span><span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> game_nav_view model
        <span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"scroll"</span><span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">match</span> model.view <span style="color: #0000FF;">with</span>
              <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span> <span style="color: #a52a2a;">-&gt;</span> move_list_view model.ply model.moves
              <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span> <span style="color: #a52a2a;">-&gt;</span> tournament_view model.tournament
            <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
You can now switch between the &ldquo;Game&rdquo; and &ldquo;Tournament&rdquo; tabs, and you
will also be able to go directly to a specific view by typing its URL.
Any URL that doesn&rsquo;t match a known route will be replaced by the
default &ldquo;Game&rdquo; view.
</p>
</div>
</div>

<div id="outline-container-orgb42952e" class="outline-2">
<h2 id="orgb42952e">A tabbed list of game views</h2>
<div class="outline-text-2" id="text-orgb42952e">
<p>
Let&rsquo;s load a game into a new tab when we click the game ID in the
tournament view.  First, we define a new view and some new messages:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">view</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> <span style="color: #0000FF;">of</span> string

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">model</span> <span style="color: #a52a2a;">=</span>
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">... </span><span style="color: #8D8D84;">*)</span>
  <span style="color: #a52a2a;">;</span> pgn <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">*</span> string transfer<span style="color: #a52a2a;">)</span> list <span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">association list </span><span style="color: #8D8D84;">*)</span>
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">... </span><span style="color: #8D8D84;">*)</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #6434A3;">msg</span> <span style="color: #a52a2a;">=</span>  
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">... </span><span style="color: #8D8D84;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn_requested</span> <span style="color: #0000FF;">of</span> string
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn_data</span> <span style="color: #0000FF;">of</span> string <span style="color: #a52a2a;">*</span> <span style="color: #a52a2a;">(</span>string<span style="color: #a52a2a;">,</span> string <span style="color: #6434A3;">Http.</span>error<span style="color: #a52a2a;">)</span> <span style="color: #6434A3;">Result.</span>t
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Close_tab</span> <span style="color: #0000FF;">of</span> string
<span style="color: #808080;">[@@bs.deriving {accessors}]</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">view_of_location</span><span style="color: #BA36A5;"> location</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #6434A3;">Web.Location</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">route</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>split_on_char <span style="color: #008000;">'/'</span> location.hash <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #0000FF;">match</span> route <span style="color: #0000FF;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[</span><span style="color: #008000;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">"game"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[</span><span style="color: #008000;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">"tournament"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[</span><span style="color: #008000;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">"pgn"</span><span style="color: #a52a2a;">;</span> id<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">-&gt;</span>  <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> id<span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Pgn_requested</span> id<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Navigation.</span>modifyUrl <span style="color: #008000;">"#/game"</span>  <span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">default route </span><span style="color: #8D8D84;">*)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">init</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">()</span><span style="color: #BA36A5;"> location</span> <span style="color: #a52a2a;">=</span>
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">... </span><span style="color: #8D8D84;">*)</span>
  <span style="color: #a52a2a;">;</span> pgn <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[]</span>
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">... </span><span style="color: #8D8D84;">*)</span>
</pre>
</div>

<p>
We use the <code>split_on_char</code> function that we added to O&rsquo;Chess (maybe we
should move it to a different module?!) to match
routes in a more systematic fashion.
</p>

<p>
We will keep track of the games in the <code>pgn</code> field of the <code>model</code>
record (PGN stands for <a href="https://en.wikipedia.org/wiki/Portable_Game_Notation"><i>Portable Game Notation</i></a>) by using an
<i>association list</i>, or a key-value list, where the keys are game IDs
and the values are of type <code>string transfer</code>.  Let&rsquo;s write the handler
for the <code>Pgn_requested</code> message that is received when the user clicks
a game link:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn_requested</span> id <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #0000FF;">if</span> <span style="color: #6434A3;">List.</span>mem_assoc id model.pgn
  <span style="color: #0000FF;">then</span> model<span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>none
  <span style="color: #0000FF;">else</span> 
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">url</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #6434A3;">Printf.</span>sprintf <span style="color: #008000;">"https://lichess.org/game/export/%s.pgn"</span> id <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Http.</span>getString url <span style="color: #a52a2a;">|&gt;</span> <span style="color: #6434A3;">Http.</span>send <span style="color: #a52a2a;">(</span>pgn_data id<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #0000FF;">with</span>
      view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> id
    <span style="color: #a52a2a;">;</span> pgn <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span><span style="color: #a52a2a;">)::</span>model.pgn
    <span style="color: #a52a2a;">},</span> cmd
</pre>
</div>

<p>
When the game ID is already found in the association list, no action
is performed, but when it isn&rsquo;t, an HTTP request is issued and the
game is added to the list with status <code>Loading</code>.  The other messages
are handled as follows:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn_data</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Result.</span><span style="color: #000000; background-color: #FFFFFF;">Error</span> _e<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #a52a2a;">{</span> model <span style="color: #0000FF;">with</span>
    pgn <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span><span style="color: #a52a2a;">)::</span><span style="color: #6434A3;">List.</span>remove_assoc id model.pgn
  <span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>none
<span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn_data</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Result.</span><span style="color: #000000; background-color: #FFFFFF;">Ok</span> data<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #a52a2a;">{</span> model <span style="color: #0000FF;">with</span>
    pgn <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> data<span style="color: #a52a2a;">)::</span><span style="color: #6434A3;">List.</span>remove_assoc id model.pgn
  <span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>none
<span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Close_tab</span> id <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">List.</span>remove_assoc id model.pgn <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">view</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #0000FF;">match</span> pgn <span style="color: #0000FF;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)::</span>_ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> id
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span>
  <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span>model <span style="color: #0000FF;">with</span> pgn<span style="color: #a52a2a;">;</span> view<span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>none
</pre>
</div>

<p>
Finally, we add a PGN view and a list of tabs to switch between views.
We need to handle the case of the ID not yet being found in the list
because there is a short moment in time when the view has already
been set to <code>Pgn id</code>, but the HTTP request hasn&rsquo;t yet been sent out.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">pgn_view</span><span style="color: #BA36A5;"> id pgn</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #0000FF;">try</span> <span style="color: #0000FF;">match</span> <span style="color: #6434A3;">List.</span>assoc id pgn <span style="color: #0000FF;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">"Loading PGN game..."</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> pgn' <span style="color: #a52a2a;">-&gt;</span> 
      pre <span style="color: #a52a2a;">[</span>style <span style="color: #008000;">"white-space"</span> <span style="color: #008000;">"pre-wrap"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text pgn'<span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">"Game could not be loaded."</span>             
  <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">""</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_nav_view</span><span style="color: #BA36A5;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">pgn_nav_item</span><span style="color: #BA36A5;"> id</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> model.view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> id <span style="color: #0000FF;">then</span> class' <span style="color: #008000;">"current"</span> <span style="color: #0000FF;">else</span> noProp <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> model.view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> id
        <span style="color: #0000FF;">then</span> text id
        <span style="color: #0000FF;">else</span> a <span style="color: #a52a2a;">[</span>href <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Printf.</span>sprintf <span style="color: #008000;">"#/pgn/%s"</span> id<span style="color: #a52a2a;">)]</span> <span style="color: #a52a2a;">[</span>text id<span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">" "</span><span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[</span> style <span style="color: #008000;">"cursor"</span> <span style="color: #008000;">"pointer"</span>
             <span style="color: #a52a2a;">;</span> onClick <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Close_tab</span> id<span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text <span style="color: #008000;">"(x)"</span><span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_nav_item</span><span style="color: #BA36A5;"> current link label</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> current <span style="color: #0000FF;">then</span> class' <span style="color: #008000;">"current"</span> <span style="color: #0000FF;">else</span> noProp <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> <span style="color: #0000FF;">if</span> current <span style="color: #0000FF;">then</span> text label <span style="color: #0000FF;">else</span> a <span style="color: #a52a2a;">[</span>href link<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text label<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  nav <span style="color: #a52a2a;">[</span>class' <span style="color: #008000;">"top tabbed"</span><span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span>
        <span style="color: #a52a2a;">([</span> game_nav_item <span style="color: #a52a2a;">(</span>model.view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Game</span><span style="color: #a52a2a;">)</span> <span style="color: #008000;">"#/game"</span> <span style="color: #008000;">"Game"</span>
         <span style="color: #a52a2a;">;</span> game_nav_item <span style="color: #a52a2a;">(</span>model.view <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Tournament</span><span style="color: #a52a2a;">)</span> <span style="color: #008000;">"#/tournament"</span> <span style="color: #008000;">"Tournament"</span>
         <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">@</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">List.</span>rev_map <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #BA36A5;">id</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> _</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> pgn_nav_item id<span style="color: #a52a2a;">)</span> model.pgn<span style="color: #a52a2a;">))</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Don&rsquo;t forget to complete the <code>match</code> in the main <code>view</code> by adding a
case:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn</span> id <span style="color: #a52a2a;">-&gt;</span> pgn_view id model.pgn
</pre>
</div>

<p>
Head to your browser and click a game&#x2026; and be disappointed: &ldquo;Game
could not be loaded.&rdquo;  Check the developer tools and see this error:
</p>

<pre class="example">
Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at https://lichess.org/game/export/PyzfyNUx.pgn. (Reason: CORS header Access-Control-Allow-Origin missing).
</pre>

<p>
This part of the Lichess API is not configured to be accessed this way in order to
prevent cross-site scripting security problems. There is a
way around it (called JSONP), but it&rsquo;s painful.  I have an easier
solution for the purpose of this tutorial: let&rsquo;s use a proxy server!
</p>

<p>
I recommend grabbing a copy of the <a href="https://github.com/Freeboard/thingproxy">Thingproxy</a> server and running it on
your own computer.  You can also learn more about the underlying
problem on their website. Since you already have Node.js and NPM or Yarn
installed, it&rsquo;s a matter of 1-2-3:
</p>

<pre class="example">
git clone https://github.com/Freeboard/thingproxy
cd thingproxy
node server.js
</pre>

<p>
And the Thingproxy server is running on <code>http://localhost:3000</code>.  Just
prefix any URL with <code>http://localhost:3000/fetch/</code> and you&rsquo;re good to
go. If you don&rsquo;t have the patience, you can use a hosted proxy server
at <code>https://thingproxy.freeboard.io/fetch/</code>.  I put the following in
my <code>src/Main.ml</code>, and everything worked like a charm.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">proxy</span> <span style="color: #a52a2a;">=</span> <span style="color: #008000;">"http://localhost:3000/fetch/"</span>
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">... </span><span style="color: #8D8D84;">*)</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">url</span> <span style="color: #a52a2a;">=</span>
        <span style="color: #6434A3;">Printf.</span>sprintf <span style="color: #008000;">"%shttps://lichess.org/game/export/%s.pgn"</span> proxy id <span style="color: #000000; font-weight: bold;">in</span>

</pre>
</div>

<p>
Open lots of games, see them show up in tabs. If you open many tabs,
the tab bar will be scrollable but it won&rsquo;t expand or wrap because of this CSS:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff; font-weight: bold;">#game &gt; nav </span>{
    <span style="color: #00AA00;">flex</span>: none;
    <span style="color: #00AA00;">overflow-y</span>: auto;
    <span style="color: #00AA00;">white-space</span>: nowrap;
}
</pre>
</div>

<p>
That&rsquo;s it for today.  <a href="../day9/index.html">Tomorrow, we will learn how to parse the PGN
format so that we can actually play through the games on the board
instead of just seeing the game notation.</a>  We will use a very
functional way, namely parser combinators.  Today&rsquo;s code is tag <code>day8</code>.
</p>
</div>
</div>
</div>
</body>
</html>
