<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-12-11 Tue 12:07 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Twelve Days of Christmas #9</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Daniel Quernheim">
<link rel='stylesheet' href='/style.css' type='text/css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><div id="preamble" class="status">
<div id='nav'><a href="/">home</a></div>
</div>
<div id="content">
<h1 class="title">Twelve Days of Christmas #9</h1>
<div class="warning">
<p>
This was the first version of this tutorial.  Please visit the <a href="../index.html">new
version</a> instead.
</p>

</div>

<p>
This is the nineth part of <a href="../index-old.html">a chess-themed tutorial</a> on writing an SPA in
<a href="https://github.com/OvermindDL1/bucklescript-tea">Bucklescript-TEA</a>.  After this part, your app will look similar to <a href="demo.html">this demo</a>.
</p>

<p>
 Today, we will use parser
combinators to be able to read the most widespread format for storing
chess games, the PGN format.  Start from tag <code>day8</code> if you are following along with my
repository.
</p>

<div id="outline-container-orgb93ef88" class="outline-2">
<h2 id="orgb93ef88">What is a parser combinator?</h2>
<div class="outline-text-2" id="text-orgb93ef88">
<p>
Every once in a while you have to deal with string data instead of
JSON data.  A <i>parser</i> processes a string and analyzes it in order build a data
structure such as an OCaml record, according to a set of rules.  There
are two widespread approaches to writing parsers:  A <i>parser
generator</i> takes as its input a formal grammar written in a certain
format, and returns the actual parser function.  Thus, the generator
needs to be run every time the grammar is changed, but the generated
parser is a standalone function.
</p>

<p>
<i>Parser combinators</i> on the other hand are a convenient way of
building parsers on the fly from
smaller units without having to specify the grammar in a different
language, much like the way we built JSON decoders from building
blocks.  In this part of the tutorial, we will build a parser
using parser combinators for the textual representation of chess games called PGN.
</p>

<p>
We will use a small self-contained parser combinator library and only
touch very lightly on technical matters.
If you&rsquo;re interested in learning more about parser combinators and
maybe even writing your own parser combinator library, you
should check out <a href="https://fsharpforfunandprofit.com/posts/understanding-parser-combinators/">Scott Wlaschin&rsquo;s &ldquo;Understanding Parser Combinators&rdquo;
series</a>.  It&rsquo;s aimed at F#, but F# and OCaml share a lot of similarities.
</p>

<p>
Essentially, a parser combinator is a function that takes parsers as
its arguments and returns a new parser.  A parser, on the other hand,
is a function that takes a string as its argument and returns
something else.  Compare that to what you learned about JSON decoders
earlier.  The combinators that we used there were <code>list</code>, <code>field</code>,
<code>map2</code> etc. 
</p>

<p>
I chose to use an MIT-licenced <a href="https://github.com/pyrocat101/opal">small self-contained
implementation of parser combinators called Opal</a>.  Just drop <code>opal.ml</code>
into your <code>src</code> directory.  To get you acquainted with parser
combinators, let&rsquo;s explore them in an interactive way in the OCaml
toplevel (the read-eval-print loop).  Open a terminal and type <code>ocaml</code>, or better yet, <code>utop</code>.  <a href="https://github.com/diml/utop">Utop</a> offers readline support and
tab-completion, and is more colorful :-)  You can install it through
OPAM with <code>opam install utop</code>.
</p>

<p>
Utop will greet you with a prompt like <code>utop #</code>.  Let&rsquo;s load
<code>src/opal.ml</code>.  Note that you have to end a statement with <code>;;</code> in Utop.
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #a52a2a;">#</span>use <span style="color: #008000;">"src/opal.ml"</span><span style="color: #ff4500;">;;</span>
</pre>
</div>

<p>
You&rsquo;ll see the <i>signature</i> of Opal, listing all the types and
functions that it exposes.
</p>

<p>
Are you ready to write your first parser? There it is:
</p>
<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_capture</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #008000;">'x'</span><span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #006699;">capture</span> <span style="color: #a52a2a;">:</span> char input <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #0000FF;">fun</span><span style="color: #a52a2a;">&gt;</span>
</pre>
</div>

<p>
OCaml tells you that <code>capture</code> is a function that takes a <code>char input</code>
and either returns <code>None</code> (if the parser failed) or <code>Some</code> pair of
<code>char</code> (the result of applying the parser to the input) and
another <code>char input</code> (the remaining input).  Building a parser using
parser combinators is all about making the parsers work together so
that each parser feeds the remaining input into the next parser.
</p>

<p>
Let&rsquo;s try out our parser. We can convert a string into type <code>input</code> by
using <code>LazyStream.of_string</code>:
</p>
<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #6434A3;">LazyStream.</span>of_string<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> bytes <span style="color: #a52a2a;">-&gt;</span> char input <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #0000FF;">fun</span><span style="color: #a52a2a;">&gt;</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #6434A3;">LazyStream.</span>of_string <span style="color: #008000;">"x"</span> <span style="color: #a52a2a;">|&gt;</span> pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #008000;">'x'</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">LazyStream.</span><span style="color: #000000; background-color: #FFFFFF;">Nil</span><span style="color: #a52a2a;">)</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #6434A3;">LazyStream.</span>of_string <span style="color: #008000;">"xyz"</span> <span style="color: #a52a2a;">|&gt;</span> pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #008000;">'x'</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">LazyStream.</span><span style="color: #000000; background-color: #FFFFFF;">Cons</span> <span style="color: #a52a2a;">(</span><span style="color: #008000;">'y'</span><span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #0000FF;">lazy</span><span style="color: #a52a2a;">&gt;))</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #6434A3;">LazyStream.</span>of_string <span style="color: #008000;">"yz"</span> <span style="color: #a52a2a;">|&gt;</span> pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> None
</pre>
</div>

<p>
Looks good! Note that the parser also returns the remainder of the
input.  If we are only interested whether parsing succeeded, we can
use the function <code>parse</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #6434A3;">LazyStream.</span>of_string <span style="color: #008000;">"xyz"</span> <span style="color: #a52a2a;">|&gt;</span> parse pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> char option <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #008000;">'x'</span>
</pre>
</div>

<p>
Here are some more simple parsers, defined by the &ldquo;or&rdquo; combinator
<code>&lt;|&gt;</code>, or by spelling out a list of possible
characters to match. 
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_castle</span> <span style="color: #a52a2a;">=</span> token <span style="color: #008000;">"O-O"</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #008000;">"O-O-O"</span><span style="color: #ff4500;">;;</span>
utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_piece</span> <span style="color: #a52a2a;">=</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'K'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'Q'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'R'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'B'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'N'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'P'</span><span style="color: #a52a2a;">]</span><span style="color: #ff4500;">;;</span>
utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_file</span> <span style="color: #a52a2a;">=</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'a'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'b'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'c'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'d'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'e'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'f'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'g'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'h'</span><span style="color: #a52a2a;">]</span><span style="color: #ff4500;">;;</span>
utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_rank</span> <span style="color: #a52a2a;">=</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'1'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'2'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'3'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'4'</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">&lt;|&gt;</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'5'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'6'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'7'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'8'</span><span style="color: #a52a2a;">]</span><span style="color: #ff4500;">;;</span>
</pre>
</div>

<p>
The last one is slightly redundant but very instructive: it uses the <code>&lt;|&gt;</code> combinator (&ldquo;or&rdquo;) to say that the parser
matches either one of the alternatives.  Check the source code of Opal
to see how it works:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a52a2a;">(&lt;|&gt;)</span> x y <span style="color: #a52a2a;">=</span>
  <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">input</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #0000FF;">match</span> x input <span style="color: #0000FF;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> _ <span style="color: #0000FF;">as</span> ret <span style="color: #a52a2a;">-&gt;</span> ret
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">None</span> <span style="color: #a52a2a;">-&gt;</span> y input
</pre>
</div>

<p>
Pretty straightforward, right? If the first parser matches, we return
the result, if it doesn&rsquo;t, we hand off the input to the second parser.
Now let&rsquo;s see if we can combine some parsers to match a move.
How do we put one parser after the other?  Here&rsquo;s a bit of
black magic:
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_square</span> <span style="color: #a52a2a;">=</span> pgn_file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">file</span> <span style="color: #a52a2a;">-&gt;</span> 
                        pgn_rank <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">rank</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span><span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #006699;">pgn_square</span> <span style="color: #a52a2a;">:</span> char input <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">((</span>char <span style="color: #a52a2a;">*</span> char<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #0000FF;">fun</span><span style="color: #a52a2a;">&gt;</span>
</pre>
</div>

<p>
Whoah! What&rsquo;s going on there?  Let&rsquo;s see.  If you peek at the source
code of Opal, you&rsquo;ll see that the operator <code>&gt;&gt;=</code> takes a parser (<code>pgn_file</code>) and a function (<code>fun file -&gt;
...</code>).  It will return a new parser that applies <code>pgn_file</code> first and
if it succeeds, hands off the result and the remaining input to the
function.  But wait, <code>fun file -&gt; ...</code> only takes one argument?!
That&rsquo;s because it&rsquo;s <i>partially applied</i>.  It takes one argument now
and the other argument later.  Remember that the second argument is
the remaining input, so it will be a function still looking for
remaining input, hence â€“ a parser!
</p>

<p>
However, it doesn&rsquo;t stop here.  Our anonymous function runs runs
<code>pgn_rank</code> on the remaining input, and again hands off the result and
the remaining input to another anonymous function.  At some point this
madness has to stop:  the function <code>return</code> takes two arguments.  The
first is supplied by the pair <code>(file, rank)</code>.  The second is the
remaining input that we&rsquo;re still carrying around.  
</p>

<p>
Does it work? Yes it does!
</p>
<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #6434A3;">LazyStream.</span>of_string <span style="color: #008000;">"e4"</span> <span style="color: #a52a2a;">|&gt;</span> parse pgn_square <span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #008000;">'e'</span><span style="color: #a52a2a;">,</span> <span style="color: #008000;">'4'</span><span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
The combination of
<code>&gt;&gt;=</code> (called <i>bind</i>) and <code>return</code> is extremely powerful!  With <code>&gt;&gt;=</code>,
you run parsers sequentially, and with <code>return</code>, you can specify the
format of the return value.   If all of this went a little too fast
for you, check out <a href="https://fsharpforfunandprofit.com/posts/understanding-parser-combinators/">Scott Wlaschin&rsquo;s excellent tutorial on parser combinators</a>.
</p>

<p>
(Exercise:  Implement a parser combinator that takes two parsers
<code>p1</code> and <code>p2</code> and
returns a parser that ignores the result of
the <code>p1</code>, returning only the result of <code>p2</code>.)
</p>
</div>
</div>

<div id="outline-container-org21cb1ff" class="outline-2">
<h2 id="org21cb1ff">The PGN format</h2>
<div class="outline-text-2" id="text-org21cb1ff">
<p>
After this warmup, let&rsquo;s jump right in and start writing a parser for the <a href="https://www.chessclub.com/user/help/PGN-spec">PGN format</a>.
Here&rsquo;s a sample game in PGN from the specification:
</p>

<pre class="example">
[Event "F/S Return Match"]
[Site "Belgrade, Serbia JUG"]
[Date "1992.11.04"]
[Round "29"]
[White "Fischer, Robert J."]
[Black "Spassky, Boris V."]
[Result "1/2-1/2"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 {This opening is called the Ruy Lopez.}
4. Ba4 Nf6 5. O-O Be7 6. Re1 b5 7. Bb3 d6 8. c3 O-O 9. h3 Nb8 10. d4 Nbd7
11. c4 c6 12. cxb5 axb5 13. Nc3 Bb7 14. Bg5 b4 15. Nb1 h6 16. Bh4 c5 17. dxe5
Nxe4 18. Bxe7 Qxe7 19. exd6 Qf6 20. Nbd2 Nxd6 21. Nc4 Nxc4 22. Bxc4 Nb6
23. Ne5 Rae8 24. Bxf7+ Rxf7 25. Nxf7 Rxe1+ 26. Qxe1 Kxf7 27. Qe3 Qg5 28. Qxg5
hxg5 29. b3 Ke6 30. a3 Kd6 31. axb4 cxb4 32. Ra5 Nd5 33. f3 Bc8 34. Kf2 Bf5
35. Ra7 g6 36. Ra6+ Kc5 37. Ke1 Nf4 38. g3 Nxh3 39. Kd2 Kb5 40. Rd6 Kc5 41. Ra6
Nf2 42. g4 Bd3 43. Re6 1/2-1/2
</pre>

<p>
As you can see, the moves are in SAN format which we already know,
followed by a result that&rsquo;s either <code>1/2-1/2</code>, <code>1-0</code>, <code>0-1</code> or <code>*</code>
(unfinished game).
The header of the file is a list of key-value pairs of metadata.
Comments can be inserted after a move enclosed in curly braces.  Let&rsquo;s
call the set of features seen in this example &ldquo;Simple PGN&rdquo;.
</p>

<p>
There are a few more things you can find in a PGN file, though.
Strings can contain quotation marks escaped with <code>\</code>, PGN
may contain variations (move sequences that were not
played, but are included for analysis), and variations can contain
comments and they can even be nested.  Some header items can carry
special meaning (for instance, if the game starts from a specified position).
</p>
</div>
</div>

<div id="outline-container-org9c141fa" class="outline-2">
<h2 id="org9c141fa">Simple parsers</h2>
<div class="outline-text-2" id="text-org9c141fa">
<p>
Start a new file <code>src/Pgn.ml</code> with
the following:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #6434A3;">Opal</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #6434A3;">Opal</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">maybe</span><span style="color: #BA36A5;"> p</span> <span style="color: #a52a2a;">=</span> option <span style="color: #000000; background-color: #FFFFFF;">None</span> <span style="color: #a52a2a;">(</span>p <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">x</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Some</span> x<span style="color: #a52a2a;">))</span>

<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">open </span><span style="color: #6434A3;">Opal</span>
</pre>
</div>

<p>
We define a <code>maybe</code> combinator that returns an <code>option</code>.  
</p>

<p>
For the header, the specification
says that a tag pair (or key/value pair) &ldquo;is composed of four consecutive tokens: a left bracket token, a
symbol token, a string token, and a right bracket token.&rdquo;  A string is
(slightly simplified) anything between a pair of quotation marks, so we have:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_string</span> <span style="color: #a52a2a;">=</span> none_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'"'</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">|&gt;</span> many
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_tag_key</span> <span style="color: #a52a2a;">=</span> none_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">' '</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">|&gt;</span> many1
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_tag_value</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #008000;">'"'</span> <span style="color: #a52a2a;">&gt;&gt;</span> pgn_string <span style="color: #a52a2a;">&lt;&lt;</span> exactly <span style="color: #008000;">'"'</span>
</pre>
</div>

<p>
And then the pair of key and value is obtained by using <code>implode</code>
(turning a list of characters into a string).
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_tag_key_value</span> <span style="color: #a52a2a;">=</span>
  pgn_tag_key <span style="color: #a52a2a;">&lt;&lt;</span> many1 space <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">tag_key</span> <span style="color: #a52a2a;">-&gt;</span>
  pgn_tag_value <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">tag_value</span> <span style="color: #a52a2a;">-&gt;</span>
  return <span style="color: #a52a2a;">(</span>tag_key <span style="color: #a52a2a;">|&gt;</span> implode<span style="color: #a52a2a;">,</span> tag_value <span style="color: #a52a2a;">|&gt;</span> implode<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_tag</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #008000;">'['</span> <span style="color: #a52a2a;">&gt;&gt;</span> pgn_tag_key_value <span style="color: #a52a2a;">&lt;&lt;</span> exactly <span style="color: #008000;">']'</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_header</span> <span style="color: #a52a2a;">=</span> many <span style="color: #a52a2a;">(</span>pgn_tag <span style="color: #a52a2a;">&lt;&lt;</span> newline<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
In order to parse moves, we need some simple parsers:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_piece</span> <span style="color: #a52a2a;">=</span>
  one_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'K'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'Q'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'R'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'B'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'N'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'P'</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">=&gt;</span> <span style="color: #6434A3;">Chess.</span>piece_type_of_char

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_file</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">files</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span><span style="color: #008000;">'a'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'b'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'c'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'d'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'e'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'f'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'g'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'h'</span><span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #6434A3;">List.</span>mapi <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">i file</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>exactly file <span style="color: #a52a2a;">&gt;&gt;</span> return i<span style="color: #a52a2a;">))</span> files <span style="color: #a52a2a;">|&gt;</span> choice

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_rank</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">ranks</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span><span style="color: #008000;">'1'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'2'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'3'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'4'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'5'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'6'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'7'</span><span style="color: #a52a2a;">;</span> <span style="color: #008000;">'8'</span><span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #6434A3;">List.</span>mapi <span style="color: #a52a2a;">(</span><span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">i file</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>exactly file <span style="color: #a52a2a;">&gt;&gt;</span> return i<span style="color: #a52a2a;">))</span> ranks <span style="color: #a52a2a;">|&gt;</span> choice

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_square</span> <span style="color: #a52a2a;">=</span>
  pgn_file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">file</span> <span style="color: #a52a2a;">-&gt;</span> 
  pgn_rank <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">rank</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_capture</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #008000;">'x'</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_check</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #008000;">'+'</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_checkmate</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #008000;">'#'</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_promotion</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>maybe <span style="color: #a52a2a;">(</span>exactly <span style="color: #008000;">'='</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&gt;&gt;</span> pgn_piece
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_nag</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>exactly <span style="color: #008000;">'$'</span> <span style="color: #a52a2a;">&gt;&gt;</span> <span style="color: #a52a2a;">(</span>many1 digit <span style="color: #a52a2a;">=&gt;</span> implode<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
              <span style="color: #a52a2a;">(</span>many1 <span style="color: #a52a2a;">(</span>one_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'!'</span><span style="color: #a52a2a;">;</span><span style="color: #008000;">'?'</span><span style="color: #a52a2a;">])</span> <span style="color: #a52a2a;">=&gt;</span> implode<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
As well as some complicated ones:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_castle</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"O-O-O"</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #008000;">"0-0-0"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #000000; background-color: #FFFFFF;">Queenside_castle</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"O-O"</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #008000;">"0-0"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #000000; background-color: #FFFFFF;">Kingside_castle</span><span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_disambiguated_move</span> <span style="color: #a52a2a;">=</span>
  pgn_piece <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">piece</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe pgn_file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">file</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe pgn_rank <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">rank</span> <span style="color: #a52a2a;">-&gt;</span>
  optional pgn_capture <span style="color: #a52a2a;">&gt;&gt;</span>
  pgn_square <span style="color: #a52a2a;">=&gt;</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; background-color: #FFFFFF;">Piece_move</span> <span style="color: #a52a2a;">(</span>piece<span style="color: #a52a2a;">,</span> file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_normal_move</span> <span style="color: #a52a2a;">=</span>
  pgn_piece <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">piece</span> <span style="color: #a52a2a;">-&gt;</span>
  optional pgn_capture <span style="color: #a52a2a;">&gt;&gt;</span>
  pgn_square <span style="color: #a52a2a;">=&gt;</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; background-color: #FFFFFF;">Piece_move</span> <span style="color: #a52a2a;">(</span>piece<span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #FFFFFF;">None</span><span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #FFFFFF;">None</span><span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_pawn_move</span> <span style="color: #a52a2a;">=</span>
  pgn_square <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe pgn_promotion <span style="color: #a52a2a;">=&gt;</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">promotion</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; background-color: #FFFFFF;">Pawn_move</span> <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">None</span><span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">,</span> promotion<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_pawn_capture_move</span> <span style="color: #a52a2a;">=</span>
  maybe pgn_file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">source_file</span> <span style="color: #a52a2a;">-&gt;</span>
  optional pgn_capture <span style="color: #a52a2a;">&gt;&gt;</span>
  pgn_square <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe pgn_promotion <span style="color: #a52a2a;">=&gt;</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">promotion</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; background-color: #FFFFFF;">Pawn_move</span> <span style="color: #a52a2a;">(</span>source_file<span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">,</span> promotion<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_san</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>pgn_castle <span style="color: #a52a2a;">&lt;|&gt;</span>
   pgn_disambiguated_move <span style="color: #a52a2a;">&lt;|&gt;</span>
   pgn_normal_move <span style="color: #a52a2a;">&lt;|&gt;</span>
   pgn_pawn_move <span style="color: #a52a2a;">&lt;|&gt;</span>
   pgn_pawn_capture_move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&lt;&lt;</span>
  optional <span style="color: #a52a2a;">(</span>pgn_check <span style="color: #a52a2a;">&lt;|&gt;</span> pgn_checkmate<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
The order of parsers to try in <code>pgn_san</code> is actually important, since
otherwise the parser could get stuck when successfully parsing an SAN string
that is a prefix of another SAN string (e.g. <code>Qh8</code> as a prefix of the
disambiguated move <code>Qg7h8</code>.  We have to try the most specific parser
first to avoid this trap.  There are parser combinator libraries that
work around this problem by allowing backtracking, but Opal is not one
of those.
</p>

<p>
A comment is just anything between curly braces:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_comment</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>exactly <span style="color: #008000;">'{'</span> <span style="color: #a52a2a;">&gt;&gt;</span> many <span style="color: #a52a2a;">(</span>none_of <span style="color: #a52a2a;">[</span><span style="color: #008000;">'}'</span><span style="color: #a52a2a;">])</span> <span style="color: #a52a2a;">&lt;&lt;</span> exactly <span style="color: #008000;">'}'</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=&gt;</span> implode

<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">nonstandard `. ...` </span><span style="color: #8D8D84;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_number</span> <span style="color: #a52a2a;">=</span>
  many1 digit <span style="color: #a52a2a;">&lt;&lt;</span> <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">". ..."</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #008000;">"..."</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #008000;">"."</span><span style="color: #a52a2a;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga414c58" class="outline-2">
<h2 id="orga414c58">Mutually recursive parsers</h2>
<div class="outline-text-2" id="text-orga414c58">
<p>
The last few definitions are tricky because they are <i>mutually
recursive</i>.  Since PGN allows recursive variations, a move can contain
a list of move sequences, so it needs to be defined recursively.
Here&rsquo;s the parser:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #006699;">pgn_rav</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>exactly <span style="color: #008000;">'('</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span>
  lexeme <span style="color: #a52a2a;">(</span>pgn_line <span style="color: #a52a2a;">())</span> <span style="color: #a52a2a;">&lt;&lt;</span>
  lexeme <span style="color: #a52a2a;">(</span>exactly <span style="color: #008000;">')'</span><span style="color: #a52a2a;">)</span>

<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">comments can be sequential </span><span style="color: #8D8D84;">*)</span>
<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">TODO: semicolon until end-of-line comment </span><span style="color: #8D8D84;">*)</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #006699;">pgn_move</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  many <span style="color: #a52a2a;">(</span>lexeme pgn_comment<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">pre_comment</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe <span style="color: #a52a2a;">(</span>lexeme pgn_number<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span> lexeme pgn_san <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">move</span> <span style="color: #a52a2a;">-&gt;</span>
  many <span style="color: #a52a2a;">(</span>lexeme pgn_nag<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">nags</span> <span style="color: #a52a2a;">-&gt;</span>
  many <span style="color: #a52a2a;">(</span>lexeme pgn_comment<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">post_comment</span> <span style="color: #a52a2a;">-&gt;</span>
  many <span style="color: #a52a2a;">(</span>lexeme <span style="color: #a52a2a;">(</span>pgn_rav <span style="color: #a52a2a;">()))</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">rav</span> <span style="color: #a52a2a;">-&gt;</span>
  return <span style="color: #a52a2a;">{</span>pre_comment<span style="color: #a52a2a;">;</span> move<span style="color: #a52a2a;">;</span> nags<span style="color: #a52a2a;">;</span> rav<span style="color: #a52a2a;">;</span> post_comment<span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #006699;">pgn_line</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  sep_by <span style="color: #a52a2a;">(</span>pgn_move <span style="color: #a52a2a;">())</span> space

<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">nonstandard 1/2 </span><span style="color: #8D8D84;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_result</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"1-0"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Win</span> <span style="color: #000000; background-color: #FFFFFF;">White</span><span style="color: #a52a2a;">)))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"1/2-1/2"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #000000; background-color: #FFFFFF;">Draw</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"1/2"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #000000; background-color: #FFFFFF;">Draw</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"0-1"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Win</span> <span style="color: #000000; background-color: #FFFFFF;">White</span><span style="color: #a52a2a;">)))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #008000;">"*"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #000000; background-color: #FFFFFF;">None</span><span style="color: #a52a2a;">)</span>

<span style="color: #8D8D84;">(* </span><span style="color: #8D8D84; font-style: italic;">nonstandard non-required newline </span><span style="color: #8D8D84;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn_game</span> <span style="color: #a52a2a;">=</span>
  lexeme pgn_header <span style="color: #a52a2a;">&lt;&lt;</span> <span style="color: #a52a2a;">(</span>maybe newline<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">header</span> <span style="color: #a52a2a;">-&gt;</span>
  pgn_line <span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">&lt;&lt;</span> spaces <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">movetext</span> <span style="color: #a52a2a;">-&gt;</span>
  pgn_result <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #0000FF;">fun</span> <span style="color: #BA36A5;">result</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span>header<span style="color: #a52a2a;">,</span> movetext<span style="color: #a52a2a;">,</span> result<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
You might be wondering, why do some parsers need an additional <code>()</code>
unit argument?  Try and see what happens if you leave it out.  OCaml
will complain that you cannot define your parsers this way.  The
easiest way to see this is to try to substitute a parser definition in
the right-hand side of another parser definition.  The parser
<code>pgn_rav</code> relies on <code>pgn_line</code>, so you could try to inline that.  But
then <code>pgn_line</code> relies on <code>pgn_move</code>, and <code>pgn_move</code> is defined in
terms of <code>pgn_rav</code>.  You&rsquo;re caught in an infinite loop!  By giving the
parsers an additional argument, you delay the evaluation, and the
definition is sound.
</p>
</div>
</div>

<div id="outline-container-org1825759" class="outline-2">
<h2 id="org1825759">From PGN to game zipper</h2>
<div class="outline-text-2" id="text-org1825759">
<p>
Finally we need a function that turns the parsed PGN into a game
zipper.  In order to compute a move from an SAN, we compute all the
moves that the SAN is compatible with.  If that&rsquo;s more than one, we
raise an exception because the move is ambiguous.  If it&rsquo;s zero, then
the move is illegal. In order to find the moves that a SAN is
compatible with, we need to do some rather boring case analysis.  I&rsquo;ll
spare you the details and just give you the entire function right away:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">unify_moves</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">(</span><span style="color: #BA36A5;">position</span><span style="color: #a52a2a;">:</span><span style="color: #6434A3;">Chess.</span><span style="color: #6434A3;">position</span><span style="color: #a52a2a;">)</span><span style="color: #BA36A5;"> pgn_move move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #0000FF;">match</span> pgn_move<span style="color: #a52a2a;">,</span> move <span style="color: #0000FF;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Queenside_castle</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Queenside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #D0372D;">true</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Kingside_castle</span><span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Kingside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #D0372D;">true</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pawn_move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> p_type<span style="color: #a52a2a;">),</span>
    <span style="color: #000000; background-color: #FFFFFF;">Promotion</span> <span style="color: #a52a2a;">(</span>p_type'<span style="color: #a52a2a;">,</span> s_file'<span style="color: #a52a2a;">,</span> t_file'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">promo_rank</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #0000FF;">match</span> position.turn <span style="color: #0000FF;">with</span> <span style="color: #000000; background-color: #FFFFFF;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 0 <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">White</span> <span style="color: #a52a2a;">-&gt;</span> 7
    <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #BA36A5;">s_rank'</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #0000FF;">match</span> position.turn <span style="color: #0000FF;">with</span> <span style="color: #000000; background-color: #FFFFFF;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 1 <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">White</span> <span style="color: #a52a2a;">-&gt;</span> 6 <span style="color: #000000; font-weight: bold;">in</span>
    position.ar.<span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Piece</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Pawn</span><span style="color: #a52a2a;">,</span> position.turn<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&amp;&amp;</span>
    <span style="color: #6434A3;">Chess.</span>unify s_file' s_file <span style="color: #a52a2a;">&amp;&amp;</span> t_file' <span style="color: #a52a2a;">=</span> t_file <span style="color: #a52a2a;">&amp;&amp;</span>
    promo_rank <span style="color: #a52a2a;">=</span> t_rank <span style="color: #a52a2a;">&amp;&amp;</span> p_type' <span style="color: #a52a2a;">=</span> p_type
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pawn_move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> <span style="color: #000000; background-color: #FFFFFF;">None</span><span style="color: #a52a2a;">),</span>
    <span style="color: #000000; background-color: #FFFFFF;">Move</span> <span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">,</span> s_rank'<span style="color: #a52a2a;">,</span> t_file'<span style="color: #a52a2a;">,</span> t_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    position.ar.<span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Piece</span> <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Pawn</span><span style="color: #a52a2a;">,</span> position.turn<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&amp;&amp;</span>
    <span style="color: #6434A3;">Chess.</span>unify s_file' s_file <span style="color: #a52a2a;">&amp;&amp;</span> t_file' <span style="color: #a52a2a;">=</span> t_file <span style="color: #a52a2a;">&amp;&amp;</span> t_rank' <span style="color: #a52a2a;">=</span> t_rank
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Piece_move</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">)),</span>
    <span style="color: #000000; background-color: #FFFFFF;">Move</span> <span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">,</span> s_rank'<span style="color: #a52a2a;">,</span> t_file'<span style="color: #a52a2a;">,</span> t_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    position.ar.<span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Piece</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> position.turn<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&amp;&amp;</span>
    <span style="color: #6434A3;">Chess.</span>unify s_file' s_file <span style="color: #a52a2a;">&amp;&amp;</span> <span style="color: #6434A3;">Chess.</span>unify s_rank' s_rank <span style="color: #a52a2a;">&amp;&amp;</span>
    t_file' <span style="color: #a52a2a;">=</span> t_file <span style="color: #a52a2a;">&amp;&amp;</span> t_rank' <span style="color: #a52a2a;">=</span> t_rank    
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #D0372D;">false</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">move_of_pgn_move</span><span style="color: #BA36A5;"> position move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>legal_moves position <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">possible_moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">List.</span>filter <span style="color: #a52a2a;">(</span>unify_moves position move<span style="color: #a52a2a;">)</span> moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #0000FF;">match</span> possible_moves <span style="color: #0000FF;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #006FE0;">raise</span> <span style="color: #6434A3;">Chess.</span><span style="color: #000000; background-color: #FFFFFF;">Illegal_move</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[</span>move'<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">-&gt;</span> move'
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #006FE0;">raise</span> Ambiguous_move
</pre>
</div>

<p>
A game zipper is easily obtained by just following along the parsed
list of SANs, carrying the position, ply number and move list in an accumulator.
Remember that <code>List.fold_left</code> takes as its first argument a function
that maps the current accumulator and a list item to the next
accumulator (the function <code>advance</code>).  The initial accumulator is an
empty game zipper.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">game_of_string</span><span style="color: #BA36A5;"> string</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #6434A3;">Game</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">advance</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">(</span><span style="color: #BA36A5;">position</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> ply</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> acc</span><span style="color: #a52a2a;">)</span><span style="color: #BA36A5;"> </span><span style="color: #a52a2a;">(</span><span style="color: #BA36A5;">move</span><span style="color: #a52a2a;">:</span><span style="color: #6434A3;">pgn_move</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">move'</span> <span style="color: #a52a2a;">=</span> move_of_pgn_move position move.move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">position'</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>make_move position move' <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Chess.</span>san_of_move position move' <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">acc'</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>move'<span style="color: #a52a2a;">,</span> san<span style="color: #a52a2a;">)::</span>acc <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">(</span>position'<span style="color: #a52a2a;">,</span> ply <span style="color: #a52a2a;">+</span> 1<span style="color: #a52a2a;">,</span> acc'<span style="color: #a52a2a;">)</span>
  <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">pgn</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">LazyStream.</span>of_string string <span style="color: #a52a2a;">|&gt;</span> parse pgn_game <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #0000FF;">match</span> pgn <span style="color: #0000FF;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Some</span> <span style="color: #a52a2a;">(</span>_<span style="color: #a52a2a;">,</span> pgn'<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">position</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> ply</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> past</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #6434A3;">List.</span>fold_left advance <span style="color: #a52a2a;">(</span><span style="color: #6434A3;">Chess.</span>init_position<span style="color: #a52a2a;">,</span> 0<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[])</span> pgn' <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span>position<span style="color: #a52a2a;">;</span> ply<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>past<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[])}</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #006FE0;">raise</span> Parse_error
</pre>
</div>

<p>
Now let&rsquo;s add some basic functionality to <code>src/Main.ml</code>.  We will
parse the Lichess PGN and display it in the move list.  Let&rsquo;s define
one message <code>Validate_pgn of string</code> and handle it the following way:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Pgn_data</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Result.</span><span style="color: #000000; background-color: #FFFFFF;">Ok</span> data<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #a52a2a;">{</span> model <span style="color: #0000FF;">with</span>
    pgn <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>id<span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> data<span style="color: #a52a2a;">)::</span><span style="color: #6434A3;">List.</span>remove_assoc id model.pgn
  <span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #FFFFFF;">Validate_pgn</span> data<span style="color: #a52a2a;">)</span>
<span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Validate_pgn</span> pgn <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #0000FF;">try</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #BA36A5;">position</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> ply</span><span style="color: #a52a2a;">,</span><span style="color: #BA36A5;"> moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #6434A3;">Pgn.</span>game_of_string pgn <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span>model <span style="color: #0000FF;">with</span> position<span style="color: #a52a2a;">;</span> ply<span style="color: #a52a2a;">;</span> moves<span style="color: #a52a2a;">},</span> <span style="color: #6434A3;">Cmd.</span>none
  <span style="color: #0000FF;">with</span> _e <span style="color: #a52a2a;">-&gt;</span> <span style="color: #6434A3;">Js.</span>log _e <span style="color: #a52a2a;">;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #6434A3;">Cmd.</span>none
</pre>
</div>

<p>
Also <code>pgn_view</code> needs to be adapted:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #006699;">pgn_view</span><span style="color: #BA36A5;"> id model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #0000FF;">try</span> <span style="color: #0000FF;">match</span> <span style="color: #6434A3;">List.</span>assoc id model.pgn <span style="color: #0000FF;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Loading</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">"Loading PGN game..."</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Received</span> _ <span style="color: #a52a2a;">-&gt;</span> move_list_view model.ply model.moves
    <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #FFFFFF;">Failed</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">"Game could not be loaded."</span>             
  <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #008000;">""</span>
</pre>
</div>

<p>
And that&rsquo;s it for today!  You can now replay games from Lichess.
<a href="../day10/index.html">Tomorrow, we will add functionality to load several games at the same
time, switch between them and store them in the browsers local
storage.</a>  We will also learn about the <code>Map</code> functional data
structures and two other functional programming techniques: lenses and functors.
</p>
</div>
</div>
</div>
</body>
</html>
