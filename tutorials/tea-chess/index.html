<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-12-12 Sat 14:45 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chess in Bucklescript-TEA</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Daniel Quernheim">
<link rel='stylesheet' href='/style.css' type='text/css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><div id="preamble" class="status">
<div id='nav'><a href="/">home</a></div>
</div>
<div id="content">
<h1 class="title">Chess in Bucklescript-TEA</h1>
<div style="display:flex;justify-content:center;align-items:center;margin:.5em auto .5em auto"><img src="/img/Octocat.jpg" width="50" height="42"
alt="Octocat" /> <a href="https://github.com/quernd/tea-chess">Code for this tutorial</a> &mdash; <a href="demo.html">Demo</a></div>

<p>
This is a chess-themed tutorial on writing an SPA in
<a href="https://github.com/OvermindDL1/bucklescript-tea">Bucklescript-TEA</a>.  You will develop an app that looks like <a href="./demo.html">this demo</a>,
from scratch. 
</p>

<p>
This tutorial was written in January 2018.  Send
comments <a href="mailto:quernd@gmx.de">by e-mail</a>.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Part I</td>
<td class="org-left"><a href="#part-i">First steps with Bucklescript-TEA</a></td>
<td class="org-left">bsb, Tea, Tea.Html, Tea.App</td>
</tr>

<tr>
<td class="org-left">Part II</td>
<td class="org-left"><a href="#part-ii">A chessboard with random moves</a></td>
<td class="org-left">Tea.Cmd, Tea.Random, composition</td>
</tr>

<tr>
<td class="org-left">Part III</td>
<td class="org-left"><a href="#part-iii">A drag and drop chessboard</a></td>
<td class="org-left">Tea.Sub, Tea.Json, Tea.Mouse</td>
</tr>

<tr>
<td class="org-left">Part IV</td>
<td class="org-left"><a href="#part-iv">Moving in the move list</a></td>
<td class="org-left">list zippers, keyboard events</td>
</tr>

<tr>
<td class="org-left">Part V</td>
<td class="org-left"><a href="#part-v">AJAX, parsing and responsive CSS</a></td>
<td class="org-left">Tea.Http, parser combinators</td>
</tr>

<tr>
<td class="org-left">Part VI</td>
<td class="org-left"><a href="#part-vi">Lenses, maps, and functors</a></td>
<td class="org-left">Lens, Map.Make, functors</td>
</tr>

<tr>
<td class="org-left">Part VII</td>
<td class="org-left"><a href="#part-vii">Routing, local storage, computer matches</a></td>
<td class="org-left">Tea.Navigation, Tea.Ex</td>
</tr>

<tr>
<td class="org-left">Part VIII</td>
<td class="org-left"><a href="#part-viii">A move tree</a></td>
<td class="org-left">tree zippers, recursive views</td>
</tr>
</tbody>
</table>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#part-i">Part I: First steps with Bucklescript-TEA</a>
<ul>
<li><a href="#org170418a">Getting started</a></li>
<li><a href="#orgc384e79">Project setup from scratch</a></li>
<li><a href="#ready">The Elm architecture</a></li>
<li><a href="#orgdf3ae31">Your first app: A move counter</a></li>
</ul>
</li>
<li><a href="#part-ii">Part II: A chessboard with random moves</a>
<ul>
<li><a href="#org7f6c643">Merlin</a></li>
<li><a href="#orge41e05d">Using existing code</a></li>
<li><a href="#org21c9068">Not a beginner anymore</a></li>
<li><a href="#org9b0a4c9">Chessboard powered by O&rsquo;Chess</a></li>
<li><a href="#org061b9cf">Your first commands: Random moves</a></li>
<li><a href="#org0e324ab">Composing views and models</a></li>
</ul>
</li>
<li><a href="#part-iii">Part III: A drag and drop chessboard</a>
<ul>
<li><a href="#org2fba397">Drag and drop: defining messages</a></li>
<li><a href="#org30f5f69">JSON decoders</a></li>
<li><a href="#org1d49362">CSS for drag and drop</a></li>
<li><a href="#org10f2a8f">Starting the drag</a></li>
<li><a href="#org96f6c47">Your first subscriptions: Mouse events</a></li>
<li><a href="#org06b3c6b">Pawn promotion</a></li>
</ul>
</li>
<li><a href="#part-iv">Part IV: Moving in the move list</a>
<ul>
<li><a href="#org7792085">Motivational move logging</a></li>
<li><a href="#orgcbed727">Move logging like chessplayers do</a></li>
<li><a href="#orgc0b51e7">A nice-looking move list</a></li>
<li><a href="#org62cfee0">A functional move list: zippers!</a></li>
<li><a href="#org10ac139">Folding zippers</a></li>
<li><a href="#org887763a">Catching keyboard events</a></li>
</ul>
</li>
<li><a href="#part-v">Part V: AJAX, parsing and responsive CSS</a>
<ul>
<li><a href="#orge7da95c">HTTP requests (AJAX)</a></li>
<li><a href="#org805e731">Loading Lichess games</a></li>
<li><a href="#orgb8c8cdc">Parser combinators</a></li>
<li><a href="#org18e4f44">The PGN format</a></li>
<li><a href="#org5e72e91">Simple parsers</a></li>
<li><a href="#org473ff8a">Mutually recursive parsers</a></li>
<li><a href="#org2a3b424">From PGN to game zipper</a></li>
<li><a href="#org193b3e7">Responsive CSS</a></li>
<li><a href="#org93f2c34">Header and result views</a></li>
</ul>
</li>
<li><a href="#part-vi">Part VI: Lenses, maps, and functors</a>
<ul>
<li><a href="#org130d1f9">A list of games</a></li>
<li><a href="#org48363c4">A functional getter/setter: Lens!</a></li>
<li><a href="#orgc850b58">Modules and functors: Map</a></li>
<li><a href="#org27bc922">Keeping track of games with a map</a></li>
<li><a href="#org2372d18">More maps: String maps</a></li>
</ul>
</li>
<li><a href="#part-vii">Part VII: Routing, local storage, computer matches</a>
<ul>
<li><a href="#org9b66a71">Client-side routing</a></li>
<li><a href="#org926b372">Using local storage</a></li>
<li><a href="#org5513472">Play against the computer</a></li>
</ul>
</li>
<li><a href="#part-viii">Part VIII: A move tree view</a>
<ul>
<li><a href="#orgb2b7cbd">Fully functional: Tree zippers!</a></li>
<li><a href="#org59c1833">Building a zipper recursively</a></li>
<li><a href="#org0ce1bb6">Inside-out folds</a></li>
<li><a href="#org32fd650"><span class="todo TODO">TODO</span> Move tree view and proper PGN serialization</a></li>
<li><a href="#orgc2e6ab3"><span class="todo TODO">TODO</span> Navigating in a zipper</a></li>
<li><a href="#orgb101770"><span class="todo TODO">TODO</span> The final touches (CSS)</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org7301d20" class="outline-2">
<h2 id="part-i"><a id="org7301d20"></a>Part I: First steps with Bucklescript-TEA</h2>
<div class="outline-text-2" id="text-part-i">
<p>
<p class="up"><a href="#">up</a></p>
</p>

<p>
I recently started frontend web development in <a href="https://ocaml.org/">OCaml</a> by using
<a href="https://bucklescript.github.io/">Bucklescript</a> to compile my code into Javascript. Naturally, a
functional language like OCaml goes well together with the famous <a href="https://guide.elm-lang.org/architecture/">Elm
architecture</a>, so I chose to explore the recent <a href="https://github.com/OvermindDL1/bucklescript-tea">Bucklescript-TEA</a>
library. (TEA stands for &ldquo;The Elm Architecture&rdquo;, obviously.)
</p>

<p>
OCaml and Bucklescript have recently gained a lot of attention, not
least because of Facebook&rsquo;s <a href="https://reasonml.github.io/">Reason</a> &#x2013; an alternative, more
Javascript-like syntax for OCaml. I prefer the traditional OCaml
syntax, but you can use either syntax together with Bucklescript.
</p>

<p>
In this tutorial, I will walk you through
an entire example of a single-page application. It
will certainly help if you have a little experience with chess, web
development and in particular functional programming in general or OCaml in
particular, but it is no prerequisite, you can pick up everything you
need on the way.
</p>
</div>
<div id="outline-container-org170418a" class="outline-3">
<h3 id="org170418a">Getting started</h3>
<div class="outline-text-3" id="text-org170418a">
<p>
Before you can setup <a href="https://bucklescript.github.io/">Bucklescript</a>, make sure you have the following installed:
</p>

<ul class="org-ul">
<li><a href="https://nodejs.org/">Node.js</a> and optionally <a href="https://yarnpkg.com/">Yarn</a>. Bucklescript piggybacks on the <a href="https://www.npmjs.com/">NPM
package database</a>, and you need NPM packages for Bucklescript
development. I prefer Yarn as an interface to NPM and use Yarn
commands throughout this tutorial, but if you are already using NPM,
it will work just as fine.</li>

<li><a href="https://opam.ocaml.org/doc/Install.html">OPAM</a>, the OCaml package manager.  You can use Bucklescript without
OPAM, but I strongly recommend you to use the excellent <a href="https://github.com/ocaml/merlin">Merlin</a> tool
for an <a href="https://opam.ocaml.org/blog/turn-your-editor-into-an-ocaml-ide/">IDE-like experience in your editor</a>. If you want to explore
server-side OCaml as well, OPAM will allow you to switch between
different versions of OCaml packages for server-side and client-side
development seamlessly. Follow the <a href="https://bucklescript.github.io/bucklescript/Manual.html#_making_use_of_opam">instructions</a> for switching to
Bucklescript&rsquo;s version of the OCaml compiler.</li>
</ul>

<p>
You can choose to install the main Bucklescript package <code>bs-platform</code>
globally or locally for every project. It is pretty hefty (it brings
its own OCaml compiler) and takes a while to setup, so I recommend
installing it globally with <code>yarn global add bs-platform</code>.
This gives you access to the binaries <code>bsc</code> (the Bucklescript
compiler) and <code>bsb</code> (the Bucklescript build system).
</p>

<p>
Let&rsquo;s setup a project directory structure. You have two options:
</p>

<p>
If you don&rsquo;t feel like setting up everything yourself, the easiest way
is to use the <a href="https://github.com/tcoopman/bucklescript-tea-starter-kit">Bucklescript-TEA starter kit</a>. This gives you a nice
starting point and even includes hot reloading. Clone the repository,
copy the relevant files into a fresh repository, or just follow along
with <a href="https://www.github.com/quernd/tea-chess">my repository</a>. (I encourage you to use any version control system
that you are comfortable with &#x2013; I actually used <a href="http://www.fossil-scm.org/">Fossil</a> for local
version control.) If you type <code>yarn install</code> (or <code>npm install</code>), it
will install the dependencies (<code>bs-platform</code>, <code>bucklescript-tea</code> and
<code>rollup</code> for bundling). Make sure to run <code>yarn link</code> (in the global
location of <code>bs-platform</code>) and <code>yarn link bs-platform</code> first if you
have a global installation of <code>bs-platform</code>, otherwise you will get a
fresh local install. You are ready to start coding and can <a href="#ready">skip to the
next section</a>.
</p>
</div>
</div>

<div id="outline-container-orgc384e79" class="outline-3">
<h3 id="orgc384e79">Project setup from scratch</h3>
<div class="outline-text-3" id="text-orgc384e79">
<p>
If you want to setup your project from scratch, first install
<code>bs-platform</code> globally if you haven&rsquo;t.  Then run <code>bsb -init
tea-chess</code>.  This will initialize an empty Bucklescript project in the
directory <code>tea-chess</code>.  Take a look at the files:
</p>

<ul class="org-ul">
<li><code>package.json</code> is the place to declare your NPM dependencies and
development dependencies, and to define build and watch scripts.  A
few scripts are already defined so that you can just run <code>yarn run
  build</code> to compile your source files using <code>bsb</code> or <code>yarn run watch</code> to keep
running in the background and compile your source files whenever you
save them.</li>

<li><code>bsconfig.json</code> contains instructions for the Bucklescript compiler.
Bucklescript will look for source files in the directories listed in
<code>sources</code>.</li>
</ul>

<p>
Let&rsquo;s add a <code>devDependency</code> for <code>bucklescript-tea</code> by running <code>yarn
add -D bucklescript-tea</code>. This will automatically update your
<code>package.json</code>. Since <code>bucklescript-tea</code> contains OCaml code, you need
to make Bucklescript aware of it by adding it to the <code>bs-dependencies</code>
in <code>bsconfig.json</code> as follows:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #8b2252;">"bs-dependencies"</span>: [
  <span style="color: #8b2252;">"bucklescript-tea"</span>
]
</pre>
</div>

<p>
Now the <code>bsb</code> build tool has access to the sources of
<code>bucklescript-tea</code>. 
</p>

<p>
We need one more tool to do meaningful development.  Bucklescript
itself translates one OCaml file into one Javascript file, so unless
you want to do all your development in one big file (which I don&rsquo;t
think you will), you need a bundler to link the pieces together for
the browser.  I&rsquo;m using <a href="https://rollupjs.org/">Rollup</a>, but you could also give <a href="https://en.parceljs.org/">Parcel</a>, <a href="http://browserify.org/">Browserify</a> or
<a href="https://webpack.js.org/">Webpack</a> a try.  Especially Parcel, the &ldquo;zero-configuration&rdquo;
application bundler,
is a good choice if you just want to get things up and running.
(Instructions below.)
</p>

<p>
Install the following NPM packages:
</p>

<pre class="example">
yarn add -D rollup
yarn add -D npm-run-all
yarn add -D rollup-plugin-node-resolve
yarn add -D serve
</pre>

<p>
With <code>npm-run-all</code>, we can build sequential and parallel build scripts
to run both Bucklescript and Rollup.  The plugin
<code>rollup-plugin-node-resolve</code> is needed to find the right files to
bundle in the NPM packages you rely on, and the <code>serve</code> package gives
you a simple development webserver.
</p>

<p>
Here is my <code>package.json</code> with a few more tasks.  I use <code>run-s</code> to run
the Bucklescript build system and Rollup sequentially in the <code>build</code> task, while in the
<code>watch</code> task I run the watchers and the webserver in parallel.
</p>

<div class="org-src-container">
<pre class="src src-js">{
  <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"tea-chess"</span>,
  <span style="color: #8b2252;">"version"</span>: <span style="color: #8b2252;">"0.1.0"</span>,
  <span style="color: #8b2252;">"scripts"</span>: {
    <span style="color: #8b2252;">"serve"</span>: <span style="color: #8b2252;">"serve release"</span>,
    <span style="color: #8b2252;">"clean"</span>: <span style="color: #8b2252;">"bsb -clean-world"</span>,
    <span style="color: #8b2252;">"build:bsb"</span>: <span style="color: #8b2252;">"bsb -make-world"</span>,
    <span style="color: #8b2252;">"build:js"</span>: <span style="color: #8b2252;">"rollup -c"</span>,
    <span style="color: #8b2252;">"build"</span>: <span style="color: #8b2252;">"run-s build:bsb build:js"</span>,
    <span style="color: #8b2252;">"watch:bsb"</span>: <span style="color: #8b2252;">"bsb -make-world -w"</span>,
    <span style="color: #8b2252;">"watch:js"</span>: <span style="color: #8b2252;">"rollup -c -w"</span>,
    <span style="color: #8b2252;">"watch"</span>: <span style="color: #8b2252;">"run-p watch:bsb watch:js serve"</span>
  },
  <span style="color: #8b2252;">"keywords"</span>: [
    <span style="color: #8b2252;">"BuckleScript"</span>
  ],
  <span style="color: #8b2252;">"author"</span>: <span style="color: #8b2252;">"Daniel Quernheim"</span>,
  <span style="color: #8b2252;">"license"</span>: <span style="color: #8b2252;">"MIT"</span>,
  <span style="color: #8b2252;">"devDependencies"</span>: {
    <span style="color: #8b2252;">"bs-platform"</span>: <span style="color: #8b2252;">"^2.1.0"</span>,
    <span style="color: #8b2252;">"bucklescript-tea"</span>: <span style="color: #8b2252;">"^0.7.0"</span>,
    <span style="color: #8b2252;">"npm-run-all"</span>: <span style="color: #8b2252;">"^4.1.2"</span>,
    <span style="color: #8b2252;">"rollup"</span>: <span style="color: #8b2252;">"^0.53.3"</span>,
    <span style="color: #8b2252;">"rollup-plugin-node-resolve"</span>: <span style="color: #8b2252;">"^3.0.0"</span>,
    <span style="color: #8b2252;">"serve"</span>: <span style="color: #8b2252;">"^6.4.4"</span>
  }
}
</pre>
</div>

<p>
When Rollup is run with the <code>-c</code> configuration option, it looks for a
file called <code>rollup.config.js</code>, so here it is. Rollup will look for
the file <code>src/Main.bs.js</code> and bundle it up with all the modules that
are referenced in it, in a big bundle <code>release/main.js</code> that will be
accessible in your Javascript as <code>starter</code>.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> resolve from <span style="color: #8b2252;">'rollup-plugin-node-resolve'</span>;

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> {
  input: <span style="color: #8b2252;">'./src/Main.bs.js'</span>,
  output: {
    file: <span style="color: #8b2252;">'./release/main.js'</span>,
    format: <span style="color: #8b2252;">'iife'</span>,
    name: <span style="color: #8b2252;">'starter'</span>
  },
  plugins: [
    resolve()
  ]
};
</pre>
</div>

<p>
Rollup needs files in <code>ES6</code> format, so we tell Bucklescript in
<code>bsconfig.json</code>:
</p>

<div class="org-src-container">
<pre class="src src-js">{
  <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"tea-chess"</span>,
  <span style="color: #8b2252;">"version"</span>: <span style="color: #8b2252;">"0.1.0"</span>,
  <span style="color: #8b2252;">"sources"</span>: [
    <span style="color: #8b2252;">"src"</span>
  ],
  <span style="color: #8b2252;">"package-specs"</span>: {
    <span style="color: #8b2252;">"module"</span>: <span style="color: #8b2252;">"es6"</span>,
    <span style="color: #8b2252;">"in-source"</span>: <span style="color: #008b8b;">true</span>
  },
  <span style="color: #8b2252;">"suffix"</span>: <span style="color: #8b2252;">".bs.js"</span>,
  <span style="color: #8b2252;">"bs-dependencies"</span>: [
    <span style="color: #8b2252;">"bucklescript-tea"</span>
  ]
}
</pre>
</div>

<p>
For every <code>.ml</code> file in the directory <code>src</code>, it will create a
corresponding <code>.bs.js</code> file, so your main file will be <code>src/Main.ml</code>.
</p>

<p>
Before we can start coding, we need to set up an HTML page.  Put the
following into <code>release/index.html</code>:
</p>

<div class="org-src-container">
<pre class="src src-html"><span style="color: #8b2252;">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
  &lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"utf-8"</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">http-equiv</span>=<span style="color: #8b2252;">"X-UA-Compatible"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"IE=edge"</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"viewport"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"width=device-width, initial-scale=1"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">TEA-Chess</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
  &lt;/<span style="color: #0000ff;">head</span>&gt;

  &lt;<span style="color: #0000ff;">body</span>&gt;
    &lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"main.js"</span>&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
    &lt;<span style="color: #0000ff;">script</span>&gt;
        setTimeout(function(){
        var app = starter.main(document.body);
        }, 1)
    &lt;/<span style="color: #0000ff;">script</span>&gt;
  &lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<div class="hint">
<p>
If you use the &ldquo;zero-configuration&rdquo; bundler <a href="https://en.parceljs.org/">Parcel</a>, you need to
structure your code slightly differently.  Here&rsquo;s <code>release/index.html</code>:
</p>

<div class="org-src-container">
<pre class="src src-html"><span style="color: #8b2252;">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
  &lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"utf-8"</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">http-equiv</span>=<span style="color: #8b2252;">"X-UA-Compatible"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"IE=edge"</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"viewport"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"width=device-width, initial-scale=1"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">TEA-Chess</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
  &lt;/<span style="color: #0000ff;">head</span>&gt;

  &lt;<span style="color: #0000ff;">body</span>&gt;
    &lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"./index.js"</span>&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
  &lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
And here&rsquo;s <code>release/index.js</code>:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #a020f0;">import</span> * as starter from <span style="color: #8b2252;">'../src/Main.bs.js'</span>;
setTimeout(<span style="color: #a020f0;">function</span>() {
    <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">app</span> = starter.main(document.body);
}, 1)
</pre>
</div>

<p>
Then, <code>parcel release/index.html</code> will build your bundle without any
problems.  This approach also works for Rollup (you just have to point
<code>input</code> to <code>release/index.js</code> and use <code>&lt;script
src="main.js"&gt;&lt;/script&gt;</code> in the HTML file instead).
</p>

</div>
</div>
</div>

<div id="outline-container-orgf18c1bf" class="outline-3">
<h3 id="ready"><a id="orgf18c1bf"></a>The Elm architecture</h3>
<div class="outline-text-3" id="text-ready">
<p>
Maybe you are
familiar with the &ldquo;Elm architecture&rdquo;, made popular by the Elm language
of Evan Czaplicki. Essentially, Bucklescript-TEA
provides an API similar, if not almost compatible, to that of Elm&rsquo;s.
I&rsquo;m not going to provide a thorough discussion in case you haven&rsquo;t
worked with the Elm architecture before. There are lots of resources
online that do a better job I ever could do. For instance, check out
the <a href="https://guide.elm-lang.org/architecture/">official tutorial</a>.
However, the Elm architecture is pretty simple to grasp if all you
remember is this:
</p>

<ol class="org-ol">
<li>Your program state is represented by a <i>model</i>.</li>
<li>Whenever stuff happens (user clicks a button, AJAX data comes in,
etc.), the <i>update</i> function receives a <i>message</i> and the current
model and returns a new model.</li>
<li>The <i>view</i> function computes a
virtual DOM tree from the model (which is rendered to the screen).</li>
</ol>

<p>
Here&rsquo;s an adorable illustration by <a href="https://twitter.com/01k">Kolja
Wilcke</a> from his and <a href="https://twitter.com/unsoundscapes">Andrey
Kuzmin</a>&rsquo;s <a href="https://www.youtube.com/watch?v=En2BKs8unnQ">talk</a> on
<a href="https://github.com/w0rm/creating-a-fun-game-with-elm">Creating a Fun
Game With Elm</a>:
</p>

<p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en"
dir="ltr">Elm Architecture <a
href="https://twitter.com/hashtag/illustration?src=hash&amp;ref_src=twsrc%5Etfw">#illustration</a>
from our talk with <a
href="https://twitter.com/unsoundscapes?ref_src=twsrc%5Etfw">@unsoundscapes</a>
<a
href="https://twitter.com/curry_on_conf?ref_src=twsrc%5Etfw">@curry_on_conf</a>
<a
href="https://t.co/yTE5iivne7">pic.twitter.com/yTE5iivne7</a></p>&mdash;
Kolja Wilcke (@01k) <a
href="https://twitter.com/01k/status/755005168933011456?ref_src=twsrc%5Etfw">July
18, 2016</a></blockquote> <script async
src="https://platform.twitter.com/widgets.js"
charset="utf-8"></script>

</p>

<p>
Side effects are managed behind the scenes to ensure that your
functions stay pure. (A function is
<a href="https://en.wikipedia.org/wiki/Pure_function">pure</a> when it will
always return the same output value when called with the same input
arguments, and doesn&rsquo;t cause any side effect.) Therefore, in the Elm
architecture, you only deal with <i>recipes</i> for side effects, called
<i>commands</i>. When you need to ask for a side effect to be performed,
you can issue a command together with the new model in the <i>update</i>
function. Your program can also listen to <i>subscriptions</i> to receive
messages on events such as mouse and keyboard events, websockets, and
time. Both commands and subscriptions will feed messages into your
update function. 
</p>
</div>
</div>

<div id="outline-container-orgdf3ae31" class="outline-3">
<h3 id="orgdf3ae31">Your first app: A move counter</h3>
<div class="outline-text-3" id="text-orgdf3ae31">
<p>
Let&rsquo;s see the theory in practice.  The typical beginner example is a
counter, but because this tutorial is chess-themed, we will build a
move counter showing whose turn to move it is.  Open <code>src/Main.ml</code>.
If you started from scratch, it&rsquo;s empty.  If you used the starter kit,
there&rsquo;s already a counter in there.  Play with it.  Read the code if
you want.  Modify it.  Then delete it.  Just delete it.  It&rsquo;s more
satisfying to start from scratch.
</p>

<p>
Let&rsquo;s first open the <code>Tea</code> module.  It exposes a few submodules that
we will use often, and it doesn&rsquo;t pollute the namespace, so we will
generally open it.  (In OCaml, <code>open</code> imports all global <code>let</code>
definitions of a module.)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>
</pre>
</div>

<p>
Now let&rsquo;s think about our model.  It should represent how many moves
have been made (that&rsquo;s easy &#x2013; an <code>int</code>) and whose move it is.  For
this purpose, let&rsquo;s define a <i>variant type</i> <code>color</code> with two options.
That&rsquo;s generally a better idea than using a <code>bool</code>, <code>int</code> or whatever
one might misuse because it&rsquo;s more descriptive, less error-prone and
really easy to pattern-match.  
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">color</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> moves <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> turn <span style="color: #a52a2a;">:</span> color
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<div class="hint">
<p>
Don&rsquo;t be afraid of performance issues
&#x2013; if you examine the JS output, you will see that the variants are
represented by integers under the hood anyway.  The same goes for
records: there is no performance penalty for defining the <code>model</code>
record type (as opposed to, say, a tuple), because guess what &#x2013; in JS
it&rsquo;s just an array.  But since OCaml knows what goes where, it will
ensure all operations are typesafe.
</p>

</div>

<p>
This is our initial model:  We&rsquo;re on move 1 and it&rsquo;s White&rsquo;s turn.
Note that we can have types and values/functions with the same name
(both are <code>model</code>) &#x2013;
they don&rsquo;t live in the same namespace.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> moves <span style="color: #a52a2a;">=</span> 1
  <span style="color: #a52a2a;">;</span> turn <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
Now we need to define our messages.  The TEA way to do this is to use
a variant type again. Here&rsquo;s one message to get us started:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> Move
</pre>
</div>

<p>
The magic happens in the <code>update</code> function. Remember that <code>update</code>
receives the model and a message and has to return a new model.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">turn</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.turn <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span> model.moves <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> turn<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
So when the message is <code>Move</code> (our only message so far), we swap whose
turn it is around, increment the move count and return a new model.
We use a shorthand way called <i>field punning</i> to construct the new
record. Because our variables are named just like the record fields,
we can write <code>{ turn; moves }</code> instead of <code>{ turn = turn; moves =
moves }</code>.
</p>

<p>
Why does it look like <code>update</code> only receives one argument when it
should be two?  That&rsquo;s just a
shorthand way of matching the last argument without explicitly naming it:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> msg <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<div class="hint">
<p>
If for some reason you need a message that doesn&rsquo;t trigger any action, define a
<code>No_op</code> variant and add a case in the <code>update</code> function that just
returns the model.  But think about whether it&rsquo;s necessary in the
first place.
</p>

</div>

<p>
Now we only need a <code>view</code> function to render the counter in the
browser. All you need to render HTML is in Bucklescript-TEA&rsquo;s <code>Html</code>
module. Tags are defined functions take two arguments: a list of attributes
and a list of children.  Of course, they can be nested. 
</p>

<p>
Let&rsquo;s build a simple view.  I generally prefer to open <code>Html</code> locally
to save tons of keystrokes.  We&rsquo;ll have a <code>&lt;div&gt;</code> with two paragraphs,
one to tell you whose move it is, and one with a button to make a
move.  We use <code>Printf.sprintf</code> to format a string and pipe it into the
<code>text</code> function that builds a DOM text node.  (The pipe <code>|&gt;</code> operator
takes what&rsquo;s left of it and passes it as the last argument to what&rsquo;s
right of it.)
</p>

<p>
The button has a special attribute: <code>onClick</code> is a function that takes
a <code>msg</code> and creates an event listener that will trigger that message
when the button is clicked.  That way, <code>view</code> and <code>update</code> are linked.
And that&rsquo;s how we closed the loop.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Move %d.  It is %s's move."</span>
               model.moves
               <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> model.turn <span style="color: #a020f0;">with</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black"</span>
                                      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White"</span><span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">|&gt;</span> text
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> button
               <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Make a move!"</span> <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Finally, we put all the pieces together to make the app.  The function
<code>main</code> is then called from the Javascript side to launch it.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">main</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">App.</span>beginnerProgram
    <span style="color: #a52a2a;">{</span> model
    <span style="color: #a52a2a;">;</span> update
    <span style="color: #a52a2a;">;</span> view
    <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
I generally use <code>yarn run watch</code> to have Bucklescript compile my
source in the background whenever I save a file, and to run a little
webserver. When everything goes well, it will display something like
this:
</p>

<pre class="example">
rollup v0.53.3
bundles ./src/Main.bs.js → release/main.js...

   ┌─────────────────────────────────────────────────┐
   │                                                 │
   │   Serving!                                      │
   │                                                 │
   │   - Local:            http://localhost:5000     │
   │   - On Your Network:  http://192.168.1.5:5000   │
   │                                                 │
   │   Copied local address to clipboard!            │
   │                                                 │
   └─────────────────────────────────────────────────┘

created release/main.js in 2.1s

[2018-01-11 16:37:24] waiting for changes...
</pre>

<p>
Whenever something breaks, it will display the error and keep
recompiling until you get it right :-)
</p>
</div>
</div>
</div>

<div id="outline-container-orge420954" class="outline-2">
<h2 id="part-ii"><a id="orge420954"></a>Part II: A chessboard with random moves</h2>
<div class="outline-text-2" id="text-part-ii">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-org7f6c643" class="outline-3">
<h3 id="org7f6c643">Merlin</h3>
<div class="outline-text-3" id="text-org7f6c643">
<p>
If you installed Merlin, you can use it to examine the types of the
functions involved in the Elm Architecture. (For instance, if you&rsquo;re
using Emacs, press <kbd>C-c C-t</kbd>, and Merlin will tell
you the type of the function name at the point (cursor). Press
<kbd>C-c C-l</kbd>, and it will take you to the definition of
the function.)
</p>

<ul class="org-ul">
<li><code>update</code> is of type <code>model -&gt; msg -&gt; model</code>, meaning it takes a
model and a message from the variant type <code>msg</code>, and returns a new
model.</li>
<li><code>view</code> has type <code>model -&gt; msg Vdom.t</code>.  This means it takes a model
and returns a virtual DOM element that can trigger messages of type
<code>msg</code>. We say that <code>msg Vdom.t</code> is a <i>parameterized type</i>.</li>
</ul>

<p>
Of course, OCaml will be extremely strict to enforce correct types, so
whenever you make a type-related mistake, it will refuse to compile
your code. This may sound painful, but I find that not only does it
catch zillions of bugs before they hit the user, it also really helps
with refactoring. Also, OCaml will infer almost every type
automatically, leaving you without the need to explicitly annotate
types.
</p>
</div>
</div>

<div id="outline-container-orge41e05d" class="outline-3">
<h3 id="orge41e05d">Using existing code</h3>
<div class="outline-text-3" id="text-orge41e05d">
<p>
Just like <a href="https://chess24.com/en/read/news/deepmind-s-alphazero-crushes-chess">Google&rsquo;s recent success with AlphaZero</a>, we will only need to
spell out the rules of chess, and our program will learn how to
display the chessboard and play against itself. That&rsquo;s it, folks! See
you next time! Well&#x2026; that would be nice, but last time I checked, no
neural network was able to write frontend code. That might change, but
for now we still have to invest some human labour. At least we can
save a few hours of work by pulling in a decent chess library.
</p>

<p>
Bucklescript makes it really easy to use existing OCaml code when it
is packaged up as an NPM package.  Just mention the dependencies in
<code>bsconfig.json</code>, and <code>bsb</code> will automatically compile the
OCaml modules that you need.  Unfortunately, I didn&rsquo;t find
any open-source implementation of chess that I liked on either NPM or OPAM, not
even on Github for that matter, so I decided to use good old
MIT-licensed <a href="http://www.olegtrott.com/chess/">O&rsquo;Chess by Oleg Trott</a>.  You have two options:
</p>

<ul class="org-ul">
<li>Just download it and throw it in your <code>src</code> directory.</li>

<li>Use my packaged bundle.</li>
</ul>

<p>
Let&rsquo;s see what happens if you go for the first option like I did.  In fact, O&rsquo;Chess defines a
<code>color</code> type just like we did, so we could replace our type definition by:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">color</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Ochess.</span>color
</pre>
</div>

<p>
However, the build script will yell at you:
</p>

<pre class="example">
We've found a bug for you!
/Users/daniel/Playground/tea-chess/src/ochess.ml 43:6-8

41 │ open Printf
42 │ open Sys
43 │ open Str
44 │ 
45 │ (* 

The module or file Str can't be found.
</pre>

<p>
This is because Bucklescript differs from the standard OCaml
distribution in a few ways; it doesn&rsquo;t contain the <code>Str</code> module.
Fortunately, this only affects a small portion of the code, and is
easily remedied by providing our own function to split a string.
While I was at it, I got rid of all the warnings by prefixing all
unused variables with <code>_</code> and by replacing <code>or</code>  with <code>||</code>.  I also
disabled the <code>main</code> function of O&rsquo;Chess to prevent it from being
evaluated automatically.  I also fixed two minor bugs in the chess
logic.
</p>

<p>
So I recommend you either pick up my updated version from <a href="https://github.com/quernd/ochess">Github</a> or
  just pull it in as an NPM <code>devDependency</code> by typing <code>yarn add -D
  github:quernd/ochess</code>.  Then update your <code>bsconfig.json</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocamlnilwitches">{
  "name": "tea-chess",
  "version": "0.1.0",
  "sources": [
    "src"
  ],
  "package-specs": {
    "module": "es6",
    "in-source": true
  },
  "suffix": ".bs.js",
  "bs-dependencies": [
    "bucklescript-tea",
    "ochess"
  ],
  "bsc-flags": [ 
    "-bs-super-errors",
    "-w -23"
  ]
}
</pre>
</div>

<p>
I also added two flags to pass to the Bucklescript compiler.  If you
like the <a href="https://reasonml.github.io/blog/2017/08/25/way-nicer-error-messages.html">&ldquo;Elm style&rdquo; error messages</a>, put <code>-bs-super-errors</code> in there.
Also, I disabled warning 23 (&ldquo;all the fields are explicitly listed in this record:
the &lsquo;with&rsquo; clause is useless.&rdquo;), but that&rsquo;s of course personal
preference.  <a href="https://bucklescript.github.io/docs/en/build-configuration.html">Learn more about <code>bsb</code> configuration.</a>
</p>

<p>
Now O&rsquo;Chess should work. 
</p>
</div>
</div>

<div id="outline-container-org21c9068" class="outline-3">
<h3 id="org21c9068">Not a beginner anymore</h3>
<div class="outline-text-3" id="text-org21c9068">
<p>
Let&rsquo;s make a more useful app.  How about a chessboard and a button to
flip it around, as well as a button to make a random move?
</p>

<p>
First, since we&rsquo;re not beginners anymore, we&rsquo;ll &ldquo;upgrade&rdquo; from
<code>beginnerProgram</code> to <code>standardProgram</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">main</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">App.</span>standardProgram
    <span style="color: #a52a2a;">{</span> init
    <span style="color: #a52a2a;">;</span> update
    <span style="color: #a52a2a;">;</span> view
    <span style="color: #a52a2a;">;</span> subscriptions <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">_</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Sub.</span>none<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
This entails three changes:
</p>

<ul class="org-ul">
<li>We need to declare <i>subscriptions</i>.  We use subscriptions to be
notified of things like time or mouse and keyboard events.  TEA
expects a function that maps the model to the relevant
subscriptions, so we just tell it that regardless of the model we
have no subscriptions.</li>
</ul>

<div class="hint">
<p>
The variable <code>_</code> is an <i>anonymous variable</i>; any variable
  prefixed with an underscore will not cause the compiler to complain
  about unused variables.  In general, you should use these and also
  take the compiler warnings seriously.  An unused variable could
  likely be a typo or a bug!
</p>

</div>

<ul class="org-ul">
<li>We need to declare <i>commands</i>.  In the <code>update</code> function, we need to
return a command along with the model to tell TEA what side effects
we want to perform.  The result will come back as a message, so
the command type is always parameterized with a message type.  When
we don&rsquo;t want to issue a command, we just return <code>Cmd.none</code>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">turn</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Ochess.</span>opposite_color model.turn <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span> model.moves <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> turn<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<ul class="org-ul">
<li><code>init</code> now needs to be a function that takes an argument (this is
where initialization data could be passed in from Javascript) and
returns a model and a command. We don&rsquo;t expect any data and also
don&rsquo;t want to issue a command.</li>
</ul>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> moves <span style="color: #a52a2a;">=</span> 1
  <span style="color: #a52a2a;">;</span> turn <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b0a4c9" class="outline-3">
<h3 id="org9b0a4c9">Chessboard powered by O&rsquo;Chess</h3>
<div class="outline-text-3" id="text-org9b0a4c9">
<p>
Let&rsquo;s implement a chessboard that shows a given position and can be flipped.  
</p>

<p>
O&rsquo;Chess provides a type representing a position, so our model now
looks like this.  Note how I import <code>Ochess</code> under a different name.
(I&rsquo;ll tell you why in a second.)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Chess</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Ochess</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> orientation <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>color
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
A chessboard has 8 rows commonly called <i>ranks</i> and 8 columns called
<i>files</i>.  For the orientation, the convention is that when viewed from the
perspective of the White player, the White pieces are on the bottom
two ranks in the initial position, and the Black pieces occupy the top
two ranks.  White pieces start on ranks 1 and 2, and Black pieces
start on ranks 7 and 8.  Files are labeled with letters. From White&rsquo;s
point of view, the &rsquo;a&rsquo; file is the leftmost in the starting position,
and the &rsquo;h&rsquo; file is the rightmost.  O&rsquo;Chess represents the board as an
8*8 array of ranks and files where the &rsquo;a&rsquo; file is file 0.
</p>

<p>
I modified <code>msg</code>,  <code>init</code> and <code>update</code> a little to prepare for the
next section already.  We will use the <code>Random_move</code> message with a
&ldquo;payload&rdquo; of a <code>Chess.move</code>, but we don&rsquo;t handle any of the &ldquo;random&rdquo;
messages just yet.  The <code>Flip_board</code> message causes the orientation to
be changed, and we use the <code>with</code> syntax to update the record.
(Fields that are not mentioned remain unchanged.)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>init_position
  <span style="color: #a52a2a;">;</span> orientation <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
      orientation <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>opposite_color model.orientation <span style="color: #a52a2a;">},</span>
    <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<div class="hint">
<p>
You can use a &ldquo;catch-all&rdquo; clause in a <code>match</code> or <code>function</code> pattern
matching by using an anonymous variable, but use it sparingly; it&rsquo;s
better to spell out all the possible patterns.
</p>

</div>

<p>
Now let&rsquo;s try to use O&rsquo;Chess to render the chessboard.  Here&rsquo;s a
<code>board_view</code> function:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">board_view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">files</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> ranks</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> model.orientation <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 7<span style="color: #a52a2a;">],</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">],</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 7<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">rank_view</span><span style="color: #a0522d;"> rank</span> <span style="color: #a52a2a;">=</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">square_view</span><span style="color: #a0522d;"> rank file</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">piece_view</span> <span style="color: #a52a2a;">=</span>
        <span style="color: #a020f0;">match</span> model.position.ar.<span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>rank<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span>piece_type<span style="color: #a52a2a;">,</span> color<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
          node <span style="color: #8b2252;">"cb-piece"</span>
            <span style="color: #a52a2a;">[</span> classList
                <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Chess.</span>string_of_color color<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Chess.</span>string_of_piece_type piece_type<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[]</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #a52a2a;">-&gt;</span> noNode <span style="color: #000000; font-weight: bold;">in</span>
      node <span style="color: #8b2252;">"cb-square"</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span>piece_view<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>square_view rank<span style="color: #a52a2a;">)</span> files
    <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-row"</span> <span style="color: #a52a2a;">[]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #228b22;">List.</span>map rank_view ranks
  <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-board"</span> <span style="color: #a52a2a;">[]</span>
</pre>
</div>

<p>
This might be a lot of code at once, so let&rsquo;s walk through it line by
line.  Depending on the orientation of the chessboard, we need to go
through the files and ranks in different order.  For instance, when
viewing the board from Black&rsquo;s perspective, the leftmost file is the
&rsquo;h&rsquo; file (file 7 in O&rsquo;Chess&rsquo;s representation), but the uppermost rank
is rank 0 (the first rank).
</p>

<p>
We then define the <code>rank_view</code> as a local function, and inside it the
<code>square_view</code> for a given <code>rank</code> and <code>file</code>.  Note how the inner
functions have access to values defined in the outer functions.  We
access the board array with <code>.(file).(rank)</code> and pattern-match on the
square.  If it is empty, we still need to return a DOM node, so we use a placeholder <code>noNode</code>, defined by
Bucklescript-TEA, that will only show up in the DOM as a comment.  If
the square is not empty, we return a custom tag <code>&lt;cb-square&gt;</code>
(browsers don&rsquo;t know this tag, but they will render it and we can use
CSS to style it).  We can always use <code>node</code> to render any tag. 
</p>

<div class="hint">
<p>
Consider the <i>partial application</i> <code>node "cb-piece"</code>. Since <code>node</code> has
the type <code>?namespace:string -&gt; string -&gt; ?key:string -&gt; ?unique:string
-&gt; 'a Vdom.properties -&gt; 'a Vdom.t list -&gt; 'a Vdom.t</code>, it will have
type <code>?key:string -&gt; ?unique:string -&gt; '_a Vdom.properties -&gt; '_a
Vdom.t list -&gt; '_a Vdom.t</code>, just like the functions for &ldquo;normal&rdquo; tags
like <code>div</code>.
</p>

</div>

<p>
We assign CSS classes using the <code>classList</code> function to assign many
classes at once.  This function takes pairs of class names and boolean
flags to determine whether these class names should be &ldquo;switched on&rdquo;
or &ldquo;switched off&rdquo;.  We will use the class names to render the actual
pieces, therefore we encode piece type and color in them.
</p>

<div class="hint">
<p>
There is also <code>class'</code> (not <code>class</code> as that is an OCaml keyword) to set one class, but be
careful and don&rsquo;t use it twice because the second will override the
other.
</p>

</div>

<p>
We then use <code>List.map</code> to construct a rank from the squares, and a
board from the files.  <code>List.map</code> is a staple in functional
programming: takes a function and a list, applies
the function to every item of the list and returns the list of
results.
</p>

<p>
Here&rsquo;s the main view:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> board_view model
    <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Move %d.  It is %s's move."</span>
               model.position.number
               <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> model.position.turn <span style="color: #a020f0;">with</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black"</span>
                                               <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White"</span><span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">|&gt;</span> text
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> button
               <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Flip board"</span> <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">;</span> button
               <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Make a random move!"</span> <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
There&rsquo;s just one thing missing!  We didn&rsquo;t define
<code>Chess.string_of_piece_type</code> and <code>Chess.string_of_color</code> yet.  Instead
of hacking them into O&rsquo;Chess, we&rsquo;ll extend O&rsquo;Chess by opening a
file <code>src/Chess.ml</code>  and adding:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Ochess</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">string_of_piece_type</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">King</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"king"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queen</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"queen"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Rook</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"rook"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Bishop</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"bishop"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Knight</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"knight"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"pawn"</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">string_of_color</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"white"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"black"</span>
</pre>
</div>

<p>
That&rsquo;s it!  The difference between <code>open</code> and <code>include</code> is that
<code>include</code> also passes on all imported values to other modules; so now
we don&rsquo;t need <code>module Chess = Ochess</code> in <code>src/Main.ml</code> anymore. All the
functionality of the <code>Ochess</code> module is now available through the
<code>Chess</code> module.
</p>

<div class="hint">
<p>
An <code>.ml</code> source file defines its own module.  Just take its name and
capitalize the first letter. (Module names in OCaml always start with
an uppercase letter.)  Of course, you can define modules inside
modules; more on that topic later.
</p>

</div>

<p>
See if a chessboard is rendered to the screen.  Or rather, check the
developer tools to see if anything shows up in the DOM tree.  If
there&rsquo;s the structure of a chessboard, let&rsquo;s move on to styling the
board.
</p>

<p>
I used CSS for styling that was inspired by a popular <a href="https://github.com/oakmac/chessboardjs">JS chessboard</a>.
If you need more inspiration, you should also look at <a href="https://github.com/ornicar/chessground">Chessground</a>, the
library used by the open-source, donation-based free <a href="https://lichess.org">Lichess</a> internet
chess server.  Put this in a file <code>release/css/board.css</code>:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">cb-board </span>{
    <span style="color: #a020f0;">display</span>: inline-block;
    <span style="color: #a020f0;">border</span>: 1px solid <span style="color: #ffffff; background-color: #444;">#444</span>;
    <span style="color: #a020f0;">box-sizing</span>: content-box;
    <span style="color: #a020f0;">width</span>: 480px;
    <span style="color: #a020f0;">height</span>: 480px;
}

<span style="color: #0000ff;">cb-row:after </span>{
    <span style="color: #a020f0;">display</span>: block;
    <span style="color: #a020f0;">clear</span>: both;
}
<span style="color: #0000ff;">cb-row:nth-child(even) cb-square:nth-child(even) </span>{
    <span style="color: #a020f0;">background-color</span>: <span style="color: #000000; background-color: #eeeeee;">#eeeeee</span>;
    <span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #aabbcc;">#aabbcc</span>;
}
<span style="color: #0000ff;">cb-row:nth-child(even) cb-square:nth-child(odd) </span>{
    <span style="color: #a020f0;">background-color</span>: <span style="color: #000000; background-color: #aabbcc;">#aabbcc</span>;
    <span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #eeeeee;">#eeeeee</span>;
}
<span style="color: #0000ff;">cb-row:nth-child(odd) cb-square:nth-child(even) </span>{
    <span style="color: #a020f0;">background-color</span>: <span style="color: #000000; background-color: #aabbcc;">#aabbcc</span>;
    <span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #eeeeee;">#eeeeee</span>;
}
<span style="color: #0000ff;">cb-row:nth-child(odd) cb-square:nth-child(odd) </span>{
    <span style="color: #a020f0;">background-color</span>: <span style="color: #000000; background-color: #eeeeee;">#eeeeee</span>;
    <span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #aabbcc;">#aabbcc</span>;
}

<span style="color: #0000ff;">cb-square </span>{
    <span style="color: #a020f0;">float</span>: left;
    <span style="color: #a020f0;">position</span>: relative;
    <span style="color: #a020f0;">display</span>: inline-block;
    <span style="color: #a020f0;">width</span>: 12.5%;
    <span style="color: #a020f0;">height</span>: 12.5%;
}

<span style="color: #0000ff;">cb-piece </span>{
    <span style="color: #a020f0;">position</span>: absolute;
    <span style="color: #a020f0;">bottom</span>: 0;
    <span style="color: #a020f0;">left</span>: 0;
    <span style="color: #a020f0;">width</span>: 100%;
    <span style="color: #a020f0;">height</span>: 100%;
    <span style="color: #a020f0;">background-size</span>: cover;
    <span style="color: #a020f0;">z-index</span>: 1;
}

<span style="color: #0000ff;">cb-piece.white.king </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/wK.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.white.queen </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/wQ.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.white.rook </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/wR.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.white.bishop </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/wB.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.white.knight </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/wN.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.white.pawn </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/wP.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.black.king </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/bK.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.black.queen </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/bQ.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.black.rook </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/bR.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.black.bishop </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/bB.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.black.knight </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/bN.svg"</span>);
}
<span style="color: #0000ff;">cb-piece.black.pawn </span>{
    <span style="color: #a020f0;">background-image</span>: url(<span style="color: #8b2252;">"/img/pieces/bP.svg"</span>);
}
</pre>
</div>

<p>
I won&rsquo;t go into detail about everything, but notice how the
checkerboard pattern is achieved by the use of <code>:nth-child(even)</code> and
<code>:nth-child(odd)</code> pseudo selectors, and how the pieces images are
inserted depending on the class names that we set.  
</p>

<p>
Don&rsquo;t forget to mention the stylesheet in the <code>&lt;head&gt;</code> of
<code>release/index.html</code>:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">link</span> <span style="color: #a0522d;">rel</span>=<span style="color: #8b2252;">"stylesheet"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/css"</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"css/board.css"</span>&gt;
</pre>
</div>

<p>
Now we only need
piece files.  I used the GFDL/GPL/BSD-licenced <a href="https://en.wikipedia.org/wiki/User:Cburnett/GFDL_images/Chess">pieces by Colin M.L.
Burnett</a> designed for Wikipedia.  Here are <a href="https://github.com/oakmac/chessboardjs/tree/master/website/img/chesspieces">some more alternatives</a>.
Drop them in the directory <code>release/img</code> and you should be good to go!
</p>
</div>
</div>

<div id="outline-container-org061b9cf" class="outline-3">
<h3 id="org061b9cf">Your first commands: Random moves</h3>
<div class="outline-text-3" id="text-org061b9cf">
<p>
Now let&rsquo;s wire our &ldquo;random&rdquo; messages.  We have message <code>Random_button</code>
that is triggered when the user clicks the button.  Because all side
effects are managed by TEA, and random number generation is a side
effect, we have to wrap it into a command that will return a message.
We want the message to return a chess move, hence our <code>msg</code> type:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move
</pre>
</div>

<p>
Without further ado, here&rsquo;s your first command:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status model.position <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
        move_list
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>length
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>int 0
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>generate
          <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">random_number</span> <span style="color: #a52a2a;">-&gt;</span>
             <span style="color: #228b22;">List.</span>nth move_list random_number <span style="color: #a52a2a;">|&gt;</span> random_move<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
When the <code>Random_button</code> is received, the model is unchanged, so it is
returned as is, but a command is issued.  This is a tricky one, so
let&rsquo;s examine it:  First, we ask O&rsquo;Chess about the status of the game.
The return value is a variant type that&rsquo;s either <code>Play move_list</code>
(the game is ongoing, and there are legal moves to be played in this position) or a result
(that means the game is over).  When the game is not over, we
determine the length of the move list to construct a random number
generator using <code>Random.int</code> (provided by TEA).  Notice how we use
pipes, so it boils down to <code>Random.int 0 (List.length move_list)</code>
(we&rsquo;re asking for a random number between 0 and the length of the
list, i.e. an index).
</p>

<p>
However, we&rsquo;re not allowed to call this
generator directly as that would cause a side effect, so we hand it
off to <code>Random.generate</code> along with a function that creates a message
from the random number.  We use <code>List.nth</code> to extract a move from the
move list and wrap it in a <code>Random_move</code> message.
</p>

<p>
If you&rsquo;re attentive, you notice two things:
</p>

<ul class="org-ul">
<li><code>random_move</code> is suddenly lowercase</li>
<li>the code will not run!</li>
</ul>

<p>
If you think I made a typo and changed <code>random_move</code> into
<code>Random_move</code>, the code will still not run!  That&rsquo;s because
<code>Random_move</code> <i>looks</i> like it&rsquo;s a function that takes an <code>Ochess.move</code>
and turns it into a message, but it&rsquo;s not.  It&rsquo;s a <i>variant
constructor</i>, and they&rsquo;re not the same thing.  But what we need is a
function that takes a move and returns a message.  There are two ways to
work around that:
</p>

<ul class="org-ul">
<li>make a function <code>(fun move -&gt; Random_move move)</code></li>
<li>have Bucklescript auto-generate this function for you</li>
</ul>

<p>
If you&rsquo;re lazy like me, you just need to put a little magic annotation
under your variant type declariations like this:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>
</pre>
</div>

<p>
Now Bucklescript will automatically derive these functions for you
with an initial lowercase letter,
and you can use them like I did above.  In general, <a href="https://bucklescript.github.io/docs/en/interop-cheatsheet.html">Bucklescript annotations</a> are use for BS/JS interop.
</p>

<p>
When the <code>Random_move</code> message comes back, we use O&rsquo;Chess to actually
make the move on the chessboard:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> move <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move model.position move 0 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
(If you&rsquo;re wondering about the 0 at the end of the <code>make_move</code> call,
that&rsquo;s because O&rsquo;Chess also is a chess engine and stores position
evaluation, so it needs to know how to update the position evaluation.
Just disregard it.)
</p>

<p>
Since the model was updated, the <code>view</code> function will rerender the
chessboard. Try it out!  It should look a little like this:
</p>

<p>
<img class="full" width="490" height="570" src="random.gif" />
</p>
</div>
</div>

<div id="outline-container-org0e324ab" class="outline-3">
<h3 id="org0e324ab">Composing views and models</h3>
<div class="outline-text-3" id="text-org0e324ab">
<p>
Let&rsquo;s pull out the code for the chessboard into its own <code>Board</code> module by
refactoring the code.  When you split up TEA code into modules, you
can still applying <i>model-view-update</i> by considering:
</p>

<ul class="org-ul">
<li>What&rsquo;s the data that should be stored in a submodel?  For instance,
our board will have its own model storing the orientation, but not
the position as that is managed by the main app.</li>

<li>What messages should my submodule contain?  Here, <code>Flip_msg</code> clearly
needs to go into the <code>Board</code> module because it will be handled
board-internally.</li>
</ul>

<p>
This way, your architecture will be clean and compositional.
</p>

<p>
Start by pulling out the relevant parts into <code>src/Board.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span>
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> orientation <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>color
  <span style="color: #a52a2a;">}</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> orientation <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
  <span style="color: #a52a2a;">}</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
      orientation <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>opposite_color model.orientation <span style="color: #a52a2a;">},</span>
    <span style="color: #228b22;">Cmd.</span>none


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">flip_button_view</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  button
    <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Flip board"</span> <span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> pos_ar model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">files</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> ranks</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> model.orientation <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 7<span style="color: #a52a2a;">],</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">],</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 7<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">rank_view</span><span style="color: #a0522d;"> rank</span> <span style="color: #a52a2a;">=</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">square_view</span><span style="color: #a0522d;"> rank file</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">piece_view</span> <span style="color: #a52a2a;">=</span>
        <span style="color: #a020f0;">match</span> pos_ar.<span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>rank<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span>piece_type<span style="color: #a52a2a;">,</span> color<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
          node <span style="color: #8b2252;">"cb-piece"</span>
            <span style="color: #a52a2a;">[</span> classList
                <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Chess.</span>string_of_color color<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Chess.</span>string_of_piece_type piece_type<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[]</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #a52a2a;">-&gt;</span> noNode <span style="color: #000000; font-weight: bold;">in</span>
      node <span style="color: #8b2252;">"cb-square"</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span>piece_view<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>square_view rank<span style="color: #a52a2a;">)</span> files
    <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-row"</span> <span style="color: #a52a2a;">[]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #228b22;">List.</span>map rank_view ranks
  <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-board"</span> <span style="color: #a52a2a;">[]</span>

</pre>
</div>

<p>
I also pulled out the &ldquo;flip&rdquo; button so that the main app can choose to
use it or not.
</p>

<p>
What remains in <code>src/Main.ml</code> is:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">App</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Board.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>init_position
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
A board model is now part of the main model.  In order to make our app
aware of board messages, we need to <i>tag</i> them by giving them a dedicated
variant constructor.  The reason is that the type <code>msg</code> is not
compatible with <code>Board.msg</code>.  We cannot just ignore board messages
though &#x2013; since there is only one central message loop, we need to
process them by handing them to <code>Board.update</code>.
</p>

<p>
The <code>update</code> function is a little tricky now. Whenever we receive a
<code>Board_msg</code>, we unwrap it and hand it to <code>Board.update</code>, which will
return a new board model and a command.  However, the command is of
type <code>Board.msg Cmd.t</code> which is not compatible with <code>update</code>&rsquo;s return
type <code>msg Cmd.t</code>.
</p>

<p>
In TEA, there&rsquo;s a clever solution for this problem: we use <code>Cmd.map</code>
to modify the command <code>cmd</code> by tagging every message that it might
return with <code>Board_msg</code> (again, we make use of the auto-derived
function <code>board_msg</code>). 
</p>

<p>
<code>Cmd.map</code>&rsquo;s signature is <code>('a -&gt; 'b) -&gt; 'a Tea.Cmd.t -&gt; 'b Tea.Cmd.t</code>,
meaning that it takes a function that turns messages of type <code>'a</code> into
messages of type <code>'b</code> (the tagging function) and a command triggering
messages of type <code>'a</code> to give us a command triggering messages of type
<code>'b</code>.  In this case, <code>'a</code> is <code>Board.msg</code> and <code>'b</code> is <code>msg</code>.  
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">board</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>update model.board msg <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> board <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>map board_msg cmd
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status model.position <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
        move_list
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>length
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>int 0
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>generate
          <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">random_number</span> <span style="color: #a52a2a;">-&gt;</span>
             <span style="color: #228b22;">List.</span>nth move_list random_number <span style="color: #a52a2a;">|&gt;</span> random_move<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> move <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move model.position move 0 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
A similar workaround is needed in the <code>view</code> function.  Here, we need
to tag any subview that we embed that might trigger a message. (If it
doesn&rsquo;t, we don&rsquo;t need to tag it because OCaml&rsquo;s type inference will
infer a generic type that&rsquo;s compatible with <code>msg</code>, but both
<code>Board.view</code> and <code>Board.flip_button_view do trigger messages of type
~Board.msg</code>.)
</p>

<p>
Bucklescript-TEA provides <code>Vdom.map</code> (also available as <code>App.map</code>),
and since we already opened <code>Tea.App</code>, we can just use it as <code>map</code>.
Its signature is <code>('a -&gt; 'b) -&gt; 'a Vdom.t -&gt; 'b Vdom.t</code>.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Board.</span>view model.position.ar model.board <span style="color: #a52a2a;">|&gt;</span> map board_msg
    <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Move %d.  It is %s's move."</span>
               model.position.number
               <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> model.position.turn <span style="color: #a020f0;">with</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black"</span>
                                               <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White"</span><span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">|&gt;</span> text
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> map board_msg <span style="color: #228b22;">Board.</span>flip_button_view
           <span style="color: #a52a2a;">;</span> button
               <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Make a random move!"</span> <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3342533" class="outline-2">
<h2 id="part-iii"><a id="org3342533"></a>Part III: A drag and drop chessboard</h2>
<div class="outline-text-2" id="text-part-iii">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-org2fba397" class="outline-3">
<h3 id="org2fba397">Drag and drop: defining messages</h3>
<div class="outline-text-3" id="text-org2fba397">
<p>
So that&rsquo;s nice, but why can&rsquo;t I make a move? you ask.  Let&rsquo;s implement
some drag and drop on the board.  It would be nice to get visual
feedback when we &ldquo;lift&rdquo; a piece about what squares it can go.  Also,
only pieces of the side whose turn it is should be able to be lifted.
Let&rsquo;s sketch out some types and messages in <code>src/Board.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Chess</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">size</span> <span style="color: #a52a2a;">=</span> int

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">move'</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Completed_move</span> <span style="color: #a020f0;">of</span> move
  <span style="color: #a52a2a;">|</span> Pawn_will_promote
</pre>
</div>

<p>
This is a helper type that wraps <code>Chess.move</code> because when a pawn is
dropped on the furthest rank, it needs to be promoted to another
piece.  All other piece drops on a possible target complete a move.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">dragging</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span> turn <span style="color: #a52a2a;">:</span> color
                <span style="color: #a52a2a;">;</span> source <span style="color: #a52a2a;">:</span> square
                <span style="color: #a52a2a;">;</span> target <span style="color: #a52a2a;">:</span> square option
                <span style="color: #a52a2a;">;</span> legal_targets <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>square <span style="color: #a52a2a;">*</span> move'<span style="color: #a52a2a;">)</span> list
                <span style="color: #a52a2a;">;</span> initial <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Mouse.</span>position
                <span style="color: #a52a2a;">;</span> offset <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Mouse.</span>position
                <span style="color: #a52a2a;">;</span> coordinates <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Mouse.</span>position
                <span style="color: #a52a2a;">;</span> size <span style="color: #a52a2a;">:</span> size
                <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">state</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> <span style="color: #a020f0;">of</span> dragging
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span>
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">interactable</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_interactable</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Interactable</span> <span style="color: #a020f0;">of</span> color <span style="color: #a52a2a;">*</span> move list
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>
</pre>
</div>

<p>
The state of the board is either &ldquo;dragging&rdquo; or &ldquo;not dragging&rdquo;.  When
dragging, we keep a record of useful info, such as the source square
and the target square.  While moving the piece around, the target
square will be updated.  Since the mouse might not be over a square,
we represent this as a <code>square option</code>. 
</p>

<div class="hint">
<p>
The built-in type <code>option</code>
is used to represent a value that might be absent.  This is a
type-safe way to deal with uncertainty.  Instead of checking for
&ldquo;null&rdquo; or &ldquo;undefined&rdquo;, you pattern match it with <code>Some value</code> or <code>None</code>.
</p>

</div>

<p>
We also keep track of coordinates (with the type <code>TEA.Mouse.position</code>)
and the list of legal targets where the piece may be dropped.  The list of legal target squares as well as what pieces can be interacted with (type <code>interactable</code>) will be supplied from the outside to the <code>view</code> function together with the position. 
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> orientation <span style="color: #a52a2a;">:</span> color
  <span style="color: #a52a2a;">;</span> state <span style="color: #a52a2a;">:</span> state
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">internal_msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_start</span> <span style="color: #a020f0;">of</span> dragging
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drag</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Mouse.</span>position
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drop</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Mouse.</span>position
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Square_entered</span> <span style="color: #a020f0;">of</span> square
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Square_left</span> <span style="color: #a020f0;">of</span> square
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: #a020f0;">of</span> internal_msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a020f0;">of</span> move
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
      orientation <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>opposite_color model.orientation <span style="color: #a52a2a;">},</span>
    <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
The board&rsquo;s model is now composed of orientation and dragging state,
and we distinguish between &ldquo;internal&rdquo; and &ldquo;external&rdquo; messages.  Recall
that there is only one central message loop.  That means the
&ldquo;parent&rdquo; <code>update</code> function will receive the messages that are to be handled
by the children, but it also means it can act on messages that the
children send out.  When the <code>Board</code> module triggers an internal
message, we&rsquo;ll instruct our main <code>update</code> function to just pass the
message on, but we will make sure to handle the <code>Move</code> message when a
move has been made on the board.
</p>

<div class="hint">
<p>
This is a very simple pattern of child-to-parent communication (it has
been called <a href="http://folkertdev.nl/blog/elm-child-parent-communication/">&ldquo;naive&rdquo;</a>), but
not the only possible pattern.  Another way is to change the signature
of <code>Board.update</code> to return an optional message in addition to model
and command.  This has been <a href="http://folkertdev.nl/blog/elm-child-parent-communication/">described for Elm</a> but of course also works
in Bucklescript-TEA.  Another pattern, the &ldquo;translator pattern&rdquo;, also
uses child-internal messages, but adds
a <a href="https://medium.com/@alex.lew/the-translator-pattern-a-model-for-child-to-parent-communication-in-elm-f4bfaa1d3f98">translation function</a> to the &ldquo;tagger&rdquo; to map child messages to different parent
messages. 
</p>

</div>

<p>
We actually need to define the types <code>file</code>, <code>square</code> and <code>rank</code>.  I
like to define types like these even when they&rsquo;re really just
integers, because it makes it easier to understand what&rsquo;s going on
when looking at function signatures and type definitions.  I defined
these types in <code>src/Chess.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">file</span> <span style="color: #a52a2a;">=</span> int
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">rank</span> <span style="color: #a52a2a;">=</span> int
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">square</span> <span style="color: #a52a2a;">=</span> file <span style="color: #a52a2a;">*</span> rank
</pre>
</div>
</div>
</div>

<div id="outline-container-org30f5f69" class="outline-3">
<h3 id="org30f5f69">JSON decoders</h3>
<div class="outline-text-3" id="text-org30f5f69">
<p>
In order to setup our <code>Dragging</code> record, we need to be able to listen
for and decode
mouse events.  Bucklescript-TEA supplies <code>onMouseDown</code>, but it will
not give us access to the event, just the fact that the mouse button
was pressed.  We can listen for arbitrary events on DOM nodes with
<code>onCB</code> which has the signature <code>string -&gt; string -&gt; (Web.Node.event -&gt;
'a option) -&gt; 'a Vdom.property</code>.  The first string argument is the
event to listen for (e.g. <code>mousedown</code> or <code>mousemove</code>), the second is
a key (we will not use it), and the third is the important part: a
function that turns an event into a message option.  If it is <code>Some
msg</code>, <code>msg</code> will be fed into the message loop; if it is <code>None</code>,
nothing happens.
</p>

<p>
If you worked with events before, you know that they
are JSON data.  The problem with JSON is that is untyped, but we need
to assign a type to the data that we want to extract from the event.
</p>

<p>
Here&rsquo;s a typical <code>mousedown</code> event:
</p>

<p>
<img class="full" width="385" height="661" src="mousedown.png" />
</p>


<p>
We don&rsquo;t need all that data, but we also don&rsquo;t want to write a type
that represents the entire data structure.  For instance, to start the
dragging, we only need the position of the mouse on the page, the size
of the square and the offset of the mouse pointer within the square.
</p>

<p>
The TEA way to do extract the relevant data is to use <i>JSON decoders</i>.  A JSON decoder is a
function that takes a JSON object and returns a certain part of it in
a given format.  A decoder is either simple or a combination of other
decoders by means of a <i>combinator</i>.  Bucklescript-TEA ships with a
bunch of decoders that live in the module <code>Tea.Json</code>.  Simple decoder
like <code>int</code> and <code>string</code>, as well as <code>field</code> to access object fields,
are the basic building blocks.
</p>

<p>
Then there are decoders that combine decoders into a bigger decoder
such as <code>map2</code>.  Here are the decoders we will need for the
<code>mousedown</code> and <code>mousemove</code> events:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">cartesian_decoder</span><span style="color: #a0522d;"> field_x field_y</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Json.Decoder</span> <span style="color: #000000; font-weight: bold;">in</span>
  map2 <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x y</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Mouse.</span><span style="color: #a52a2a;">{</span>x<span style="color: #a52a2a;">;</span> y<span style="color: #a52a2a;">})</span>
    <span style="color: #a52a2a;">(</span>field field_x int<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>field field_y int<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">page</span> <span style="color: #a52a2a;">=</span>
  cartesian_decoder <span style="color: #8b2252;">"pageX"</span> <span style="color: #8b2252;">"pageY"</span>
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Json.Decoder.</span>decodeEvent

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">offset_page_size</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Json.Decoder</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">size</span> <span style="color: #a52a2a;">=</span> field <span style="color: #8b2252;">"clientWidth"</span> int <span style="color: #000000; font-weight: bold;">in</span>
  map3
    <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">a b c</span> <span style="color: #a52a2a;">-&gt;</span> a<span style="color: #a52a2a;">,</span> b<span style="color: #a52a2a;">,</span> c<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>cartesian_decoder <span style="color: #8b2252;">"offsetX"</span> <span style="color: #8b2252;">"offsetY"</span><span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>cartesian_decoder <span style="color: #8b2252;">"pageX"</span> <span style="color: #8b2252;">"pageY"</span><span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"target"</span> size<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|&gt;</span> decodeEvent
</pre>
</div>

<p>
The first, <code>cartesian_decoder</code> is a template for arbitrary decoders
with two fields.  It uses two <code>field</code> decoders for the given fields
and returns a record <code>{x; y}</code> (of type <code>Mouse.position</code>, that&rsquo;s why we
have to prefix it with <code>Mouse</code> &#x2013; alternatively, we could open <code>Mouse</code>
or annotate the type explicitly).
Notice how <code>map2</code> takes a function that combines the output of the two
decoders it takes as its other arguments.
</p>

<p>
We use <code>cartesian_decoder</code> to create a decoder for the coordinates
relative to the page.  A decoder itself doesn&rsquo;t decode, it needs to be
supplied as the first argument to <code>Tea.Json.Decoder.decodeEvent</code>.
Hence, <code>page</code> has the signature <code>Web_node.event -&gt;
(Tea.Mouse.position, Tea.Json.Decoder.error) Tea_result.t</code>, in other
words it takes an event and returns either a <code>Mouse.position</code> or an
error.
</p>

<p>
The last decoder is more complicated because it nests decoders.
Notice how the field <code>target</code> is decoded with the decoder <code>size</code>,
which in turn accesses the field <code>clientWidth</code>. 
</p>

<p>
In order to turn the event into a message, we need a function that
decodes the events and puts the relevant data into the payload of the
message.  Here&rsquo;s a generic function that works for any decoder and any
message.  Notice how the <code>result</code> type is similar to <code>option</code>, but
also has information in the event of a decoder error.  We disregard
that and just turn it into an option, and voilà &#x2013; we have the
function we needed!
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">handler</span><span style="color: #a0522d;"> decoder msg event</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> decoder event <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Result.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> result <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>msg result<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Result.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> _ <span style="color: #a52a2a;">-&gt;</span> None
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d49362" class="outline-3">
<h3 id="org1d49362">CSS for drag and drop</h3>
<div class="outline-text-3" id="text-org1d49362">
<p>
Now let&rsquo;s wire it to the squares.  I chose to listen to events on the
squares instead of on the pieces because it simplifies things.  You
see, normally only the topmost DOM element receives mouse events.  So
for instance, when there is a <code>&lt;cb-piece&gt;</code> covering a <code>&lt;cb-square&gt;</code>,
the <code>&lt;cb-piece&gt;</code> will receive all the events.  So far, so good &#x2013;
unfortunately, when the piece is dragged, it will not let any events
go through because it is always under the mouse pointer, so we will
not know when a square is entered or left. 
</p>

<p>
Fortunately, there is a way in CSS to fix this issue: you can tell
elements to receive or to not receive mouse events.  I went the
radical path and just handle all mouse events on the squares.  The
pieces receive no mouse events, and also the squares only receive
events when there is a piece on them, or generally a piece is being
dragged. Here&rsquo;s the CSS you need (in <code>/release/css/board.css</code>):
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">cb-piece </span>{
    <span style="color: #b22222;">/* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*/</span>
    <span style="color: #a020f0;">pointer-events</span>: none;
}
<span style="color: #0000ff;">cb-piece.dragged </span>{
    <span style="color: #a020f0;">z-index</span>: 9;
}
<span style="color: #0000ff;">cb-board.dragging </span>{
    <span style="color: #a020f0;">cursor</span>: pointer;
}
<span style="color: #0000ff;">cb-square:not(:empty) </span>{
    <span style="color: #a020f0;">cursor</span>: pointer;
}
<span style="color: #0000ff;">cb-square.destination </span>{
    <span style="color: #a020f0;">background-image</span>: radial-gradient(<span style="color: #ffffff; background-color: #141e32;">rgba(20,30,50,0.3)</span> 20%, <span style="color: #ffffff; background-color: #000000;">rgba(0,0,0,0)</span> 0);
}
<span style="color: #0000ff;">cb-square.destination:not(:empty) </span>{
    <span style="color: #a020f0;">background-image</span>: radial-gradient(transparent 0%, transparent 80%, <span style="color: #ffffff; background-color: #141e32;">rgba(20,30,50,0.3)</span> 80%);
}
<span style="color: #0000ff;">cb-square.destination.hovering </span>{
    <span style="color: #a020f0;">background-image</span>: linear-gradient(<span style="color: #ffffff; background-color: #141e32;">rgba(20,30,50,0.3)</span>, <span style="color: #ffffff; background-color: #141e32;">rgba(20,30,50,0.3)</span>);
}
<span style="color: #0000ff;">cb-square:empty </span>{
    <span style="color: #a020f0;">pointer-events</span>: none;
}
<span style="color: #0000ff;">cb-board.dragging cb-square </span>{
    <span style="color: #a020f0;">pointer-events</span>: auto;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org10f2a8f" class="outline-3">
<h3 id="org10f2a8f">Starting the drag</h3>
<div class="outline-text-3" id="text-org10f2a8f">
<p>
When the mouse is pressed on an &ldquo;inhabited&rdquo; square with a piece that
belongs to the user whose turn it is, the drag needs to be started.
Here are some helper functions that build the appropriate message
according to how &ldquo;interactable&rdquo; the board is:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">filter_targets</span><span style="color: #a0522d;"> source moves</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">List.</span>filter <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">((</span><span style="color: #a0522d;">s</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> _t</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> _m</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> s <span style="color: #a52a2a;">=</span> source<span style="color: #a52a2a;">)</span> moves
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">((</span><span style="color: #a0522d;">_s</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> t</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> m</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> t<span style="color: #a52a2a;">,</span> m<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">completed_move</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_will_promote</span>
  <span style="color: #a52a2a;">|</span> move <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Completed_move</span> move

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">coordinate_pairs</span><span style="color: #a0522d;"> turn move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Chess.</span>coordinate_pairs turn move<span style="color: #a52a2a;">,</span> completed_move move

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_start</span><span style="color: #a0522d;"> interactable</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> interactable <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Interactable</span> <span style="color: #a52a2a;">(</span>turn<span style="color: #a52a2a;">,</span> legal_moves<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>turn<span style="color: #a52a2a;">,</span>
          <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">file rank </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">offset</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> coordinates</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> size</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
            <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span>
              <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_start</span>
                 <span style="color: #a52a2a;">{</span> turn
                 <span style="color: #a52a2a;">;</span> source <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>
                 <span style="color: #a52a2a;">;</span> target <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
                 <span style="color: #a52a2a;">;</span> legal_targets <span style="color: #a52a2a;">=</span>
                     legal_moves
                     <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>coordinate_pairs turn<span style="color: #a52a2a;">)</span>
                     <span style="color: #a52a2a;">|&gt;</span> filter_targets <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span> 
                 <span style="color: #a52a2a;">;</span> initial <span style="color: #a52a2a;">=</span> coordinates
                 <span style="color: #a52a2a;">;</span> offset
                 <span style="color: #a52a2a;">;</span> coordinates
                 <span style="color: #a52a2a;">;</span> size
                 <span style="color: #a52a2a;">}</span> <span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_interactable</span> <span style="color: #a52a2a;">-&gt;</span> None
</pre>
</div>

<p>
When the board is interactable, the function <code>move_start</code> returns
whose turn it is and a function that emits a message when called with
file, rank and the relevant coordinates of the mouse event.  Already
here, moves are filtered by the source square, and the target
coordinates are computed so we will be able to provide visual feedback.
</p>

<p>
The function <code>Chess.coordinate_pairs</code> converts the O&rsquo;Chess move format
into file/rank coordinates.  It&rsquo;s mainly needed because there are some
special moves like castling and pawn promotion.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">home_rank</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 0 <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 7
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">promotion_rank</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 7 <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 0
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">pre_promotion_rank</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 6 <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 1

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">coordinate_pairs</span><span style="color: #a0522d;"> turn</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>4<span style="color: #a52a2a;">,</span> home_rank turn<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>2<span style="color: #a52a2a;">,</span> home_rank turn<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>4<span style="color: #a52a2a;">,</span> home_rank turn<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>6<span style="color: #a52a2a;">,</span> home_rank turn<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion</span> <span style="color: #a52a2a;">(</span>_piece_type<span style="color: #a52a2a;">,</span> s_file<span style="color: #a52a2a;">,</span> t_file<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> pre_promotion_rank turn<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> promotion_rank turn<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">,</span> t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 
    <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
Here&rsquo;s our <code>view</code> function now. 
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> interactable pos_ar model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">files</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> ranks</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> model.orientation <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 7<span style="color: #a52a2a;">],</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">],</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 7<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">drag_transform</span><span style="color: #a0522d;"> drag</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"translate(%dpx,%dpx)"</span> 
      <span style="color: #a52a2a;">(</span>drag.offset.x <span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">(</span>drag.size <span style="color: #a52a2a;">/</span> 2<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">+</span> drag.coordinates.x <span style="color: #a52a2a;">-</span> drag.initial.x<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">(</span>drag.offset.y <span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">(</span>drag.size <span style="color: #a52a2a;">/</span> 2<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">+</span> drag.coordinates.y <span style="color: #a52a2a;">-</span> drag.initial.y<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|&gt;</span>  style <span style="color: #8b2252;">"transform"</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">target_highlight</span><span style="color: #a0522d;"> drag target</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> drag.target <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> square <span style="color: #a020f0;">when</span> square <span style="color: #a52a2a;">=</span> target <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">true</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">false</span>
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">legal_highlight</span><span style="color: #a0522d;"> drag target</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>exists
      <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #a0522d;">square</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> _</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> square <span style="color: #a52a2a;">=</span> target<span style="color: #a52a2a;">)</span> drag.legal_targets <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">rank_view</span><span style="color: #a0522d;"> rank</span> <span style="color: #a52a2a;">=</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">square_view</span><span style="color: #a0522d;"> rank file</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">piece_view</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> listener</span> <span style="color: #a52a2a;">=</span>
        <span style="color: #a020f0;">match</span> pos_ar.<span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>rank<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #a52a2a;">-&gt;</span> noNode<span style="color: #a52a2a;">,</span> noProp
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span>piece_type<span style="color: #a52a2a;">,</span> color<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
          <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">drag_origin</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> transform</span> <span style="color: #a52a2a;">=</span>
            <span style="color: #a020f0;">match</span> model.state <span style="color: #a020f0;">with</span>
            <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a020f0;">when</span> <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> drag.source <span style="color: #a52a2a;">-&gt;</span>
              <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> drag_transform drag
            <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">false</span><span style="color: #a52a2a;">,</span> noProp <span style="color: #000000; font-weight: bold;">in</span>
          node <span style="color: #8b2252;">"cb-piece"</span>
            <span style="color: #a52a2a;">[</span> transform
            <span style="color: #a52a2a;">;</span> classList
                <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Chess.</span>string_of_color color<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Chess.</span>string_of_piece_type piece_type<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"dragged"</span><span style="color: #a52a2a;">,</span> drag_origin
                <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[],</span>
          <span style="color: #a020f0;">match</span> move_start interactable <span style="color: #a020f0;">with</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>turn<span style="color: #a52a2a;">,</span> msg<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">when</span> color <span style="color: #a52a2a;">=</span> turn <span style="color: #a52a2a;">-&gt;</span> 
            onCB <span style="color: #8b2252;">"mousedown"</span> <span style="color: #8b2252;">""</span> <span style="color: #a52a2a;">(</span>msg file rank <span style="color: #a52a2a;">|&gt;</span> handler offset_page_size<span style="color: #a52a2a;">)</span>
          <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> noProp <span style="color: #000000; font-weight: bold;">in</span>
      node <span style="color: #8b2252;">"cb-square"</span>
        <span style="color: #a52a2a;">(</span>listener<span style="color: #a52a2a;">::</span>
         <span style="color: #a020f0;">match</span> model.state <span style="color: #a020f0;">with</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">-&gt;</span>
           <span style="color: #a52a2a;">[</span> classList
               <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"destination"</span><span style="color: #a52a2a;">,</span> legal_highlight drag <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>
               <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"hovering"</span><span style="color: #a52a2a;">,</span> target_highlight drag <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>
               <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">;</span> onMouseEnter <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Square_entered</span> <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)))</span>
           <span style="color: #a52a2a;">;</span> onMouseLeave <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Square_left</span> <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)))</span>
           <span style="color: #a52a2a;">]</span>
         <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[</span>noProp<span style="color: #a52a2a;">;</span> noProp<span style="color: #a52a2a;">;</span> noProp<span style="color: #a52a2a;">])</span>
        <span style="color: #a52a2a;">[</span>piece_view<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>square_view rank<span style="color: #a52a2a;">)</span> files
    <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-row"</span> <span style="color: #a52a2a;">[]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #228b22;">List.</span>map rank_view ranks
  <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-board"</span> <span style="color: #a52a2a;">[]</span>
</pre>
</div>

<p>
I will not explain every single token (you should study it for yourself), but if notice especially the following things:
</p>

<ul class="org-ul">
<li>how CSS <code>transform: translate</code> is used to simulate dragging of the piece;</li>

<li>how the piece is given different properties when it is dragged,
based on pattern matching of <code>model.state</code> (we use a <code>when</code> <i>guard</i> here);</li>

<li>how the <code>msg</code> function is</li>
</ul>
<p>
partially applied with <code>file</code> and <code>rank</code> when the piece is
interactable, and used to dispatch a message upon decoding of the
event;
</p>

<ul class="org-ul">
<li>how we need to use <code>[noProp; noProp; noProp]</code> in one case because
the VDOM implementation of Bucklescript-TEA likes attribute lists to
be always the same length.</li>
</ul>

<p>
This goes together with our <code>update</code> function, which now looks like this:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> msg<span style="color: #a52a2a;">,</span> model.state <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Flip_board</span><span style="color: #a52a2a;">,</span> _ <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
          orientation <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>opposite_color model.orientation <span style="color: #a52a2a;">},</span>
        <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_start</span> drag<span style="color: #a52a2a;">,</span> _ <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drag</span> coordinates<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> <span style="color: #a52a2a;">{</span> drag <span style="color: #a020f0;">with</span> coordinates <span style="color: #a52a2a;">}</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Square_entered</span> square<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span>
                       <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> <span style="color: #a52a2a;">{</span> drag <span style="color: #a020f0;">with</span> target <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> square <span style="color: #a52a2a;">}</span>
        <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Square_left</span> _<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> <span style="color: #a52a2a;">{</span> drag <span style="color: #a020f0;">with</span> target <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">}</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drop</span> _<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> drag.target <span style="color: #a020f0;">with</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> target <span style="color: #a52a2a;">-&gt;</span>
            <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">List.</span>assoc target drag.legal_targets <span style="color: #a020f0;">with</span>
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Completed_move</span> move <span style="color: #a52a2a;">-&gt;</span>
                <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span>
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_will_promote</span> <span style="color: #a52a2a;">-&gt;</span>
                <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
              <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
            <span style="color: #000000; font-weight: bold;">end</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
        <span style="color: #000000; font-weight: bold;">end</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
For now, we will be lazy and not care about pawn promotion.  Any other
move is fine, as long as it&rsquo;s legal, and will trigger a <code>Move</code>
message.  That&rsquo;s possible by issuing a command with <code>Cmd.msg</code> that
throws whatever message we would like into the loop.
</p>

<p>
When the <code>Move_start</code> message is received, the state is set to
<code>Dragging drag</code>.  When the <code>Move_drag</code> message is received, if the
state is <code>Dragging</code>, the <code>drag</code> gets updated with the coordinates.
<code>Square_entered</code> and <code>Square_left</code> update the target square.
But how do we send the message <code>Move_drag</code>?  It needs to be a global
listener.  Here&rsquo;s how <i>subscriptions</i> come into play.
</p>
</div>
</div>

<div id="outline-container-org96f6c47" class="outline-3">
<h3 id="org96f6c47">Your first subscriptions: Mouse events</h3>
<div class="outline-text-3" id="text-org96f6c47">
<p>
We want two global listeners.  They can&rsquo;t be board-local because the
user may move the mouse or even drop a piece outside the board.
Therefore, we register two subscriptions when the board&rsquo;s state is
<code>Dragging _</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">subscriptions</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">match</span> model.state <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> _ <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #228b22;">Sub.</span>batch 
      <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Mouse.</span>moves <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drag</span> x<span style="color: #a52a2a;">))</span>
      <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Mouse.</span>ups  <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drop</span> x<span style="color: #a52a2a;">))</span>
      <span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Sub.</span>none
</pre>
</div>

<p>
These are already &ldquo;pre-decoded&rdquo;, i.e. the <code>Mouse.moves</code> and
<code>Mouse.ups</code> subscriptions of Bucklescript-TEA just pass
coordinates to our messages.  Note how <code>Sub.batch</code> turns a list of
subscriptions into one subscription.
</p>

<p>
The subscriptions need to be wired in <code>src/Main.ml</code> as well:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">subscriptions</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Board.</span>subscriptions model.board <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Sub.</span>map board_msg
</pre>
</div>

<p>
By now, I&rsquo;m sure you notice the <code>map</code> pattern!  Now try moving pieces
around.  Drop them.  Just one thing that&rsquo;s missing:  in <code>src/Main.ml</code>,
we need to pick up the moves. Easy!
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move model.position move 0 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<div class="exercise">
<p>
(Actually, there is one more thing. I leave it to you as an exercise, or you can peek
into my source code &#x2013; we need to pass <code>interactable</code> to <code>Board.view</code>.)
</p>

</div>

<p>
There we go! You can now make moves, as long as they don&rsquo;t involve
pawn promotion. Which brings us to the next topic&#x2026;
</p>
</div>
</div>

<div id="outline-container-org06b3c6b" class="outline-3">
<h3 id="org06b3c6b">Pawn promotion</h3>
<div class="outline-text-3" id="text-org06b3c6b">
<p>
So pawns can only go forward.  When they reach the back rank, they can
be promoted, usually into a queen.  Rarely into a knight, but
sometimes the situation asks for one, and even more rarely into rooks
and bishops.  <a href="https://lichess.org/">Lichess</a> has a very nice solution to presenting this
choice.  It overlays a queen over the promotion square, a knight on
the adjacent square, then a rook, then a bishop.  The most common
choices thus need the least amount of mouse movement.
</p>

<p>
We need more types!  And more messages!  (More types is always the
solution, if you ask me.)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">promoting</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span> turn <span style="color: #a52a2a;">:</span> color
                 <span style="color: #a52a2a;">;</span> source_file <span style="color: #a52a2a;">:</span> file
                 <span style="color: #a52a2a;">;</span> target_file <span style="color: #a52a2a;">:</span> file
                 <span style="color: #a52a2a;">;</span> size <span style="color: #a52a2a;">:</span> size
                 <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">state</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> <span style="color: #a020f0;">of</span> dragging
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promoting</span> <span style="color: #a020f0;">of</span> promoting
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span>
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">internal_msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion_canceled</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_promoted</span> <span style="color: #a020f0;">of</span> piece_type
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>
</pre>
</div>

<p>
And then we will &ldquo;simply&rdquo; update the board state with <code>Promoting</code> and
wait for the user to make a choice:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> msg<span style="color: #a52a2a;">,</span> model.state <span style="color: #a020f0;">with</span>

    <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move_drop</span> _<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Dragging</span> drag <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Js.</span>log drag<span style="color: #a52a2a;">;</span>
        <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> drag.target <span style="color: #a020f0;">with</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> target <span style="color: #a52a2a;">-&gt;</span>
            <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">List.</span>assoc target drag.legal_targets <span style="color: #a020f0;">with</span>
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Completed_move</span> move <span style="color: #a52a2a;">-&gt;</span>
                <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span>
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_will_promote</span> <span style="color: #a52a2a;">-&gt;</span>
                <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
                  state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promoting</span> <span style="color: #a52a2a;">{</span> turn <span style="color: #a52a2a;">=</span> drag.turn
                                    <span style="color: #a52a2a;">;</span> source_file <span style="color: #a52a2a;">=</span> fst drag.source
                                    <span style="color: #a52a2a;">;</span> target_file <span style="color: #a52a2a;">=</span> fst target
                                    <span style="color: #a52a2a;">;</span> size <span style="color: #a52a2a;">=</span> drag.size
                                    <span style="color: #a52a2a;">}</span>
                <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
              <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
            <span style="color: #000000; font-weight: bold;">end</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
        <span style="color: #000000; font-weight: bold;">end</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion_canceled</span><span style="color: #a52a2a;">,</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_promoted</span> piece_type<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promoting</span> promoting <span style="color: #a52a2a;">-&gt;</span>      
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion</span> <span style="color: #a52a2a;">(</span>piece_type<span style="color: #a52a2a;">,</span>
                              promoting.source_file<span style="color: #a52a2a;">,</span>
                              promoting.target_file<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> state <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nothing</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
We will wrap the board together with an overlay of the same size in a
<code>&lt;cb-wrap&gt;</code> element:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> interactable pos_ar model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">promo_view</span><span style="color: #a0522d;"> promoting</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">=</span> promoting.target_file <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">left</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> tops</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.orientation<span style="color: #a52a2a;">,</span> promoting.turn <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 7 <span style="color: #a52a2a;">-</span> file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 7 <span style="color: #a52a2a;">-</span> file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">]</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">promo_piece_view</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">top</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> piece_type</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
      node <span style="color: #8b2252;">"cb-square"</span>
        <span style="color: #a52a2a;">[</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_promoted</span> piece_type<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> onClick
        <span style="color: #a52a2a;">;</span> styles
            <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"left"</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%dpx"</span> <span style="color: #a52a2a;">(</span>left <span style="color: #a52a2a;">*</span> promoting.size<span style="color: #a52a2a;">)</span>
            <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"top"</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%dpx"</span> <span style="color: #a52a2a;">(</span>top <span style="color: #a52a2a;">*</span> promoting.size<span style="color: #a52a2a;">)</span>
            <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> node <span style="color: #8b2252;">"cb-piece"</span>
            <span style="color: #a52a2a;">[</span>classList
               <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Chess.</span>string_of_color promoting.turn<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
               <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Chess.</span>string_of_piece_type piece_type<span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
               <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[]</span>         
        <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #228b22;">List.</span>combine tops <span style="color: #a52a2a;">[</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queen</span><span style="color: #a52a2a;">;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Knight</span><span style="color: #a52a2a;">;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Rook</span><span style="color: #a52a2a;">;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Bishop</span><span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map promo_piece_view
    <span style="color: #a52a2a;">|&gt;</span> node <span style="color: #8b2252;">"cb-promo"</span> <span style="color: #a52a2a;">[</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Internal_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion_canceled</span> <span style="color: #a52a2a;">|&gt;</span> onClick <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  node <span style="color: #8b2252;">"cb-wrap"</span> <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.state <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promoting</span> promoting <span style="color: #a52a2a;">-&gt;</span> promo_view promoting
        <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> noNode <span style="color: #000000; font-weight: bold;">end</span>
    <span style="color: #a52a2a;">;</span> board_view interactable pos_ar model
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
The only tricky thing here is to get all the pieces into the right
place.  We will position them absolutely.  If you were not aware of
<code>List.combine</code>:  it takes two lists of the same length and returns a
list of pairs.  (It&rsquo;s like Python&rsquo;s <code>zip</code>.)
</p>

<p>
The promotion overlay will only be rendered when the board&rsquo;s state is
<code>Promoting</code>.  If the user clicks anywhere but on a piece, the move is
cancelled.  Here&rsquo;s the CSS; it&rsquo;s a slight variation of the Lichess promotion picker.
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">cb-promo </span>{
    <span style="color: #a020f0;">position</span>: absolute;
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #fafafa;">rgba(250,250,250,0.7)</span>;
    <span style="color: #a020f0;">z-index</span>: 2;
}
<span style="color: #0000ff;">cb-promo cb-square </span>{
    <span style="color: #a020f0;">position</span>: absolute;
    <span style="color: #a020f0;">cursor</span>: pointer;
    <span style="color: #a020f0;">border-radius</span>: 50%;
    <span style="color: #a020f0;">background-color</span>: <span style="color: #ffffff; background-color: #b0b0b0;">#b0b0b0</span>;
    <span style="color: #a020f0;">box-sizing</span>: border-box;
    <span style="color: #a020f0;">transition</span>: 0.2s;
}
<span style="color: #0000ff;">cb-promo cb-square cb-piece </span>{
    <span style="color: #a020f0;">transition</span>: 0.2s;
    <span style="color: #a020f0;">transform</span>: scale(0.8);
}
<span style="color: #0000ff;">cb-promo cb-square:hover </span>{
    <span style="color: #a020f0;">background-color</span>: <span style="color: #ffffff; background-color: #d07000;">#d07000</span>;
    <span style="color: #a020f0;">border-radius</span>: 0%;
}
<span style="color: #0000ff;">cb-promo cb-square:hover cb-piece </span>{
    <span style="color: #a020f0;">transform</span>: none;
}
</pre>
</div>

<p>
No changes are required in <code>src/Main.ml</code>;  enjoy your promotion!  (I
promote you from &ldquo;TEA novice&rdquo; to &ldquo;TEA apprentice&rdquo;.)
</p>
</div>
</div>
</div>

<div id="outline-container-org1236f12" class="outline-2">
<h2 id="part-iv"><a id="org1236f12"></a>Part IV: Moving in the move list</h2>
<div class="outline-text-2" id="text-part-iv">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-org7792085" class="outline-3">
<h3 id="org7792085">Motivational move logging</h3>
<div class="outline-text-3" id="text-org7792085">
<p>
Let&rsquo;s refactor a bit before we take care of move logging.  We&rsquo;ll
create a <code>Game</code> module taking care of the position and the move list. 
By now, you
know the drill: model-update-view!
</p>

<p>
Here&rsquo;s the skeleton for <code>src/Game.ml</code>.  I added a list of moves to the
model, and I defined a <code>move</code> to be a record of <code>Chess.move</code> and <code>san</code>
(which stands for &ldquo;standard algebraic notation&rdquo;, the way chessplayers
write down moves).  Later, we will expand this record to hold more
information.  I also added a <code>Take_back</code> message.  When it is
triggered, we try to roll back a move (O&rsquo;Chess positions have a <code>prev</code>
field, which is a <code>Chess.position option</code>).
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">san</span> <span style="color: #a52a2a;">=</span> string

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> move <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>move
  <span style="color: #a52a2a;">;</span> san <span style="color: #a52a2a;">:</span> san
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">:</span> move list
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span>
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>    

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>init_position
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[]</span>
  <span style="color: #a52a2a;">}</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">simple_move</span><span style="color: #a0522d;"> move san</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> move <span style="color: #a52a2a;">=</span> move
  <span style="color: #a52a2a;">;</span> san <span style="color: #a52a2a;">=</span> san
  <span style="color: #a52a2a;">}</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move model.position move 0 <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position
                   <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> simple_move move <span style="color: #8b2252;">"splendid move"</span> <span style="color: #a52a2a;">::</span> model.moves
        <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.position.prev<span style="color: #a52a2a;">,</span> model.moves <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> position<span style="color: #a52a2a;">,</span> _hd<span style="color: #a52a2a;">::</span>moves <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_view</span><span style="color: #a0522d;"> move</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text move.san <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Move %d.  It is %s's move."</span>
               model.position.number
               <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> model.position.turn <span style="color: #a020f0;">with</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black"</span>
                                               <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White"</span><span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">|&gt;</span> text
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">List.</span>rev_map move_view model.moves <span style="color: #a52a2a;">|&gt;</span> ul <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Our move logging is admittedly very simplistic, but very motivational!
Every move is a splendid move!.   Since we log moves by appending to
the front of the list (that&rsquo;s more efficient because OCaml lists are
pairs of head and tail, and adding to the end takes time proportional to
the length of the list), we use <code>List.rev_map</code> to show moves in the
right order.  (Not that it would make any difference&#x2026; yet.)
</p>

<p>
The typical boilerplate to wire together the modules in <code>Main.ml</code>:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> game <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Board.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Game.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> game <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Game.</span>init
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
Note how in the update function, we pass the &ldquo;interesting&rdquo; messages
from the board around by just putting it back into the loop with a
different tag (actually, it&rsquo;s <code>Board.Move</code> when it comes in and
<code>Game.Move</code> when it goes back out&#x2026; that&rsquo;s not the same!) Also, we
just lump it together with <code>Random_move</code>.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> move <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Cmd.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">board</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>update model.board msg <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> board <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>map board_msg cmd
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Game.</span>update model.game msg <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> game <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>map game_msg cmd
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status model.game.position <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
        move_list
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>length
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>int 0
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>generate
          <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">random_number</span> <span style="color: #a52a2a;">-&gt;</span>
             <span style="color: #228b22;">List.</span>nth move_list random_number <span style="color: #a52a2a;">|&gt;</span> random_move<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<div class="exercise">
<p>
Exercise: Sending a new message like this is a little inefficient. 
Rewrite the code so that the
message is directly handled by <code>Game.update</code>.
</p>

</div>

<p>
The <code>view</code> function sends a <code>Game_msg Take_back</code> when the
corresponding button is clicked:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">interactable</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status model.game.position <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Interactable</span> <span style="color: #a52a2a;">(</span>model.game.position.turn<span style="color: #a52a2a;">,</span> move_list<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_interactable</span> <span style="color: #000000; font-weight: bold;">in</span>
  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Board.</span>view interactable model.game.position.ar model.board <span style="color: #a52a2a;">|&gt;</span> map board_msg
    <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> map board_msg <span style="color: #228b22;">Board.</span>flip_button_view
           <span style="color: #a52a2a;">;</span> button
               <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Make a random move!"</span> <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">;</span> button
               <span style="color: #a52a2a;">[</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Take back"</span> <span style="color: #a52a2a;">]</span>
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Game.</span>view model.game
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Now you can make moves and take them back, and they&rsquo;re all splendid.
</p>
</div>
</div>

<div id="outline-container-orgcbed727" class="outline-3">
<h3 id="orgcbed727">Move logging like chessplayers do</h3>
<div class="outline-text-3" id="text-orgcbed727">
<p>
This section adds a lot of &ldquo;boring&rdquo; code that is not really related to
frontend development.  If you find boring code boring and are easily
bored, just skip this section and get the code from my repository.
</p>

<p>
Chess players don&rsquo;t find every move splendid, and they have their own
shorthand way
of keeping a record. It&rsquo;s called <a href="https://en.wikipedia.org/wiki/Algebraic_notation_(chess)">Standard Algebraic Notation</a> (SAN).  Instead of writing down the
coordinates of the source square and the target square, they just
write down the type of piece that moved and its destination square,
for instance <code>Qg7</code> for a queen&rsquo;s move to the <code>g7</code> square.  The standard
abbreviations are <code>K, Q, R, B</code> and <code>N</code> (because <code>K</code> is already taken)
for King, Queen, Rook, Bishop and Knight.  Pawn moves are indicated
only by target square, and in the event of a capture, also by the
source file (because pawns capture diagonally). 
</p>

<p>
When a move needs to
be disambiguated because more than one piece of the same type can move
to the same square, the strategy is as follows:
</p>

<ul class="org-ul">
<li>disambiguate by adding a hint for the file of origin: <code>Qg7</code></li>
<li>if it is still ambiguous, try the rank of origin: <code>Qhg7</code></li>
<li>if both strategies fail, add both file and rank: <code>Qh8g7</code>.</li>
</ul>

<p>
The last disambiguation strategy is only needed when a player has
promoted two pawns to queens. (Can you prove that statement?)
</p>

<p>
Finally, if a move is a capture, an <code>x</code> is inserted after the piece
type, if a move puts the opponent&rsquo;s king into check, <code>+</code> is added
to the move, and if a move checkmates the opponent, <code>#</code> is added.  For
pawn moves, <code>x</code> is inserted between original and destination file,
and for pawn promotions, <code>=Q</code> (or type of other piece if not a queen)
is added.  For instance, capturing with a pawn from <code>e7</code> to <code>f8</code>
promoting to a rook and delivering checkmate, is written <code>exf8=R#</code>.
</p>

<p>
There are two special moves, kingside and queenside castle (involving
the king and a rook), written <code>O-O</code> and <code>O-O-O</code> respectively.  Phew, I
think I covered all the little corner cases now, let&rsquo;s see if we can
implement that.  (I actually described SAN as used by the <a href="https://www.chessclub.com/user/help/PGN-spec">PGN format</a>,
which is slightly different from the official SAN as prescribed by the
world chess organization FIDE.)
</p>

<p>
We&rsquo;ll be adding all our code to <code>src/Chess.ml</code>.  Let&rsquo;s start by
defining a few useful types and functions. While I was it, I added
<code>make_move'</code> because I was annoyed of having to type the extra 0 at
the end. (Probably writing the defintion and my justification spoils
all the saved keystrokes now.)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">capture</span> <span style="color: #a52a2a;">=</span> bool
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">promotion</span> <span style="color: #a52a2a;">=</span> piece_type option

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">short_move</span> <span style="color: #a52a2a;">=</span>
  piece_type <span style="color: #a52a2a;">*</span> file option <span style="color: #a52a2a;">*</span> rank option <span style="color: #a52a2a;">*</span> square <span style="color: #a52a2a;">*</span> capture

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">long_move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a020f0;">of</span> piece_type <span style="color: #a52a2a;">*</span> square <span style="color: #a52a2a;">*</span> square <span style="color: #a52a2a;">*</span> capture
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a020f0;">of</span> file <span style="color: #a52a2a;">*</span> square <span style="color: #a52a2a;">*</span> capture <span style="color: #a52a2a;">*</span> promotion
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ochess_move</span> <span style="color: #a020f0;">of</span> move

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">check</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Check</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Checkmate</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_check</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_move'</span><span style="color: #a0522d;"> position move</span> <span style="color: #a52a2a;">=</span>
  make_move position move 0

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">char_of_file</span><span style="color: #a0522d;"> file</span> <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"abcdefgh"</span>.<span style="color: #a52a2a;">[</span>file<span style="color: #a52a2a;">]</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">char_of_rank</span><span style="color: #a0522d;"> rank</span> <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"12345678"</span>.<span style="color: #a52a2a;">[</span>rank<span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
We will use O&rsquo;Chess to compute a list of <code>long_move</code> for a given
position, and then use the disambiguation strategies listed above to
compute a corresponding list of <code>short_move</code>.  File and rank
disambiguation is represented by <code>option</code> types.  Pawn moves always
have the file of origin associated to them in case we need to display
it for a capturing move, and optionally a promotion piece.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">check_or_checkmate</span><span style="color: #a0522d;"> position move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position'</span> <span style="color: #a52a2a;">=</span> make_move' position move <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">checked</span> <span style="color: #a52a2a;">=</span> king_checked position' position'.turn <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a020f0;">if</span> checked <span style="color: #a020f0;">then</span>
    <span style="color: #a020f0;">match</span> legal_moves position' <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Checkmate</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Check</span>
  <span style="color: #a020f0;">else</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_check</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">long_move</span><span style="color: #a0522d;"> position move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> move <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">,</span> t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> position.ar.<span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn</span><span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #b22222;">(* </span><span style="color: #b22222;">a pawn move is a capture if and only if it changes files </span><span style="color: #b22222;">*)</span>
        <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>s_file <span style="color: #a52a2a;">&lt;&gt;</span> t_file<span style="color: #a52a2a;">),</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">capture</span> <span style="color: #a52a2a;">=</span>
          <span style="color: #a020f0;">match</span> position.ar.<span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>t_rank<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">with</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">true</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">false</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> capture<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span>
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ochess_move</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ochess_move</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> s_file<span style="color: #a52a2a;">,</span> t_file<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">t_rank</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.turn <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 7 <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 0 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> <span style="color: #a52a2a;">(</span>s_file <span style="color: #a52a2a;">&lt;&gt;</span> t_file<span style="color: #a52a2a;">),</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> p_type<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
The <code>long_move</code> function converts the O&rsquo;Chess move representation into the
<code>long_move</code> type by adding the <code>capture</code> flag and straightening out a
few kinks.  In particular, it separates <code>Move</code> into <code>Pawn_move</code> and
<code>Piece_move</code>, and groups the latter together with <code>Promotion</code>. There is a case that should
never happen (moving a piece from an empty square), so we raise an
exception (from O&rsquo;Chess) in that case.
</p>

<p>
The <code>check_or_checkmate</code> function returns check/checkmate info for a given move by
trying it in the given position and determining whether after the
move, the other player&rsquo;s king will be in check.  If it is, and there
are no legal moves, it&rsquo;s checkmate!
</p>

<p>
Now we need to compute the disambiguated SAN for a given move.  We
achieve this by trying each disambiguation strategy in turn.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">a short move is good if there is a unique long move that it matches </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">unique</span><span style="color: #a0522d;"> move_list short_move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">List.</span>filter <span style="color: #a52a2a;">(</span>unify_move short_move<span style="color: #a52a2a;">)</span> move_list <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>length <span style="color: #a52a2a;">=</span> 1

<span style="color: #b22222;">(* </span><span style="color: #b22222;">return a short move for a piece move, else None </span><span style="color: #b22222;">*)</span>
<span style="color: #b22222;">(* </span><span style="color: #b22222;">following order of preference: Qg7, Qhg7, Q8g7, Qh8g7 </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">short_move_of_long_move</span><span style="color: #a0522d;"> move_list long_move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">unique'</span> <span style="color: #a52a2a;">=</span> unique move_list <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a020f0;">match</span> long_move <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">),</span> target<span style="color: #a52a2a;">,</span> capture<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">qg7</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> target<span style="color: #a52a2a;">,</span> capture<span style="color: #a52a2a;">)</span>
    <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #a020f0;">if</span> unique' qg7 <span style="color: #a020f0;">then</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> qg7 <span style="color: #a020f0;">else</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">qhg7</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> s_file<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> target<span style="color: #a52a2a;">,</span> capture<span style="color: #a52a2a;">)</span>
      <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #a020f0;">if</span> unique' qhg7 <span style="color: #a020f0;">then</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> qhg7 <span style="color: #a020f0;">else</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">q8g7</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> s_rank<span style="color: #a52a2a;">,</span> target<span style="color: #a52a2a;">,</span> capture<span style="color: #a52a2a;">)</span>
        <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #a020f0;">if</span> unique' q8g7 <span style="color: #a020f0;">then</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> q8g7 <span style="color: #a020f0;">else</span> <span style="color: #b22222;">(* </span><span style="color: #b22222;">Qh8g7 </span><span style="color: #b22222;">*)</span>
          <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> s_file<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> s_rank<span style="color: #a52a2a;">,</span> target<span style="color: #a52a2a;">,</span> capture<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> None
</pre>
</div>

<p>
We still have to write a function <code>unify_move</code> that determines if a <code>short_move</code>
matches a given <code>long_move</code> though.  We just check if the destination
square matches and if the optional disambiguation hints can be unified
(everything can be unified with <code>None</code>).
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">unify</span><span style="color: #a0522d;"> value hint</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> value<span style="color: #a52a2a;">,</span> hint <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> _<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">true</span> <span style="color: #b22222;">(* </span><span style="color: #b22222;">everything unifies with None </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> x<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> y <span style="color: #a020f0;">when</span> x <span style="color: #a52a2a;">=</span> y <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">false</span>

<span style="color: #b22222;">(* </span><span style="color: #b22222;">is the candidate a possible short form of a long move? </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">unify_move</span><span style="color: #a0522d;"> short_move long_move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> long_move <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a52a2a;">(</span>long_p_type<span style="color: #a52a2a;">,</span> long_source<span style="color: #a52a2a;">,</span> long_target<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #b22222;">(* </span><span style="color: #b22222;">capture irrelevant </span><span style="color: #b22222;">*)</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">long_file</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> long_rank</span> <span style="color: #a52a2a;">=</span> long_source <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">short_p_type</span><span style="color: #a52a2a;">,</span> short_file_hint<span style="color: #a52a2a;">,</span> short_rank_hint<span style="color: #a52a2a;">,</span> short_target<span style="color: #a52a2a;">,</span> _
      <span style="color: #a52a2a;">=</span> short_move <span style="color: #000000; font-weight: bold;">in</span>
    short_target <span style="color: #a52a2a;">=</span> long_target <span style="color: #a52a2a;">&amp;&amp;</span>
    short_p_type <span style="color: #a52a2a;">=</span> long_p_type <span style="color: #a52a2a;">&amp;&amp;</span>
    unify long_file short_file_hint <span style="color: #a52a2a;">&amp;&amp;</span>
    unify long_rank short_rank_hint
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">false</span> <span style="color: #b22222;">(* </span><span style="color: #b22222;">we can safely ignore pawn moves and castling </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
Finally, we&rsquo;re ready to calculate the SAN string for a given move. There&rsquo;s a lot of pattern matching going on here, but if you look
closely, you will find that it is a very straightforward formulation
of the SAN definition.  There is a case that should never happen
because when <code>long_move</code> is a <code>Piece_move</code>, the <code>short_move_option</code>
cannot be <code>None</code>, but that is impossible for the compiler to figure
out.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">san_of_move'</span><span style="color: #a0522d;"> position move_list move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">long_move</span> <span style="color: #a52a2a;">=</span> long_move position move
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">check</span> <span style="color: #a52a2a;">=</span> check_or_checkmate position move <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">short_move_option</span> <span style="color: #a52a2a;">=</span> short_move_of_long_move move_list long_move <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> short_move_option<span style="color: #a52a2a;">,</span> long_move <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ochess_move</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"O-O-O"</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ochess_move</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"O-O"</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> capture<span style="color: #a52a2a;">,</span> promotion<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%s%c%c%s"</span> 
        <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">if</span> capture <span style="color: #a020f0;">then</span> char_of_file file <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%cx"</span> <span style="color: #a020f0;">else</span> <span style="color: #8b2252;">""</span><span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>char_of_file t_file<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>char_of_rank t_rank<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> promotion <span style="color: #a020f0;">with</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">""</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> p_type <span style="color: #a52a2a;">-&gt;</span> char_of_piece_type p_type <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"=%c"</span><span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> file_hint<span style="color: #a52a2a;">,</span> rank_hint<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> capture<span style="color: #a52a2a;">),</span> _ <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%c%s%s%s%c%c"</span>
        <span style="color: #a52a2a;">(</span>char_of_piece_type p_type<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> file_hint <span style="color: #a020f0;">with</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">""</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> file <span style="color: #a52a2a;">-&gt;</span> char_of_file file <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%c"</span><span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> rank_hint <span style="color: #a020f0;">with</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">""</span>
         <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> rank <span style="color: #a52a2a;">-&gt;</span> char_of_rank rank <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%c"</span><span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">if</span> capture <span style="color: #a020f0;">then</span> <span style="color: #8b2252;">"x"</span> <span style="color: #a020f0;">else</span> <span style="color: #8b2252;">""</span><span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>char_of_file t_file<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>char_of_rank t_rank<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span>
  <span style="color: #000000; font-weight: bold;">in</span>
  san <span style="color: #a52a2a;">^</span> <span style="color: #a020f0;">match</span> check <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Check</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"+"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Checkmate</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"#"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_check</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">""</span>
</pre>
</div>

<p>
Next, we define two ways of getting SAN strings.  The
<code>legal_moves_with_san</code> function uses O&rsquo;Chess to enumerate the legal moves and generate an
<i>association list</i> of SAN and O&rsquo;Chess moves.  An association list is a
list of (key, value) pairs, and the <code>List</code> module provides some useful
functions for searching the list for a given key and the like.  If
your association lists start getting big, you may want to use a
hashmap or other container that has faster access than O(n), but lists
of legal moves are typically not longer than 30, so it shouldn&rsquo;t be a
problem. 
</p>

<p>
The <code>san_of_move</code> function just returns the SAN string for a given
move in a given position.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">moves_assoc_list</span><span style="color: #a0522d;"> position moves</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">long_moves</span> <span style="color: #a52a2a;">=</span> moves <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>long_move position<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san_moves</span> <span style="color: #a52a2a;">=</span> moves <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>san_of_move' position long_moves<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">List.</span>combine moves san_moves

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">legal_moves_with_san</span><span style="color: #a0522d;"> position</span> <span style="color: #a52a2a;">=</span>
  legal_moves position <span style="color: #a52a2a;">|&gt;</span> moves_assoc_list position

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">san_of_move</span><span style="color: #a0522d;"> position move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move_list</span> <span style="color: #a52a2a;">=</span> legal_moves position <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>long_move position<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
  san_of_move' position move_list move
</pre>
</div>

<p>
Update the <code>update</code> function of <code>src/Game.ml</code>:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>san_of_move model.position move <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move model.position move 0 <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position
                   <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> simple_move move san <span style="color: #a52a2a;">::</span> model.moves
        <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>

    <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
And moves will be logged in Standard Algebraic Notation.
</p>
</div>
</div>

<div id="outline-container-orgc0b51e7" class="outline-3">
<h3 id="orgc0b51e7">A nice-looking move list</h3>
<div class="outline-text-3" id="text-orgc0b51e7">
<p>
Let&rsquo;s make the move list look a little nicer. It is customary to
either group pairs of White and Black moves in a line, or to just run
them in a long line.  Usually, only White moves are numbered.  A move
is then called a &ldquo;ply&rdquo;, and a pair of plies is a &ldquo;move&rdquo;.
</p>

<p>
Here&rsquo;s a better <code>Game.view</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_view</span><span style="color: #a0522d;"> i move</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ply</span> <span style="color: #a52a2a;">=</span> model.position.number <span style="color: #a52a2a;">-</span> i <span style="color: #a52a2a;">-</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">turn</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">if</span> ply <span style="color: #a52a2a;">mod</span> 2 <span style="color: #a52a2a;">=</span> 0 <span style="color: #a020f0;">then</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a020f0;">else</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">number</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>ply <span style="color: #a52a2a;">/</span> 2<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
    li <span style="color: #a52a2a;">[</span> classList <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"move"</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"white"</span><span style="color: #a52a2a;">,</span> turn <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"black"</span><span style="color: #a52a2a;">,</span> turn <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span>
                   <span style="color: #a52a2a;">]</span>
       <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> span <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"number"</span> <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> string_of_int number <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"move"</span> <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> text move.san <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Move %d.  It is %s's move."</span>
               model.position.number
               <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> model.position.turn <span style="color: #a020f0;">with</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black"</span>
                                               <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White"</span><span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">|&gt;</span> text
           <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">List.</span>mapi move_view model.moves
      <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>rev
      <span style="color: #a52a2a;">|&gt;</span> ul <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"moves"</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Notice how we use <code>classList</code> to switch CSS classes on and off.  We&rsquo;ll
just be lazy and number all moves and use CSS to display move numbers
only when they matter.  Start with the following in
<code>release/css/game.css</code> and make sure to include the stylesheet in <code>release/index.html</code>:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">ul.moves </span>{
    <span style="color: #a020f0;">margin</span>: .25em;
    <span style="color: #a020f0;">padding</span>: .25em;
    <span style="color: #a020f0;">list-style-type</span>: none;
}

<span style="color: #0000ff;">li.move </span>{
    <span style="color: #a020f0;">display</span>: inline;
}
<span style="color: #0000ff;">li.move:after </span>{
    <span style="color: #a020f0;">content</span>: <span style="color: #8b2252;">" "</span>;
}

<span style="color: #0000ff;">span.number </span>{
    <span style="color: #a020f0;">color</span>: <span style="color: #ffffff; background-color: #808080;">#808080</span>;
    <span style="color: #a020f0;">display</span>: none;
}
<span style="color: #0000ff;">li.move.white &gt; span.number:after </span>{
    <span style="color: #a020f0;">content</span>: <span style="color: #8b2252;">".\00a0"</span>;
}
<span style="color: #0000ff;">li.move.black &gt; span.number:after </span>{
    <span style="color: #a020f0;">content</span>: <span style="color: #8b2252;">"...\00a0"</span>;
}
<span style="color: #0000ff;">li.move.white &gt; span.number </span>{
    <span style="color: #a020f0;">display</span>: inline;
}

<span style="color: #0000ff;">li.move.highlight &gt; span.move </span>{
  <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #ff0;">#ff0</span>;
}
<span style="color: #0000ff;">span.move </span>{
  <span style="color: #a020f0;">cursor</span>: pointer;
}
</pre>
</div>

<p>
By default, move numbers will not be shown, but for all White moves
that will be overruled.  Later, we will see some more exceptions.  We
add spacing between the moves, and a dot after the move number of a
White move.  Black moves are numbered with three dots.
</p>
</div>
</div>

<div id="outline-container-org62cfee0" class="outline-3">
<h3 id="org62cfee0">A functional move list: zippers!</h3>
<div class="outline-text-3" id="text-org62cfee0">
<p>
Let&rsquo;s add &ldquo;move back&rdquo; and &ldquo;move forward&rdquo; functionality to the move
list view.  &ldquo;Move back&rdquo; is like &ldquo;take back&rdquo;, but without changing the
contents of the list, and &ldquo;move forward&rdquo; is like making the next move
that was already in the list again, also not changing the contents of
the list.  If we had an array that supports fast random access, we
would probably just store the index of the current move, but
</p>

<ul class="org-ul">
<li>that&rsquo;s really boring</li>
<li>linked lists don&rsquo;t offer fast random access, and we need to quickly
access the next move when the &ldquo;move forward&rdquo; button is clicked</li>
<li>we can learn about a cool purely functional data structure called <a href="https://pavpanchekha.com/blog/zippers/huet.html">the
zipper</a>!</li>
</ul>

<p>
Purely functional data structures are immutable, so they fit in nicely
in our immutable world where we don&rsquo;t modify the model in-place but return a
modified version of the model.  If you&rsquo;re interested in other purely
functional data structures, I strongly recommend reading <a href="https://www.cs.cmu.edu/~rwh/theses/okasaki.pdf">Chris Okasaki&rsquo;s thesis</a>.
</p>

<p>
The basic idea of a zipper is that we represent a data structure by a
<i>context</i> (a data structure with a hole) and another data structure to
fill that hole.  This gives us the ability to treat the boundary
between these two as a <i>cursor</i>, and moving the cursor around can be
achieved by making cheap local modifications.  Zippers can be defined
for all algebraic data structures.  In this tutorial, we will first
use list zippers, and in a later part even tree zippers.  You can
learn more about zippers in the excellent <a href="http://learnyouahaskell.com/zippers">&ldquo;Learn You a Haskell for Great Good&rdquo;</a> book, or in its <a href="https://learnyouanelm.github.io/pages/14-zippers.html">Elm adaptation</a>.
</p>

<p>
We know that a list is either the empty list <code>[]</code> or a list made up of
head and tail: <code>hd::tl</code>.  For instance, the list <code>[1; 2; 3; 4]</code> is
actually represented as <code>1::[2::[3::[4::[]]]]</code>.  Navigating in this
list actually means moving into and out of the square brackets!  A
list zipper separates what we&rsquo;ve already seen and what we&rsquo;re about to
see. For instance, a zipper at the position after <code>2</code> would be the
pair of <code>past = 1::[2:: ◊ ]</code> (a list with a &ldquo;hole&rdquo;) and a list to fill
that hole: <code>future = [3; 4]</code>. 
</p>

<p>
But how can we represent a list with a
hole?  The crucial idea here is the &ldquo;reversal of arrows&rdquo;.  Check out
these nice visual explanations for <a href="https://pavpanchekha.com/blog/zippers/huet.html">lists</a> and <a href="http://blog.ezyang.com/2010/04/you-could-have-invented-zippers/">trees</a>.  We turn the
&ldquo;past&rdquo; list around: <code>past = [2; 1]</code>.  Then navigation becomes easy.
Moving back just takes the first element of <code>past</code> and appends it to the <code>future</code>
list.  Moving forward just takes the first element of the <code>future</code>
list and appends it to the <code>past</code> list.
</p>

<p>
Start a new file <code>src/Zipper.ml</code>.  Here&rsquo;s the code for a simple list
zipper:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a context</span> <span style="color: #a52a2a;">=</span> 'a list
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a zipper</span> <span style="color: #a52a2a;">=</span> 'a context <span style="color: #a52a2a;">*</span> 'a list

<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">End_of_list</span>
<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">Beginning_of_list</span>

<span style="color: #b22222;">(* </span><span style="color: #b22222;">move forward and return item and new zipper </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fwd</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">past</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> future <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">End_of_list</span>
  <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>future' <span style="color: #a52a2a;">-&gt;</span> hd<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>hd<span style="color: #a52a2a;">::</span>past<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span>

<span style="color: #b22222;">(* </span><span style="color: #b22222;">move back and return new zipper </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">back</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">past</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> past <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Beginning_of_list</span>
  <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>past' <span style="color: #a52a2a;">-&gt;</span> past'<span style="color: #a52a2a;">,</span> hd<span style="color: #a52a2a;">::</span>future

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fwd'</span><span style="color: #a0522d;"> item </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">past</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> future <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>future' <span style="color: #a020f0;">when</span> hd <span style="color: #a52a2a;">=</span> item <span style="color: #a52a2a;">-&gt;</span> hd<span style="color: #a52a2a;">::</span>past<span style="color: #a52a2a;">,</span> future'
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> item<span style="color: #a52a2a;">::</span>past<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[],</span> <span style="color: #a52a2a;">[]</span>
</pre>
</div>

<p>
That&rsquo;s already all you need for a list zipper.  Notice how we defined
our own exceptions here that we raise when we can&rsquo;t move beyond the
beginning or end of the list.
</p>

<p>
Notice how we use a <i>type variable</i> <code>'a</code> here to keep our
implementation generic.  The functions <code>fwd</code> and <code>back</code>, in addition
to moving the cursor, return the list item over which the cursor was
moved.  The function <code>fwd'</code> is like <code>fwd</code> when the
supplied item matches the next item in the list; otherwise it deletes
the future and starts over.
</p>

<div class="hint">
<p>
I&rsquo;m naming the type <code>'a zipper</code> in this example.  In the real world,
people usually name the &ldquo;important&rdquo; type of a module <code>t</code> because it&rsquo;s
short and an easy to remember convention, so it would
be <code>type 'a t = 'a context * 'a list</code>, referenced from the outside as <code>Zipper.t</code>.
</p>

</div>

<p>
Let&rsquo;s use a list zipper instead of a list to represent the moves in <code>Game.ml</code> now.
Additionally, we now need to keep track of the current ply.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">:</span> move <span style="color: #228b22;">Zipper.</span>zipper
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
In the <code>update</code> function, we now move the zipper back and forward:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>san_of_move model.position move <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move model.position move 0 <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position
                   <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>fwd' <span style="color: #a52a2a;">(</span>simple_move move san<span style="color: #a52a2a;">)</span> model.moves 
        <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.position.prev <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> position <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>back model.moves <span style="color: #000000; font-weight: bold;">in</span>
            <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
          <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Zipper.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Beginning_of_list</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
        <span style="color: #000000; font-weight: bold;">end</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Notice how we catch the exception in the <code>Take_back</code> branch &#x2013; it
should be impossible, but you never know&#x2026;
</p>
</div>
</div>

<div id="outline-container-org10ac139" class="outline-3">
<h3 id="org10ac139">Folding zippers</h3>
<div class="outline-text-3" id="text-org10ac139">
<p>
The move list deserves its own view now.  Don&rsquo;t be intimidated!
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_list_view</span><span style="color: #a0522d;"> ply </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">past</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">home_view</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">highlight offset</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> classList
           <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"move"</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
           <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"highlight"</span><span style="color: #a52a2a;">,</span> highlight <span style="color: #a52a2a;">]</span>
       <span style="color: #a52a2a;">;</span> <span style="color: #a020f0;">if</span> offset <span style="color: #a52a2a;">&lt;&gt;</span> 0 <span style="color: #a020f0;">then</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Jump</span> offset<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">else</span> noProp
       <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> span <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"move"</span> <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">{js|\u2302|js}</span> <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_view</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">?(</span><span style="color: #a0522d;">highlight</span><span style="color: #a52a2a;">=</span><span style="color: #008b8b;">false</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> ply' offset move</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ply</span> <span style="color: #a52a2a;">=</span> ply' <span style="color: #a52a2a;">+</span> offset <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">turn</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">if</span> ply <span style="color: #a52a2a;">mod</span> 2 <span style="color: #a52a2a;">=</span> 0 <span style="color: #a020f0;">then</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a020f0;">else</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">number</span> <span style="color: #a52a2a;">=</span> ply <span style="color: #a52a2a;">/</span> 2 <span style="color: #000000; font-weight: bold;">in</span>
    li <span style="color: #a52a2a;">[</span> classList <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"move"</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"white"</span><span style="color: #a52a2a;">,</span> turn <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"black"</span><span style="color: #a52a2a;">,</span> turn <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"highlight"</span><span style="color: #a52a2a;">,</span> highlight
                   <span style="color: #a52a2a;">]</span>
       <span style="color: #a52a2a;">;</span> <span style="color: #a020f0;">if</span> offset <span style="color: #a52a2a;">&lt;&gt;</span> 0 <span style="color: #a020f0;">then</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Jump</span> offset<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">else</span> noProp
       <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> span <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"number"</span> <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> string_of_int number <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"move"</span> <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> text move.san <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_list_future_view</span><span style="color: #a0522d;"> ply future</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span><span style="color: #a0522d;"> offset cont</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> cont <span style="color: #a52a2a;">[]</span>
      <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>tl <span style="color: #a52a2a;">-&gt;</span>
        loop <span style="color: #a52a2a;">(</span>offset <span style="color: #a52a2a;">+</span> 1<span style="color: #a52a2a;">)</span>
          <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">acc</span> <span style="color: #a52a2a;">-&gt;</span> move_view ply offset hd<span style="color: #a52a2a;">::</span>acc <span style="color: #a52a2a;">|&gt;</span> cont<span style="color: #a52a2a;">)</span> tl <span style="color: #000000; font-weight: bold;">in</span>
    loop 1 <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> x<span style="color: #a52a2a;">)</span> future <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">move_list_past_view</span><span style="color: #a0522d;"> offset acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> acc
    <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>tl <span style="color: #a52a2a;">-&gt;</span>
      loop <span style="color: #a52a2a;">(</span>offset <span style="color: #a52a2a;">-</span> 1<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>move_list_past_view 
           <span style="color: #008b8b;">~highlight</span><span style="color: #a52a2a;">:(</span>offset <span style="color: #a52a2a;">=</span> 0<span style="color: #a52a2a;">)</span> ply offset hd<span style="color: #a52a2a;">::</span>acc<span style="color: #a52a2a;">)</span> tl <span style="color: #000000; font-weight: bold;">in</span>

  home_view <span style="color: #008b8b;">~highlight</span><span style="color: #a52a2a;">:(</span>ply <span style="color: #a52a2a;">=</span> 0<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(-</span>ply<span style="color: #a52a2a;">)::</span>
  move_list_past_view 0 <span style="color: #a52a2a;">(</span>move_list_future_view ply future<span style="color: #a52a2a;">)</span> past
  <span style="color: #a52a2a;">|&gt;</span> ul <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"moves"</span><span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Let&rsquo;s try to make sense out of this.  You will notice that the
<code>move_view</code> has barely changed.  The only thing that changed is that
it has an optional parameter <code>highlight</code> (the last played move should
be highlighted for the user&rsquo;s orientation) with a default argument, and
<code>ply'</code> and <code>offset</code> are given instead of <code>ply</code>.  The idea is that
<code>ply'</code> is always the current ply, and <code>offset</code> is the distance from
the current ply to the move being rendered.  This enables us to add a
<code>Jump</code> message which we will handle to jump around in the game.
</p>

<div class="exercise">
<p>
Exercise: add the <code>Jump</code> message to the <code>msg</code> type.
</p>

</div>

<p>
<code>home_view</code> is similar to <code>move_view</code>.  We will use it to display a
little Unicode glyph at the beginning of the line so the user can jump
to the initial position.  I used Bucklescript&rsquo;s special Unicode
strings here (<code>{js|\u2302|js}</code>), and I chose 2302 because February 23 is my
birthday, and also it looks a little like a house.
</p>

<p>
Now for the scary stuff.  The function <code>move_list_past_view</code> is essentially a
spruced-up version of what the
functional folks call a <i>left fold</i> (or <i>foldl</i>).  OCaml has it in its
standard library under the name <code>List.fold_left</code>.  A left fold, like
the name implies, &ldquo;folds&rdquo; the left over, starting from the first
element.  It needs a binary operation that will always take an <i>accumulator</i>
representing the computation so far, and the next list item. The
result will be the accumulator for the next item, until the list is
exhausted and the accumulator is returned.  I chose to roll my own
fold because I wanted to additionally carry around the offset.  This
function is used to add the &ldquo;past&rdquo; moves in the right order to the
existing list of future moves.
</p>

<div class="exercise">
<p>
Exercise: Work out how you could express <code>move_list_past_view</code> in terms of
<code>List.fold_left</code>.  Hint: combine accumulator and offset counter.
</p>

</div>

<p>
The future moves on the other hand are rendered by a variation of a
<i>right fold</i> (or <i>foldback</i>, or <i>foldr</i>).  Again, OCaml has it in its
standard library, but it is not tail-recursive, and it&rsquo;s very
instructive to write your own, so I rolled my own
tail-recursive fold. 
</p>

<p>
A right fold starts from the &ldquo;right end&rdquo; of the list, applying a
function (let&rsquo;s call it <code>f</code>) over and over again towards the beginning.  The naive,
non-tail-recursive way is to say that <code>fold_right f (hd::tl)</code> can be expressed as
<code>f hd (fold_right f tl)</code>, but this can only be evaluated once the
recursive call returns, so you keep accumulating calls on the stack.
Contrast this with <code>move_list_past_view</code> where the entire return value is a
recursive call, so the function call on the stack can be <i>replaced</i> by
the recursive call and will not accumulate. 
</p>

<p>
In this example, I implemented a right fold with <i>continuation
passing</i>.  Instead of waiting for the recursive call to return and
then apply the function, I tell the recursive call what I would do
with the result if I already had it.  I pass a function <code>cont</code> as an
accumulator!  That&rsquo;s why it starts with the <i>identity function</i> (<code>fun
x -&gt; x</code>) and keeps building bigger functions.  When the list is
exhausted, all that needs to be done is to run this function and we&rsquo;re
done! If you are new to functional programming, and
all of this sounds scary, I recommend the excellent <a href="https://fsharpforfunandprofit.com/posts/recursive-types-and-folds/">series on &ldquo;folds&rdquo; by Scott Wlaschin</a> if you want to understand what is going on
here.
</p>

<div class="hint">
<p>
For short lists, this is not a problem (although we will see an example
where it might matter later), and continuation passing can cause an overhead. but in general you should prefer
tail-recursive functions when you have the chance. Alternatively, you
can reverse the list and then use a left fold.
</p>

</div>

<p>
Handling the <code>Jump</code> message is also done in a recursive fashion:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Jump</span> how_many <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">jump_fwd</span><span style="color: #a0522d;"> position zipper n</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">if</span> n <span style="color: #a52a2a;">&lt;=</span> 0 <span style="color: #a020f0;">then</span> position<span style="color: #a52a2a;">,</span> zipper
      <span style="color: #a020f0;">else</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> zipper'</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>fwd zipper <span style="color: #000000; font-weight: bold;">in</span>
        jump_fwd <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span>make_move' position move.move<span style="color: #a52a2a;">)</span> zipper' <span style="color: #a52a2a;">(</span>n <span style="color: #a52a2a;">-</span> 1<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">jump_back</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">position</span><span style="color: #a52a2a;">:</span><span style="color: #228b22;">Chess.</span><span style="color: #228b22;">position</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> zipper n</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.prev<span style="color: #a52a2a;">,</span> n <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> position'<span style="color: #a52a2a;">,</span> n <span style="color: #a020f0;">when</span> n <span style="color: #a52a2a;">&lt;</span> 0 <span style="color: #a52a2a;">-&gt;</span>
        jump_back position' <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Zipper.</span>back zipper<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(</span>n <span style="color: #a52a2a;">+</span> 1<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> position<span style="color: #a52a2a;">,</span> zipper <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: #a020f0;">match</span> how_many <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> 0 <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> n <span style="color: #a52a2a;">-&gt;</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span>
               <span style="color: #a020f0;">if</span> n <span style="color: #a52a2a;">&gt;</span> 0 <span style="color: #a020f0;">then</span> jump_fwd model.position model.moves n
               <span style="color: #a020f0;">else</span> jump_back model.position model.moves n <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> position<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Now we can use the move list view in the main <code>Game.view</code>.  I also
defined a simple &ldquo;status view&rdquo; that informs the user about what&rsquo;s
going on in the game:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">status_view</span><span style="color: #a0522d;"> position</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  p <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status position <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Win</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black wins by checkmate!"</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Win</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White wins by checkmate!"</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Draw</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"It's a draw!"</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
          <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"It is %s's move,  %d legal moves"</span>
            <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">match</span> position.turn <span style="color: #a020f0;">with</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Black"</span>
                                      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"White"</span><span style="color: #a52a2a;">)</span>
            <span style="color: #a52a2a;">(</span><span style="color: #228b22;">List.</span>length move_list<span style="color: #a52a2a;">)</span>
      <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #a52a2a;">|&gt;</span> text
    <span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  div <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> status_view model.position
    <span style="color: #a52a2a;">;</span> move_list_view model.position.number model.moves
    <span style="color: #a52a2a;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org887763a" class="outline-3">
<h3 id="org887763a">Catching keyboard events</h3>
<div class="outline-text-3" id="text-org887763a">
<p>
After this journey into functional programming, let&rsquo;s turn to a more
frontend-centric topic again: As a cherry on the top, let&rsquo;s assign
keyboard shortcuts so we can navigate the move list with the arrow keys.  Bucklescript-TEA doesn&rsquo;t yet come
with a <code>Keyboard</code> module built-in, so why don&rsquo;t we just create our
own?  Take a look at the <code>Tea.Mouse</code> module to see how it&rsquo;s done.
We&rsquo;ll adapt the function <code>registerGlobal</code> in order to listen to the
<code>keydown</code> event.  Unfortunately, the decoder is hardcoded, so we&rsquo;ll
just copy the function and change it.  Put the following code in
<code>src/Keyboard.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">key_event</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span> key_code <span style="color: #a52a2a;">:</span> int
                 <span style="color: #a52a2a;">;</span> shift <span style="color: #a52a2a;">:</span> bool
                 <span style="color: #a52a2a;">;</span> ctrl <span style="color: #a52a2a;">:</span> bool
                 <span style="color: #a52a2a;">;</span> alt <span style="color: #a52a2a;">:</span> bool
                 <span style="color: #a52a2a;">;</span> meta <span style="color: #a52a2a;">:</span> bool
                 <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">key_event</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea.Json.Decoder</span> <span style="color: #000000; font-weight: bold;">in</span>
  map5
    <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">key_code shift ctrl alt meta</span> <span style="color: #a52a2a;">-&gt;</span>
       <span style="color: #a52a2a;">{</span>key_code<span style="color: #a52a2a;">;</span> shift<span style="color: #a52a2a;">;</span> ctrl<span style="color: #a52a2a;">;</span> alt<span style="color: #a52a2a;">;</span> meta<span style="color: #a52a2a;">})</span>
    <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"keyCode"</span> int<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"shiftKey"</span> bool<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"ctrlKey"</span> bool<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"altKey"</span> bool<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"metaKey"</span> bool<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">registerGlobal</span><span style="color: #a0522d;"> name key tagger</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Vdom</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">enableCall</span><span style="color: #a0522d;"> callbacks_base</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">callbacks</span> <span style="color: #a52a2a;">=</span> <span style="color: #483d8b;">ref</span> callbacks_base <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fn</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">ev</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea_json.Decoder</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea_result</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #a020f0;">match</span> decodeEvent key_event ev <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> pos <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>tagger pos<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">handler</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">EventHandlerCallback</span> <span style="color: #a52a2a;">(</span>key<span style="color: #a52a2a;">,</span> fn<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">elem</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Web_node.</span>document_node <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">cache</span> <span style="color: #a52a2a;">=</span> eventHandler_Register callbacks elem name handler <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">_</span> <span style="color: #a52a2a;">=</span> eventHandler_Unregister elem name cache <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #a52a2a;">()</span>
  <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #228b22;">Tea_sub.</span>registration key enableCall

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">downs</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">?(</span><span style="color: #a0522d;">key</span><span style="color: #a52a2a;">=</span><span style="color: #8b2252;">""</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> tagger</span> <span style="color: #a52a2a;">=</span>
  registerGlobal <span style="color: #8b2252;">"keydown"</span> key tagger
</pre>
</div>

<p>
Whenever a key is pressed, the key code and flags for all the modifier
keys are extracted from the key event and put into a record of type
<code>key_event</code>.  Let&rsquo;s add a subscription to our app and handle some key
presses.  First, the message:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Board.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Game.</span>msg
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Chess.</span>move
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Key_pressed</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Keyboard.</span>key_event
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>
</pre>
</div>

<p>
For the subscriptions, we need to use <code>Sub.batch</code> to be able to listen
for two different subscriptions at the same time:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">subscriptions</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Board.</span>subscriptions model.board <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Sub.</span>map board_msg
  <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Keyboard.</span>downs key_pressed
  <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Sub.</span>batch
</pre>
</div>

<p>
Now we need to handle the interesting keyboard events in the <code>update</code> function. I use a Mac, so I use <kbd>Ctrl-r</kbd> for &ldquo;random
move&rdquo;, <kbd>Ctrl-f</kbd> for &ldquo;forward&rdquo; and <kbd>Ctrl-b</kbd> for &ldquo;take back&rdquo;.  If you need the
<kbd>Ctrl</kbd> key, just adapt the code.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Key_pressed</span> key_event <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> key_event.ctrl<span style="color: #a52a2a;">,</span> key_event.key_code <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> _<span style="color: #a52a2a;">,</span> 37 <span style="color: #b22222;">(* </span><span style="color: #b22222;">left </span><span style="color: #b22222;">*)</span> <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> 66 <span style="color: #b22222;">(* </span><span style="color: #b22222;">Ctrl-b </span><span style="color: #b22222;">*)</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span><span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _<span style="color: #a52a2a;">,</span> 39 <span style="color: #b22222;">(* </span><span style="color: #b22222;">right </span><span style="color: #b22222;">*)</span> <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> 70 <span style="color: #b22222;">(* </span><span style="color: #b22222;">Ctrl-f </span><span style="color: #b22222;">*)</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Forward</span><span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> 82 <span style="color: #b22222;">(* </span><span style="color: #b22222;">Ctrl-r </span><span style="color: #b22222;">*)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf95f7a3" class="outline-2">
<h2 id="part-v"><a id="orgf95f7a3"></a>Part V: AJAX, parsing and responsive CSS</h2>
<div class="outline-text-2" id="text-part-v">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-orge7da95c" class="outline-3">
<h3 id="orge7da95c">HTTP requests (AJAX)</h3>
<div class="outline-text-3" id="text-orge7da95c">
<p>
An SPA is not an SPA without some HTTP requests. Let&rsquo;s get some AJAX action going by making a GET request to an API.
The awesome <a href="https://lichess.org/">Lichess online chess server</a> exposes <a href="https://github.com/ornicar/lila">a public API</a> for all
sorts of requests.  For instance, we can get a JSON record for the
<a href="https://lichess.org/blog/WjRTPScAAJXo7r5s/magnus-carlsen-wins-the-first-lichess-titled-arena">titled player tournament</a> that was hosted recently (won by World
Champion Magnus Carlsen) by accessing
<code>https://lichess.org/api/tournament/GToVqkC9</code>.
</p>

<p>
First, we define some types and messages.  Let&rsquo;s define a variant type
for an HTTP request.  Let&rsquo;s simplify a bit and assume it can have
four states: First <code>Idle</code>, then <code>Loading</code> when the request is sent, and eventually one
of <code>Failed</code> or <code>Received</code> with a payload.  We&rsquo;ll start a file
<code>src/Lichess.ml</code>.  
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_tournament</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament_data</span> <span style="color: #a020f0;">of</span> <span style="color: #a52a2a;">(</span>string<span style="color: #a52a2a;">,</span> string <span style="color: #228b22;">Http.</span>error<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Result.</span>t
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a transfer</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Failed</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Received</span> <span style="color: #a020f0;">of</span> 'a

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">*</span> string list<span style="color: #a52a2a;">)</span> list transfer

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init</span> <span style="color: #a52a2a;">=</span> Idle
</pre>
</div>

<p>
The tournament data that we&rsquo;re interested in is of type <code>(string * string list) list</code> representing a list of games where each game is a
pair of game ID and list of players.
</p>

<p>
<code>Tea.Http</code> gives us all we need to send an HTTP request that will come
back with the message <code>Tournament_data</code> which is a <code>Result.t</code>.  We
previously dealt with result types when we decoded JSON events to
implement drag and drop.  Now, we can build an HTTP request and issue
it as a command. when we receive a <code>Load_tournament</code> message. We will not build a new request while the tournament is loading or
when it was successfully received.  
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_tournament</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Received</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Failed</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">url</span> <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"https://lichess.org/api/tournament/GToVqkC9"</span> <span style="color: #000000; font-weight: bold;">in</span>
        model<span style="color: #a52a2a;">,</span>
        <span style="color: #228b22;">Http.</span>getString url <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Http.</span>send tournament_data
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
It will come back as a <code>Tournament_data</code> message. (In the <code>msg</code>
definition, I got the right type for <code>Tournament_data</code> by
peeking into the signature of <code>Http.send</code>.)  To handle the response
(JSON data serialized as a string), we build a JSON decoder again, and use <code>Tea.Json.Decoder.decodeString</code> to run it.  Notice how we build up
decoders to look deep into the data structure.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> _e<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Failed</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> data<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Json.Decoder</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">players_decoder</span> <span style="color: #a52a2a;">=</span> list string <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">pairing_decoder</span> <span style="color: #a52a2a;">=</span> map2 <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x y</span> <span style="color: #a52a2a;">-&gt;</span> x<span style="color: #a52a2a;">,</span> y<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"id"</span> string<span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">(</span>field <span style="color: #8b2252;">"u"</span> players_decoder<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">list_decoder</span> <span style="color: #a52a2a;">=</span> list pairing_decoder <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">pairings_decoder</span> <span style="color: #a52a2a;">=</span> field <span style="color: #8b2252;">"pairings"</span> list_decoder <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> decodeString pairings_decoder data <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> tournament <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Received</span> tournament
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Failed</span>
    <span style="color: #000000; font-weight: bold;">end</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<div class="exercise">
<p>
Exercise: There are usually two players in a game, but what if the
API returns bad data?  Modify the
JSON decoder so that it checks the list of players for the correct
length.  Hint: Use <code>Json.Decoder.map</code> and raise an exception if
necessary.  You can check the sourcecode of <code>Json.Decoder</code> for a
suitable exception.  Don&rsquo;t worry, the implementation of
<code>Json.Decoder.decodeString</code> will catch any exception you raise and
wrap it in a <code>Result.Error</code>.)
</p>

</div>

<p>
Here&rsquo;s a simple <code>Lichess.view</code> that displays the list of games:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_view</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">id</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> players</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
    td <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text id <span style="color: #a52a2a;">]::</span>
    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">player</span> <span style="color: #a52a2a;">-&gt;</span> td <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text player <span style="color: #a52a2a;">])</span> players
    <span style="color: #a52a2a;">|&gt;</span> tr <span style="color: #a52a2a;">[]</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #a020f0;">match</span> model <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span> <span style="color: #a52a2a;">-&gt;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> button
                     <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_tournament</span> <span style="color: #a52a2a;">]</span>
                     <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"load Lichess tournament"</span> <span style="color: #a52a2a;">]</span>
                 <span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span> <span style="color: #a52a2a;">-&gt;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Loading tournament..."</span> <span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Received</span> tournament <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #228b22;">List.</span>map game_view tournament
    <span style="color: #a52a2a;">|&gt;</span> table <span style="color: #a52a2a;">[]</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Failed</span> <span style="color: #a52a2a;">-&gt;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Tournament could not be loaded."</span>
                   <span style="color: #a52a2a;">;</span> button
                       <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_tournament</span> <span style="color: #a52a2a;">]</span>
                       <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"retry"</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Let&rsquo;s make it look a little nicer by highlighting every other line.  Make a file
called <code>release/css/main.css</code> with the following content, and
reference it in <code>release/index.html</code>:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">table tr:nth-of-type(even) </span>{
    <span style="color: #a020f0;">background-color</span>: <span style="color: #000000; background-color: #e0e0e0;">#e0e0e0</span>;
}
</pre>
</div>

<p>
In <code>src/Main.ml</code>, we just add the tournament view to the main view:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
    <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Game.</span>view model.game <span style="color: #a52a2a;">|&gt;</span> map game_msg
    <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Lichess.</span>view model.lichess <span style="color: #a52a2a;">|&gt;</span> map lichess_msg
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
I&rsquo;ll leave the boilerplate code for integrating the <code>Lichess</code> module
in your model, messages and update function to you.  It should be
second nature by now.
</p>
</div>
</div>

<div id="outline-container-org805e731" class="outline-3">
<h3 id="org805e731">Loading Lichess games</h3>
<div class="outline-text-3" id="text-org805e731">
<p>
Let&rsquo;s add buttons to download games from Lichess.  Add a message
<code>Load_game of string</code> to <code>Lichess.msg</code> and add buttons that trigger
this message with the corresponding game ID to the table.
</p>

<p>
This code should do the trick, right?  We&rsquo;ll just dump the response to
the developer console for now.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">get_game</span><span style="color: #a0522d;"> msg game_id</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Printf.</span>sprintf
    <span style="color: #8b2252;">"https://lichess.org/game/export/%s.pgn"</span> game_id
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Http.</span>getString
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Http.</span>send msg

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_game</span> game_id <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span> get_game game_data game_id
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> e<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Js.</span>log e<span style="color: #a52a2a;">;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> data<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Js.</span>log data<span style="color: #a52a2a;">;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
Head to your browser and click a game&#x2026; and be disappointed.  Check
the developer tools and you will see this error:
</p>

<pre class="example">
Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at https://lichess.org/game/export/PyzfyNUx.pgn. (Reason: CORS header ‘Access-Control-Allow-Origin’ missing).
</pre>

<p>
This part of the Lichess API is not configured to be accessed this way in order to
prevent cross-site scripting security problems. There is a
way around it (called JSONP), but it&rsquo;s painful.  I have an easier
solution for the purpose of this tutorial: let&rsquo;s use a proxy server!
</p>

<p>
I recommend grabbing a copy of the <a href="https://github.com/Freeboard/thingproxy">Thingproxy</a> server and running it on
your own computer.  You can also learn more about the underlying
problem on their website. Since you already have Node.js and NPM or Yarn
installed, it&rsquo;s a matter of 1-2-3:
</p>

<pre class="example">
git clone https://github.com/Freeboard/thingproxy
cd thingproxy
node server.js
</pre>

<p>
And the Thingproxy server is running on <code>http://localhost:3000</code>.  Just
prefix any URL with <code>http://localhost:3000/fetch/</code> and you&rsquo;re good to
go. If you don&rsquo;t have the patience, you can use a hosted proxy server
at <code>https://thingproxy.freeboard.io/fetch/</code>.  I put the following in
my <code>Lichess.ml</code>, and everything worked like a charm.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">proxy</span> <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"http://localhost:3000/fetch/"</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">get_game</span><span style="color: #a0522d;"> msg game_id</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Printf.</span>sprintf
    <span style="color: #8b2252;">"%shttps://lichess.org/game/export/%s.pgn"</span> proxy game_id
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Http.</span>getString
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Http.</span>send msg
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8c8cdc" class="outline-3">
<h3 id="orgb8c8cdc">Parser combinators</h3>
<div class="outline-text-3" id="text-orgb8c8cdc">
<p>
The Lichess API returns games in the most widespread format for storing
chess games, the PGN format.  Unfortunately, PGN is not JSON, but just
a string, so we don&rsquo;t really know what to do with it. 
</p>

<p>
Every once in a while you have to deal with string data instead of
JSON data.  A <i>parser</i> processes a string and analyzes it in order build a data
structure such as an OCaml record, according to a set of rules.  There
are two widespread approaches to writing parsers:  A <i>parser
generator</i> takes as its input a formal grammar written in a certain
format, and returns the actual parser function.  Thus, the generator
needs to be run every time the grammar is changed, but the generated
parser is a standalone function.
</p>

<p>
<i>Parser combinators</i> on the other hand are a convenient way of
building parsers on the fly from
smaller units without having to specify the grammar in a different
language, much like the way we built JSON decoders from building
blocks.  In this part of the tutorial, we will build a parser
using parser combinators for the textual representation of chess games called PGN.
</p>

<p>
We will use a small self-contained parser combinator library and only
touch very lightly on technical matters.
If you&rsquo;re interested in learning more about parser combinators and
maybe even writing your own parser combinator library, you
should check out <a href="https://fsharpforfunandprofit.com/posts/understanding-parser-combinators/">Scott Wlaschin&rsquo;s &ldquo;Understanding Parser Combinators&rdquo;
series</a>.  It&rsquo;s aimed at F#, but F# and OCaml share a lot of similarities.
</p>

<p>
Essentially, a parser combinator is a function that takes parsers as
its arguments and returns a new parser.  A parser, on the other hand,
is a function that takes a string as its argument and returns
something else.  Compare that to what you learned about JSON decoders
earlier.  The combinators that we used there were <code>list</code>, <code>field</code>,
<code>map2</code> etc. 
</p>

<p>
I chose to use an MIT-licenced <a href="https://github.com/pyrocat101/opal">small self-contained
implementation of parser combinators called Opal</a>.  Just drop <code>opal.ml</code>
into your <code>src</code> directory.   (Alternatively, you can pull in my fork as an
NPM package from <code>github:quernd@opal</code>.) To get you acquainted with parser
combinators, let&rsquo;s explore them in an interactive way in the OCaml
toplevel (the read-eval-print loop).  Open a terminal and type <code>ocaml</code>, or better yet, <code>utop</code>.  <a href="https://github.com/diml/utop">Utop</a> offers readline support and
tab-completion, and is more colorful :-)  You can install it through
OPAM with <code>opam install utop</code>.
</p>

<p>
Utop will greet you with a prompt like <code>utop #</code>.  Let&rsquo;s load
<code>src/opal.ml</code>.  Note that you have to end a statement with <code>;;</code> in Utop.
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #a52a2a;">#</span>use <span style="color: #8b2252;">"src/opal.ml"</span><span style="color: #ff4500;">;;</span>
</pre>
</div>

<p>
You&rsquo;ll see the <i>signature</i> of Opal, listing all the types and
functions that it exposes.
</p>

<p>
Are you ready to write your first parser? There it is:
</p>
<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">pgn_capture</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #8b2252;">'x'</span><span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">capture</span> <span style="color: #a52a2a;">:</span> char input <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #a020f0;">fun</span><span style="color: #a52a2a;">&gt;</span>
</pre>
</div>

<p>
OCaml tells you that <code>capture</code> is a function that takes a <code>char input</code>
and either returns <code>None</code> (if the parser failed) or <code>Some</code> pair of
<code>char</code> (the result of applying the parser to the input) and
another <code>char input</code> (the remaining input).  Building a parser using
parser combinators is all about making the parsers work together so
that each parser feeds the remaining input into the next parser.
</p>

<p>
Let&rsquo;s try out our parser. We can convert a string into type <code>input</code> by
using <code>LazyStream.of_string</code>:
</p>
<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #228b22;">LazyStream.</span>of_string<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> bytes <span style="color: #a52a2a;">-&gt;</span> char input <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #a020f0;">fun</span><span style="color: #a52a2a;">&gt;</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #228b22;">LazyStream.</span>of_string <span style="color: #8b2252;">"x"</span> <span style="color: #a52a2a;">|&gt;</span> pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">'x'</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">LazyStream.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Nil</span><span style="color: #a52a2a;">)</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #228b22;">LazyStream.</span>of_string <span style="color: #8b2252;">"xyz"</span> <span style="color: #a52a2a;">|&gt;</span> pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">'x'</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">LazyStream.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Cons</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">'y'</span><span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #a020f0;">lazy</span><span style="color: #a52a2a;">&gt;))</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #228b22;">LazyStream.</span>of_string <span style="color: #8b2252;">"yz"</span> <span style="color: #a52a2a;">|&gt;</span> pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> None
</pre>
</div>

<p>
Looks good! Note that the parser also returns the remainder of the
input.  If we are only interested whether parsing succeeded, we can
use the function <code>parse</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #228b22;">LazyStream.</span>of_string <span style="color: #8b2252;">"xyz"</span> <span style="color: #a52a2a;">|&gt;</span> parse pgn_capture<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> char option <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #8b2252;">'x'</span>
</pre>
</div>

<p>
Here are some more simple parsers, defined by the &ldquo;or&rdquo; combinator
<code>&lt;|&gt;</code>, or by spelling out a list of possible
characters to match. 
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">castle</span> <span style="color: #a52a2a;">=</span> token <span style="color: #8b2252;">"O-O"</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #8b2252;">"O-O-O"</span><span style="color: #ff4500;">;;</span>
utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">piece</span> <span style="color: #a52a2a;">=</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'K'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'Q'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'R'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'B'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'N'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'P'</span><span style="color: #a52a2a;">]</span><span style="color: #ff4500;">;;</span>
utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">=</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'a'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'b'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'c'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'d'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'e'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'f'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'g'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'h'</span><span style="color: #a52a2a;">]</span><span style="color: #ff4500;">;;</span>
utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">rank</span> <span style="color: #a52a2a;">=</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'1'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'2'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'3'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'4'</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">&lt;|&gt;</span> one_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'5'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'6'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'7'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'8'</span><span style="color: #a52a2a;">]</span><span style="color: #ff4500;">;;</span>
</pre>
</div>

<p>
The last one is slightly redundant but very instructive: it uses the <code>&lt;|&gt;</code> combinator (&ldquo;or&rdquo;) to say that the parser
matches either one of the alternatives.  Check the source code of Opal
to see how it works:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a52a2a;">(&lt;|&gt;)</span> x y <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">input</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a020f0;">match</span> x input <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> _ <span style="color: #a020f0;">as</span> ret <span style="color: #a52a2a;">-&gt;</span> ret
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> y input
</pre>
</div>

<p>
Pretty straightforward, right? If the first parser matches, we return
the result, if it doesn&rsquo;t, we hand off the input to the second parser.
Now let&rsquo;s see if we can combine some parsers to match a move.
How do we put one parser after the other?  Here&rsquo;s a bit of
black magic:
</p>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">square</span> <span style="color: #a52a2a;">=</span> file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">-&gt;</span> 
                    rank <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">rank</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span><span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">square</span> <span style="color: #a52a2a;">:</span> char input <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">((</span>char <span style="color: #a52a2a;">*</span> char<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">*</span> char input<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #a020f0;">fun</span><span style="color: #a52a2a;">&gt;</span>
</pre>
</div>

<p>
Whoah! What&rsquo;s going on there?  Let&rsquo;s see.  If you peek at the source
code of Opal, you&rsquo;ll see that the operator <code>&gt;&gt;=</code> takes a parser (<code>file</code>) and a function (<code>fun file -&gt;
...</code>).  It will return a new parser that applies <code>file</code> first and
if it succeeds, hands off the result and the remaining input to the
function.  But wait, <code>fun file -&gt; ...</code> only takes one argument?!
That&rsquo;s because it&rsquo;s <i>partially applied</i>.  It takes one argument now
and the other argument later.  Remember that the second argument is
the remaining input, so it will be a function still looking for
remaining input, hence &#x2013; a parser!
</p>

<p>
However, it doesn&rsquo;t stop here.  Our anonymous function runs runs
<code>rank</code> on the remaining input, and again hands off the result and
the remaining input to another anonymous function.  At some point this
madness has to stop:  the function <code>return</code> takes two arguments.  The
first is supplied by the pair <code>(file, rank)</code>.  The second is the
remaining input that we&rsquo;re still carrying around.  
</p>

<p>
Does it work? Yes it does!
</p>
<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #228b22;">LazyStream.</span>of_string <span style="color: #8b2252;">"e4"</span> <span style="color: #a52a2a;">|&gt;</span> parse square <span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>char <span style="color: #a52a2a;">*</span> char<span style="color: #a52a2a;">)</span> option <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">'e'</span><span style="color: #a52a2a;">,</span> <span style="color: #8b2252;">'4'</span><span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
The combination of
<code>&gt;&gt;=</code> (called <i>bind</i>) and <code>return</code> is extremely powerful!  With <code>&gt;&gt;=</code>,
you run parsers sequentially, and with <code>return</code>, you can specify the
format of the return value.   If all of this went a little too fast
for you, check out <a href="https://fsharpforfunandprofit.com/posts/understanding-parser-combinators/">Scott Wlaschin&rsquo;s excellent tutorial on parser combinators</a>.
</p>

<div class="exercise">
<p>
Exercise:  Implement a parser combinator that takes two parsers
<code>p1</code> and <code>p2</code> and
returns a parser that ignores the result of
the <code>p1</code>, returning only the result of <code>p2</code>.
</p>

</div>
</div>
</div>

<div id="outline-container-org18e4f44" class="outline-3">
<h3 id="org18e4f44">The PGN format</h3>
<div class="outline-text-3" id="text-org18e4f44">
<p>
After this warmup, let&rsquo;s jump right in and start writing a parser for the <a href="https://www.chessclub.com/user/help/PGN-spec">PGN format</a>.
Here&rsquo;s a sample game in PGN from the specification:
</p>

<pre class="example">
[Event "F/S Return Match"]
[Site "Belgrade, Serbia JUG"]
[Date "1992.11.04"]
[Round "29"]
[White "Fischer, Robert J."]
[Black "Spassky, Boris V."]
[Result "1/2-1/2"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 {This opening is called the Ruy Lopez.}
4. Ba4 Nf6 5. O-O Be7 6. Re1 b5 7. Bb3 d6 8. c3 O-O 9. h3 Nb8 10. d4 Nbd7
11. c4 c6 12. cxb5 axb5 13. Nc3 Bb7 14. Bg5 b4 15. Nb1 h6 16. Bh4 c5 17. dxe5
Nxe4 18. Bxe7 Qxe7 19. exd6 Qf6 20. Nbd2 Nxd6 21. Nc4 Nxc4 22. Bxc4 Nb6
23. Ne5 Rae8 24. Bxf7+ Rxf7 25. Nxf7 Rxe1+ 26. Qxe1 Kxf7 27. Qe3 Qg5 28. Qxg5
hxg5 29. b3 Ke6 30. a3 Kd6 31. axb4 cxb4 32. Ra5 Nd5 33. f3 Bc8 34. Kf2 Bf5
35. Ra7 g6 36. Ra6+ Kc5 37. Ke1 Nf4 38. g3 Nxh3 39. Kd2 Kb5 40. Rd6 Kc5 41. Ra6
Nf2 42. g4 Bd3 43. Re6 1/2-1/2
</pre>

<p>
As you can see, the moves are in SAN format which we already know,
followed by a result that&rsquo;s either <code>1/2-1/2</code>, <code>1-0</code>, <code>0-1</code> or <code>*</code>
(unfinished game).
The header of the file is a list of key-value pairs of metadata.
Comments can be inserted after a move enclosed in curly braces. PGN files
may contain variations in parentheses (move sequences that were not
played, but are included for analysis), and variations can contain
comments and they can even be nested.  Some header items can carry
special meaning (for instance, if the game starts from a specified
position).  We&rsquo;ll parse a simplified but almost feature-complete
version of PGN.
</p>
</div>
</div>

<div id="outline-container-org5e72e91" class="outline-3">
<h3 id="org5e72e91">Simple parsers</h3>
<div class="outline-text-3" id="text-org5e72e91">
<p>
Start a new file <code>src/Pgn.ml</code> with
the following. We define a <code>maybe</code> combinator that returns <code>Some x</code>
when the parser <code>p</code> can be applied, otherwise <code>None</code>, and two
exceptions that we might return.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Opal</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">maybe</span><span style="color: #a0522d;"> p</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>p <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> x<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span> return <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>

<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">Ambiguous_move</span>
<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">Parse_error</span>
</pre>
</div>

<p>
This is the structure that we would like to build from the PGN string:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">tag_name</span> <span style="color: #a52a2a;">=</span> string
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">tag_value</span> <span style="color: #a52a2a;">=</span> string
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">tag_pair</span> <span style="color: #a52a2a;">=</span> tag_name <span style="color: #a52a2a;">*</span> tag_value
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">header</span> <span style="color: #a52a2a;">=</span> tag_pair list
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">comment</span> <span style="color: #a52a2a;">=</span> string
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">nag</span> <span style="color: #a52a2a;">=</span> string
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">san</span> <span style="color: #a52a2a;">=</span> string

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">result</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>game_status option

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">piece_type</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>piece_type
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">promotion</span> <span style="color: #a52a2a;">=</span> piece_type

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">file</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>file
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">rank</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>rank

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">square</span> <span style="color: #a52a2a;">=</span> file <span style="color: #a52a2a;">*</span> rank

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a020f0;">of</span> piece_type <span style="color: #a52a2a;">*</span> file option <span style="color: #a52a2a;">*</span> rank option <span style="color: #a52a2a;">*</span> square 
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a020f0;">of</span> file option <span style="color: #a52a2a;">*</span> square <span style="color: #a52a2a;">*</span> promotion option

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">line</span> <span style="color: #a52a2a;">=</span> move list

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">game</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> header <span style="color: #a52a2a;">:</span> header
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">:</span> line
  <span style="color: #a52a2a;">;</span> result <span style="color: #a52a2a;">:</span> result
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
For the header, the specification
says that a tag pair (or key/value pair) &ldquo;is composed of four consecutive tokens: a left bracket token, a
symbol token, a string token, and a right bracket token.&rdquo;  A string is
(slightly simplified) anything between a pair of quotation marks, so we have:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">string</span> <span style="color: #a52a2a;">=</span> none_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'"'</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">|&gt;</span> many
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">tag_key</span> <span style="color: #a52a2a;">=</span> none_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">' '</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">|&gt;</span> many1
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">tag_value</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #8b2252;">'"'</span> <span style="color: #a52a2a;">&gt;&gt;</span> string <span style="color: #a52a2a;">&lt;&lt;</span> exactly <span style="color: #8b2252;">'"'</span>
</pre>
</div>

<p>
The <code>&gt;&gt;</code> combinator ignores everything to its left, while the <code>&lt;&lt;</code>
combinator ignores everything to its right (they point to the
&ldquo;important&rdquo; parser).  We use <code>implode</code> to turn lists of characters
into strings:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">tag_key_value</span> <span style="color: #a52a2a;">=</span>
  tag_key <span style="color: #a52a2a;">&lt;&lt;</span> many1 space <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">tag_key</span> <span style="color: #a52a2a;">-&gt;</span>
  tag_value <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">tag_value</span> <span style="color: #a52a2a;">-&gt;</span>
  return <span style="color: #a52a2a;">(</span>tag_key <span style="color: #a52a2a;">|&gt;</span> implode<span style="color: #a52a2a;">,</span> tag_value <span style="color: #a52a2a;">|&gt;</span> implode<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">tag</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #8b2252;">'['</span> <span style="color: #a52a2a;">&gt;&gt;</span> tag_key_value <span style="color: #a52a2a;">&lt;&lt;</span> exactly <span style="color: #8b2252;">']'</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">header</span> <span style="color: #a52a2a;">=</span> many <span style="color: #a52a2a;">(</span>tag <span style="color: #a52a2a;">&lt;&lt;</span> newline<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
In order to parse moves, we need some simple parsers:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">piece</span> <span style="color: #a52a2a;">=</span>
  one_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'K'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'Q'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'R'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'B'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'N'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'P'</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">=&gt;</span> <span style="color: #228b22;">Chess.</span>piece_type_of_char

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">files</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'a'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'b'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'c'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'d'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'e'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'f'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'g'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'h'</span><span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">List.</span>mapi <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">i file</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>exactly file <span style="color: #a52a2a;">&gt;&gt;</span> return i<span style="color: #a52a2a;">))</span> files <span style="color: #a52a2a;">|&gt;</span> choice

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">rank</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ranks</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'1'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'2'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'3'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'4'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'5'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'6'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'7'</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">'8'</span><span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">List.</span>mapi <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">i file</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>exactly file <span style="color: #a52a2a;">&gt;&gt;</span> return i<span style="color: #a52a2a;">))</span> ranks <span style="color: #a52a2a;">|&gt;</span> choice

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">square</span> <span style="color: #a52a2a;">=</span>
  file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">-&gt;</span> 
  rank <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">rank</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">(</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">capture</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #8b2252;">'x'</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">check</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #8b2252;">'+'</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">checkmate</span> <span style="color: #a52a2a;">=</span> exactly <span style="color: #8b2252;">'#'</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">promotion</span> <span style="color: #a52a2a;">=</span> maybe <span style="color: #a52a2a;">(</span>exactly <span style="color: #8b2252;">'='</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span> piece
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">nag</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>exactly <span style="color: #8b2252;">'$'</span> <span style="color: #a52a2a;">&gt;&gt;</span> <span style="color: #a52a2a;">(</span>many1 digit <span style="color: #a52a2a;">=&gt;</span> implode<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
          <span style="color: #a52a2a;">(</span>many1 <span style="color: #a52a2a;">(</span>one_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'!'</span><span style="color: #a52a2a;">;</span><span style="color: #8b2252;">'?'</span><span style="color: #a52a2a;">])</span> <span style="color: #a52a2a;">=&gt;</span> implode<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
As well as some complicated ones.  Some sources use zeroes instead of
O&rsquo;s for castling, so we&rsquo;ll cover that too.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">nonstandard 0-0 castle </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">castle</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"O-O-O"</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #8b2252;">"0-0-0"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"O-O"</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #8b2252;">"0-0"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span><span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">disambiguated_move</span> <span style="color: #a52a2a;">=</span>
  piece <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">piece</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe rank <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">rank</span> <span style="color: #a52a2a;">-&gt;</span>
  optional capture <span style="color: #a52a2a;">&gt;&gt;</span>
  square <span style="color: #a52a2a;">=&gt;</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a52a2a;">(</span>piece<span style="color: #a52a2a;">,</span> file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">normal_move</span> <span style="color: #a52a2a;">=</span>
  piece <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">piece</span> <span style="color: #a52a2a;">-&gt;</span>
  optional capture <span style="color: #a52a2a;">&gt;&gt;</span>
  square <span style="color: #a52a2a;">=&gt;</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a52a2a;">(</span>piece<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">pawn_move</span> <span style="color: #a52a2a;">=</span>
  square <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe promotion <span style="color: #a52a2a;">=&gt;</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">promotion</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">,</span> promotion<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">pawn_capture_move</span> <span style="color: #a52a2a;">=</span>
  maybe file <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">source_file</span> <span style="color: #a52a2a;">-&gt;</span>
  optional capture <span style="color: #a52a2a;">&gt;&gt;</span>
  square <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">destination</span> <span style="color: #a52a2a;">-&gt;</span>
  maybe promotion <span style="color: #a52a2a;">=&gt;</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">promotion</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span>source_file<span style="color: #a52a2a;">,</span> destination<span style="color: #a52a2a;">,</span> promotion<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>castle <span style="color: #a52a2a;">&lt;|&gt;</span>
   disambiguated_move <span style="color: #a52a2a;">&lt;|&gt;</span>
   normal_move <span style="color: #a52a2a;">&lt;|&gt;</span>
   pawn_move <span style="color: #a52a2a;">&lt;|&gt;</span>
   pawn_capture_move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&lt;&lt;</span>
  optional <span style="color: #a52a2a;">(</span>check <span style="color: #a52a2a;">&lt;|&gt;</span> checkmate<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
The order of parsers to try in <code>pgn_san</code> is actually important, since
otherwise the parser could get stuck when successfully parsing an SAN string
that is a prefix of another SAN string (e.g. <code>Qh8</code> as a prefix of the
disambiguated move <code>Qg7h8</code>.  The problem is that once the parser
successfully parsed a string, it has committed to this choice and will
never take it back.
</p>

<p>
We have to try the most specific parser
first to avoid this trap.  There are parser combinator libraries that
work around this problem by allowing <i>backtracking</i>, but Opal is not one
of those.
</p>

<p>
A comment is just anything between curly braces, and a number is just
a sequence of digits, followed by some pattern of fullstops.  We don&rsquo;t
process the digits further because they don&rsquo;t matter.  We don&rsquo;t trust
them anyway and count moves ourselves :-)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">comment</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>exactly <span style="color: #8b2252;">'{'</span> <span style="color: #a52a2a;">&gt;&gt;</span> many <span style="color: #a52a2a;">(</span>none_of <span style="color: #a52a2a;">[</span><span style="color: #8b2252;">'}'</span><span style="color: #a52a2a;">])</span> <span style="color: #a52a2a;">&lt;&lt;</span> exactly <span style="color: #8b2252;">'}'</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=&gt;</span> implode

<span style="color: #b22222;">(* </span><span style="color: #b22222;">nonstandard `. ...` </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">number</span> <span style="color: #a52a2a;">=</span>
  many1 digit <span style="color: #a52a2a;">&lt;&lt;</span> <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">". ..."</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #8b2252;">"..."</span> <span style="color: #a52a2a;">&lt;|&gt;</span> token <span style="color: #8b2252;">"."</span><span style="color: #a52a2a;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org473ff8a" class="outline-3">
<h3 id="org473ff8a">Mutually recursive parsers</h3>
<div class="outline-text-3" id="text-org473ff8a">
<p>
The last few definitions are tricky because they are <i>mutually
recursive</i>.  Since PGN allows recursive variations, a move can contain
a list of move sequences, so it needs to be defined recursively.  Even
though we don&rsquo;t handle variations yet, we cannot just skip, lets say,
everything from one <code>(</code> token to the next <code>)</code> token, because unlike
comments, variations can be nested.  We would have to at least count
the number of parens to make it work properly by carrying a stack
through the parser. 
</p>

<p>
That&rsquo;s certainly possible, but why don&rsquo;t we just
implement a recursive parser right away?  When we&rsquo;re ready to deal
with variations, it will be easy to adapt.  So here&rsquo;s the deal: we
will properly parse recursive variations, but then we&rsquo;ll ignore them
for now. 
</p>

<p>
Here are the three <i>mutually recursive</i> parsers:  A move is composed
of an arbitrary number of comments, a number, an SAN (which is the
only thing we&rsquo;re interested in), some annotation glyphs, more comments
and the variations list.  (The <code>lexeme</code> combinator is like <code>token</code>,
but allows whitespace around the tokens.)
</p>

<p>
A variation is just a line wrapped in parentheses, while a line is a
list of moves separated by spaces.  
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">move</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span> 
  many <span style="color: #a52a2a;">(</span>lexeme comment<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span>
  maybe <span style="color: #a52a2a;">(</span>lexeme number<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span> lexeme san <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">-&gt;</span>
  many <span style="color: #a52a2a;">(</span>lexeme nag<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span>
  many <span style="color: #a52a2a;">(</span>lexeme comment<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span>
  many <span style="color: #a52a2a;">(</span>lexeme <span style="color: #a52a2a;">(</span>var <span style="color: #a52a2a;">()))</span> <span style="color: #a52a2a;">&gt;&gt;</span>
  return move

<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">var</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  exactly <span style="color: #8b2252;">'('</span> <span style="color: #a52a2a;">&gt;&gt;</span>
  lexeme <span style="color: #a52a2a;">(</span>line <span style="color: #a52a2a;">())</span> <span style="color: #a52a2a;">&lt;&lt;</span>
  lexeme <span style="color: #a52a2a;">(</span>exactly <span style="color: #8b2252;">')'</span><span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">line</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  sep_by <span style="color: #a52a2a;">(</span>move <span style="color: #a52a2a;">())</span> space
</pre>
</div>

<p>
You might be wondering, why do some parsers need an additional <code>()</code>
unit argument?  Try and see what happens if you leave it out.  OCaml
will complain that you cannot define your parsers this way.  The
easiest way to see this is to try to substitute a parser definition in
the right-hand side of another parser definition.  The parser
<code>move</code> makes use of <code>var</code>, so you could try to inline that because it&rsquo;s
just a definition.  But
then <code>var</code> relies on <code>line</code>, and <code>line</code> is defined in
terms of <code>move</code>.  You&rsquo;re caught in an infinite loop!  By giving the
parsers an additional argument, you delay the evaluation, and the
definition is sound.
</p>

<p>
The remainder of the PGN parser is just the result and wrapping
everything up nicely:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">nonstandard 1/2 </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">result</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"1-0"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Win</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span><span style="color: #a52a2a;">)))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"1/2-1/2"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Draw</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"1/2"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Draw</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"0-1"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Win</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span><span style="color: #a52a2a;">)))</span> <span style="color: #a52a2a;">&lt;|&gt;</span>
  <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"*"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">)</span>

<span style="color: #b22222;">(* </span><span style="color: #b22222;">nonstandard non-required newline </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span> <span style="color: #a52a2a;">=</span>
  lexeme header <span style="color: #a52a2a;">&lt;&lt;</span> <span style="color: #a52a2a;">(</span>maybe newline<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">header</span> <span style="color: #a52a2a;">-&gt;</span>
  line <span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">&lt;&lt;</span> spaces <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">-&gt;</span>
  result <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">result</span> <span style="color: #a52a2a;">-&gt;</span> return <span style="color: #a52a2a;">{</span> header<span style="color: #a52a2a;">;</span> moves<span style="color: #a52a2a;">;</span> result <span style="color: #a52a2a;">}</span>
</pre>
</div>

<div class="hint">
<p>
When we need to qualify a variant constructor by adding the module
name (like <code>Chess.Win</code>), the compiler may be able to infer other
types without annotation, simply because they have to match.  By
qualifying <code>Win</code>, you
don&rsquo;t have to qualify either <code>White</code>, <code>Draw</code> nor <code>Black</code>.
</p>

</div>
</div>
</div>

<div id="outline-container-org2a3b424" class="outline-3">
<h3 id="org2a3b424">From PGN to game zipper</h3>
<div class="outline-text-3" id="text-org2a3b424">
<p>
Finally we need a function that turns the parsed PGN into a game
zipper.  In order to compute a move from an SAN, we compute all the
moves that the SAN is compatible with.  If that&rsquo;s more than one, we
raise an exception because the move is ambiguous.  If it&rsquo;s zero, then
the move is illegal. In order to find the moves that a SAN is
compatible with, we need to do some rather boring case analysis.  I&rsquo;ll
spare you the details and just give you the entire function right
away:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">unify_moves</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">position</span><span style="color: #a52a2a;">:</span><span style="color: #228b22;">Chess.</span><span style="color: #228b22;">position</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> pgn_move move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> pgn_move<span style="color: #a52a2a;">,</span> move <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Queenside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Kingside_castle</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> p_type<span style="color: #a52a2a;">),</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Promotion</span> <span style="color: #a52a2a;">(</span>p_type'<span style="color: #a52a2a;">,</span> s_file'<span style="color: #a52a2a;">,</span> t_file'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">promo_rank</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.turn <span style="color: #a020f0;">with</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 0 <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 7
    <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">s_rank'</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.turn <span style="color: #a020f0;">with</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> 1 <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> 6 <span style="color: #000000; font-weight: bold;">in</span>
    position.ar.<span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn</span><span style="color: #a52a2a;">,</span> position.turn<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&amp;&amp;</span>
    <span style="color: #228b22;">Chess.</span>unify s_file' s_file <span style="color: #a52a2a;">&amp;&amp;</span> t_file' <span style="color: #a52a2a;">=</span> t_file <span style="color: #a52a2a;">&amp;&amp;</span>
    promo_rank <span style="color: #a52a2a;">=</span> t_rank <span style="color: #a52a2a;">&amp;&amp;</span> p_type' <span style="color: #a52a2a;">=</span> p_type
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn_move</span> <span style="color: #a52a2a;">(</span>s_file<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">),</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">),</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">,</span> s_rank'<span style="color: #a52a2a;">,</span> t_file'<span style="color: #a52a2a;">,</span> t_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    position.ar.<span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Pawn</span><span style="color: #a52a2a;">,</span> position.turn<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&amp;&amp;</span>
    <span style="color: #228b22;">Chess.</span>unify s_file' s_file <span style="color: #a52a2a;">&amp;&amp;</span> t_file' <span style="color: #a52a2a;">=</span> t_file <span style="color: #a52a2a;">&amp;&amp;</span> t_rank' <span style="color: #a52a2a;">=</span> t_rank
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece_move</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> s_file<span style="color: #a52a2a;">,</span> s_rank<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>t_file<span style="color: #a52a2a;">,</span> t_rank<span style="color: #a52a2a;">)),</span>
    <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">,</span> s_rank'<span style="color: #a52a2a;">,</span> t_file'<span style="color: #a52a2a;">,</span> t_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    position.ar.<span style="color: #a52a2a;">(</span>s_file'<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>s_rank'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span>p_type<span style="color: #a52a2a;">,</span> position.turn<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&amp;&amp;</span>
    <span style="color: #228b22;">Chess.</span>unify s_file' s_file <span style="color: #a52a2a;">&amp;&amp;</span> <span style="color: #228b22;">Chess.</span>unify s_rank' s_rank <span style="color: #a52a2a;">&amp;&amp;</span>
    t_file' <span style="color: #a52a2a;">=</span> t_file <span style="color: #a52a2a;">&amp;&amp;</span> t_rank' <span style="color: #a52a2a;">=</span> t_rank    
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #008b8b;">false</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_of_pgn_move</span><span style="color: #a0522d;"> position move</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>legal_moves position <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">possible_moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>filter <span style="color: #a52a2a;">(</span>unify_moves position move<span style="color: #a52a2a;">)</span> moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a020f0;">match</span> possible_moves <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[</span>move'<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">-&gt;</span> move'
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ambiguous_move</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">parse_pgn</span><span style="color: #a0522d;"> s</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">LazyStream.</span>of_string s <span style="color: #a52a2a;">|&gt;</span> parse game
</pre>
</div>

<p>
A game zipper is easily obtained by just following along the parsed
list of SANs, carrying the position in an accumulator.
Remember that <code>List.fold_left</code> takes as its first argument a function
that maps the current accumulator and a list item to the next
accumulator (the function <code>make_pgn_move</code>).  The initial accumulator is an
empty game zipper.  Put this in <code>src/Game.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_of_pgn</span><span style="color: #a0522d;"> string</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_pgn_move</span><span style="color: #a0522d;"> model pgn_move</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Pgn.</span>move_of_pgn_move model.position pgn_move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>san_of_move model.position move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move' model.position move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>fwd' <span style="color: #a52a2a;">(</span>simple_move move san<span style="color: #a52a2a;">)</span> model.moves <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> position<span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Pgn.</span>parse_pgn string <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> pgn_game <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">List.</span>fold_left make_pgn_move init pgn_game.moves<span style="color: #a52a2a;">)</span>
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> None
</pre>
</div>

<p>
Now let&rsquo;s add some basic functionality to <code>src/Main.ml</code>.  We will
parse the Lichess PGN and display it in the move list. Here&rsquo;s the
<code>Lichess_msg</code> part of the <code>update</code> function.  
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">external</span> <span style="color: #0000ff;">alert</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">-&gt;</span> unit<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"alert"</span> <span style="color: #483d8b;">[@@bs.val]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> _<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">-&gt;</span>
    alert <span style="color: #8b2252;">"Game could not be loaded!"</span><span style="color: #a52a2a;">;</span>
    model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> data<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Game.</span>game_of_pgn data <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> game <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> game <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> alert <span style="color: #8b2252;">"Game could not be parsed!"</span><span style="color: #a52a2a;">;</span>
        model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">lichess</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>update model.lichess msg <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> lichess <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>map lichess_msg cmd
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
We import an <i>external</i> (Javascript) function by telling Bucklescript
the type that we expect it to have and the global name.  The
<code>[@@bs.val]</code> annotation tells the compiler to do its magic.  Now we
can trigger Javascript alerts just by calling the <code>alert</code> function.
</p>
</div>
</div>

<div id="outline-container-org193b3e7" class="outline-3">
<h3 id="org193b3e7">Responsive CSS</h3>
<div class="outline-text-3" id="text-org193b3e7">
<p>
Now it&rsquo;s a little ugly that the board, the game list, and the
tournament view are displayed on top of each other.  For a narrow
screen, that&rsquo;s okay, but on a wider screen, it makes more sense to put
the views side by side.  This is called a <i>responsive</i> layout and can
be achieved through CSS <i>media queries</i>.  Let&rsquo;s first put some
structure into the DOM in our main <code>view</code> function by using HTML5
tags <code>&lt;main&gt;</code> and <code>&lt;section&gt;</code>.  We&rsquo;ll also assign IDs so we can style
the sections accordingly.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">interactable</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status model.game.position <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Interactable</span> <span style="color: #a52a2a;">(</span>model.game.position.turn<span style="color: #a52a2a;">,</span> move_list<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_interactable</span> <span style="color: #000000; font-weight: bold;">in</span>
  main <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> section <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"board"</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> header_nav_view
        <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Board.</span>view interactable model.game.position.ar model.board
          <span style="color: #a52a2a;">|&gt;</span> map board_msg
        <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Game.</span>status_view model.game.position
        <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> map board_msg <span style="color: #228b22;">Board.</span>flip_button_view
               <span style="color: #a52a2a;">;</span> button
                   <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Random move!"</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">;</span> button
                   <span style="color: #a52a2a;">[</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Take back"</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"game"</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> div <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"scroll"</span> <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Game.</span>view model.game <span style="color: #a52a2a;">|&gt;</span> map game_msg
            <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Lichess.</span>view model.lichess <span style="color: #a52a2a;">|&gt;</span> map lichess_msg
            <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
I also added a &ldquo;header&rdquo; navigation view:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">header_nav_view</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">link</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">?(</span><span style="color: #a0522d;">home</span><span style="color: #a52a2a;">=</span><span style="color: #008b8b;">false</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> link description</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> <span style="color: #a020f0;">if</span> home <span style="color: #a020f0;">then</span> class' <span style="color: #8b2252;">"home"</span> <span style="color: #a020f0;">else</span> noProp <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> a <span style="color: #a52a2a;">[</span> href link <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> text description <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  nav <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"main-nav"</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> link <span style="color: #008b8b;">~home</span><span style="color: #a52a2a;">:</span><span style="color: #008b8b;">true</span> <span style="color: #8b2252;">"#/"</span> <span style="color: #8b2252;">"TEA-Chess"</span>
            <span style="color: #a52a2a;">;</span> link <span style="color: #8b2252;">"https://quernd.github.io/tutorials/tea-chess"</span> <span style="color: #8b2252;">"Tutorial"</span>
            <span style="color: #a52a2a;">;</span> link <span style="color: #8b2252;">"https://github.com/quernd/tea-chess"</span> <span style="color: #8b2252;">"Code"</span>
            <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<div class="hint">
<p>
When you find yourself copy-pasting code, spot the pattern and
implement an abstraction, even if it doesn&rsquo;t seem to be worth the
effort like in the above <code>link</code> example.  You will save time in the
long run when you want to refactor things, because you only need to
change things in one
place.
</p>

</div>

<p>
Here&rsquo;s some basic CSS that uses the modern <a href="https://css-tricks.com/snippets/css/a-guide-to-flexbox/"><i>flexbox</i> approach</a> to
reordering the sections:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">html, body </span>{
    <span style="color: #a020f0;">height</span>: 100%;
    <span style="color: #a020f0;">margin-top</span>: 0px;
    <span style="color: #a020f0;">margin-bottom</span>: 0px;
    <span style="color: #a020f0;">font-size</span>: 100%;
}
<span style="color: #0000ff;">main </span>{
    <span style="color: #a020f0;">display</span>: flex;
    <span style="color: #a020f0;">height</span>: 100%;
    <span style="color: #a020f0;">flex-direction</span>: row;
}
<span style="color: #0000ff;">#board </span>{
    <span style="color: #a020f0;">text-align</span>: center;
}
<span style="color: #0000ff;">#game </span>{
    <span style="color: #a020f0;">overflow-y</span>: hidden;
    <span style="color: #a020f0;">flex</span>: auto;
    <span style="color: #a020f0;">display</span>: flex;
    <span style="color: #a020f0;">flex-direction</span>: column;
}
<span style="color: #0000ff;">nav#main-nav </span>{
    <span style="color: #a020f0;">text-align</span>: left;
    <span style="color: #a020f0;">overflow-x</span>: scroll;
}
<span style="color: #0000ff;">nav ul </span>{
    <span style="color: #a020f0;">padding-left</span>: 0;
}

<span style="color: #0000ff;">nav ul li a </span>{
    <span style="color: #a020f0;">text-decoration</span>: none;
}
<span style="color: #0000ff;">nav ul li </span>{
    <span style="color: #a020f0;">display</span>: inline;
    <span style="color: #a020f0;">padding-left</span>: 1em;
    <span style="color: #a020f0;">padding-right</span>: 1em;
}
<span style="color: #0000ff;">li.home </span>{
    <span style="color: #a020f0;">font-weight</span>: bold;
}
<span style="color: #0000ff;">div.scroll </span>{
    <span style="color: #a020f0;">overflow-y</span>: scroll;
    <span style="color: #a020f0;">flex</span>: auto;
    <span style="color: #a020f0;">padding</span>: .5em;
}
<span style="color: #483d8b;">@media</span> screen and (max-width:648px) and (min-height:480px) {
    <span style="color: #0000ff;">main </span>{
        <span style="color: #a020f0;">flex-direction</span>: column;
    }
}
</pre>
</div>

<p>
A flexbox is defined by setting <code>display: flex</code> on a DOM element.
This makes it a &ldquo;flex container&rdquo;.
Whether to order its children, the &ldquo;flex items&rdquo;, side by side or top to bottom is specified in
the <code>flex-direction</code> attribute.
</p>

<p>
The responsiveness trick is in the last bit where we change <code>flex-direction</code> from
<code>row</code> into <code>column</code> when the screen is not wide enough, but
sufficiently tall.
</p>

<p>
We have nested flexboxes in this example because <code>#game</code> is both an
item and a container.  This way, when the <code>div.scroll</code> overflows, it
will be scrollable independently from other content in <code>#game</code>.
</p>

<p>
We should also take into account that the board needs to be resized
for smaller screens.  Put this into <code>release/css/board.css</code>.  This
makes the board shrink successively when the screen gets smaller.
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #483d8b;">@media</span> screen and (max-width:832px) {
    <span style="color: #0000ff;">cb-board, cb-promo </span>{
        <span style="color: #a020f0;">width</span>: 400px;
        <span style="color: #a020f0;">height</span>: 400px;
    }
}
<span style="color: #483d8b;">@media</span> screen and (max-width:740px) {
    <span style="color: #0000ff;">cb-board, cb-promo </span>{
        <span style="color: #a020f0;">width</span>: 352px;
        <span style="color: #a020f0;">height</span>: 352px;
    }
}
<span style="color: #483d8b;">@media</span> screen and (max-height:740px) {
    <span style="color: #0000ff;">cb-board, cb-promo </span>{
        <span style="color: #a020f0;">width</span>: 352px;
        <span style="color: #a020f0;">height</span>: 352px;
    }
}
<span style="color: #483d8b;">@media</span> screen and (max-width:320px) {
    <span style="color: #0000ff;">cb-board, cb-promo </span>{
        <span style="color: #a020f0;">width</span>: 304px;
        <span style="color: #a020f0;">height</span>: 304px;
    }
}
</pre>
</div>

<p>
Test the code by resizing the browser window.  It should look a little
like this:
</p>

<p>
<img class="full" width="1000" height="640" src="responsive.gif" />
</p>

<p>
Modern browsers also
have a &ldquo;responsive design mode&rdquo; in their developer tools that has
presets for various devices.
</p>
</div>
</div>

<div id="outline-container-org93f2c34" class="outline-3">
<h3 id="org93f2c34">Header and result views</h3>
<div class="outline-text-3" id="text-org93f2c34">
<p>
Let&rsquo;s display some more information about the game.  When we parsed
the PGN files, we also parsed the header and the result.  Let&rsquo;s put
that info on the screen.
</p>

<p>
I changed <code>src/Game.ml</code> to represent header and result in the model:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Chess.</span>position
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">:</span> move <span style="color: #228b22;">Zipper.</span>zipper
  <span style="color: #a52a2a;">;</span> header <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">*</span> string<span style="color: #a52a2a;">)</span> list
  <span style="color: #a52a2a;">;</span> result <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Pgn.</span>result
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>init_position
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>init
  <span style="color: #a52a2a;">;</span> header <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[]</span>
  <span style="color: #a52a2a;">;</span> result <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
And then I just added header and result info when the game is parsed:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_of_pgn</span><span style="color: #a0522d;"> string</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_pgn_move</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">position</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> moves</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> pgn_move</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Pgn.</span>move_of_pgn_move position pgn_move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>san_of_move position move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #228b22;">Chess.</span>make_move' position move<span style="color: #a52a2a;">,</span>
    <span style="color: #228b22;">Zipper.</span>fwd' <span style="color: #a52a2a;">(</span>simple_move move san<span style="color: #a52a2a;">)</span> moves <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Pgn.</span>parse_pgn string <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> pgn_game <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">header</span> <span style="color: #a52a2a;">=</span> pgn_game.header <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">result</span> <span style="color: #a52a2a;">=</span> pgn_game.result <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>fold_left make_pgn_move
            <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span>init_position<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Zipper.</span>init<span style="color: #a52a2a;">)</span> pgn_game.moves <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">{</span> position<span style="color: #a52a2a;">;</span> moves<span style="color: #a52a2a;">;</span> header<span style="color: #a52a2a;">;</span> result <span style="color: #a52a2a;">}</span>
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> None
</pre>
</div>

<p>
The views are pretty straightforward.  I chose to only display the
most important header lines, &ldquo;White&rdquo; and &ldquo;Black&rdquo;, but there is usually more
information in the header.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">header_view</span><span style="color: #a0522d;"> pgn_header</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">key_value_view</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">k</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> v</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> label <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #a52a2a;">[</span> text k <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">|&gt;</span> span <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">]</span>
          <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text v <span style="color: #a52a2a;">]</span>
          <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">List.</span>filter 
    <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #a0522d;">k</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> _</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> k <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"White"</span> <span style="color: #a52a2a;">||</span> k <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"Black"</span><span style="color: #a52a2a;">)</span> pgn_header
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map key_value_view
  <span style="color: #a52a2a;">|&gt;</span> ul <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"pgnheader"</span><span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">string_of_result</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Win</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"1-0"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Win</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"0-1"</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Draw</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"1/2-1/2"</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"*"</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">result_view</span><span style="color: #a0522d;"> result</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  p <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"result"</span><span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> string_of_result result <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  div <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"pgn"</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> header_view model.header
    <span style="color: #a52a2a;">;</span> move_list_view model.position.number model.moves
    <span style="color: #a52a2a;">;</span> result_view model.result
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Here&rsquo;s some CSS to style the header and result:
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff;">ul.pgnheader </span>{
    <span style="color: #a020f0;">list-style-type</span>: none;
}
<span style="color: #0000ff;">ul.pgnheader label </span>{
    <span style="color: #a020f0;">display</span>: block;
}
<span style="color: #0000ff;">ul.pgnheader label span </span>{
    <span style="color: #a020f0;">color</span>: <span style="color: #ffffff; background-color: #008000;">#008000</span>;
    <span style="color: #a020f0;">font-weight</span>: bold;
    <span style="color: #a020f0;">width</span>: 100px;
    <span style="color: #a020f0;">float</span>: left;
    <span style="color: #a020f0;">text-align</span>: right;
}
<span style="color: #0000ff;">ul.pgnheader label span:not(:hover) </span>{
    <span style="color: #a020f0;">white-space</span>: nowrap;
    <span style="color: #a020f0;">overflow</span>: hidden;
    <span style="color: #a020f0;">text-overflow</span>: ellipsis;
}
<span style="color: #0000ff;">ul.pgnheader label span:after </span>{
    <span style="color: #a020f0;">content</span>: <span style="color: #8b2252;">":\00a0"</span>;
}
<span style="color: #0000ff;">.result </span>{
    <span style="color: #a020f0;">font-weight</span>: bold;
    <span style="color: #a020f0;">text-align</span>: center;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org70dacf5" class="outline-2">
<h2 id="part-vi"><a id="org70dacf5"></a>Part VI: Lenses, maps, and functors</h2>
<div class="outline-text-2" id="text-part-vi">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-org130d1f9" class="outline-3">
<h3 id="org130d1f9">A list of games</h3>
<div class="outline-text-3" id="text-org130d1f9">
<p>
It would be nice if the user could switch between games.  Let&rsquo;s add
functionality so that we can have a list of games that can all be
edited separately, and when a game from Lichess is loaded, it doesn&rsquo;t
delete the game that was previously on the screen.
</p>

<p>
The main model could look something like this:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model list
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Lichess.</span>model
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Reset_game</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">New_game</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Switch_game</span> <span style="color: #a020f0;">of</span> int
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span><span style="color: #228b22;">Game.</span>init<span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">=</span> 0
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>init
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
The currently open game can be reset with the <code>Reset_game</code> message, or
a new game can be opened with the <code>New_game</code> message.  Users can
switch between games with the <code>Switch_game</code> message.  The currently
selected game will be represented by the index of the <code>games</code> list.
</p>

<p>
Here&rsquo;s an idea for a &ldquo;games picker&rdquo; that shows a dropdown box to
choose a game.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">games_picker</span><span style="color: #a0522d;"> selected games</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">length</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>length games <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">List.</span>mapi
    <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">i _game</span> <span style="color: #a52a2a;">-&gt;</span>
       option' <span style="color: #a52a2a;">[</span> string_of_int i <span style="color: #a52a2a;">|&gt;</span> value
               <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Attributes.</span>selected <span style="color: #a52a2a;">(</span>selected <span style="color: #a52a2a;">=</span> i<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
         <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Game %d"</span> <span style="color: #a52a2a;">(</span>length <span style="color: #a52a2a;">-</span> i<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">)</span> games
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>rev
  <span style="color: #a52a2a;">|&gt;</span> select <span style="color: #a52a2a;">[</span> onChange <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Switch_game</span> <span style="color: #a52a2a;">(</span>int_of_string x<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
We assume games are always appended to the front of the list, so we
need to reverse it after mapping.  <code>List.mapi</code> maps a list while
supplying the index. Since we&rsquo;re going through the list in reverse, we
subtract the index from the number of games to get the &ldquo;real&rdquo; index in
normal order.  The <code>value</code> attribute contains the payload that will be
passed to the message that is triggered when we pick an option, so we
just store the index there.
</p>

<p>
And here&rsquo;s part of the main <code>view</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
        <span style="color: #a52a2a;">[</span> nav <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> li <span style="color: #a52a2a;">[]</span>
                             <span style="color: #a52a2a;">[</span> games_picker model.selected model.games <span style="color: #a52a2a;">]</span>
                         <span style="color: #a52a2a;">;</span> button
                             <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Reset_game</span> <span style="color: #a52a2a;">]</span>
                             <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"reset game"</span> <span style="color: #a52a2a;">]</span>
                         <span style="color: #a52a2a;">;</span> button
                             <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">New_game</span> <span style="color: #a52a2a;">]</span>
                             <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"new game"</span> <span style="color: #a52a2a;">]</span>
                         <span style="color: #a52a2a;">]</span>
                 <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">;</span> div <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"scroll"</span> <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Game.</span>view <span style="color: #a52a2a;">(</span><span style="color: #228b22;">List.</span>nth model.games model.selected<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> map game_msg
            <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Lichess.</span>view model.lichess <span style="color: #a52a2a;">|&gt;</span> map lichess_msg
            <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
</pre>
</div>

<div class="exercise">
<p>
Exercise: flesh out the app by implementing the <code>Reset_game- and
~New_game</code> messages as well as the <code>Switch_game</code> message.  Also make
sure any Lichess game is appended to the list.
</p>

</div>
</div>
</div>

<div id="outline-container-org48363c4" class="outline-3">
<h3 id="org48363c4">A functional getter/setter: Lens!</h3>
<div class="outline-text-3" id="text-org48363c4">
<p>
If you did the above exercise, you probably realized that a bunch of
things need to be changed.  For instance, handling a <code>Game_msg</code> also
needs to be modifiying the correct game, so you need to implement a
rather clumsy solution to modify an item of a list.  Because we work
with immutable structures such as lists (as opposed to, say, OCaml
arrays that can be modified in place), this involves building a new
list and thus of boilerplate code.
</p>

<p>
There is a way to elegantly work with purely
functional data structures by using <i>lenses</i>.  A lens is like <a href="http://lambdafoo.com/blog/2015/01/16/ocaml-lenses/">a functional getter/setter</a>.  Say we have list of games, and we are
currently viewing and editing one of them.  A lens combines two functions:
</p>

<ul class="org-ul">
<li><code>get</code>, a function that takes some data structure <code>a</code> and returns a part of <code>a</code></li>
<li><code>set</code>, a function that takes some data structure <code>a</code> some data <code>b</code>, and
replaces a part of <code>a</code> by <code>b</code>. (Such that <code>set a b |&gt; get = b</code>.)</li>
</ul>

<p>
There are more laws that need to be fulfilled. If you want to learn
more about lenses, check out <a href="https://www.schoolofhaskell.com/school/to-infinity-and-beyond/pick-of-the-week/a-little-lens-starter-tutorial">Joseph Abrahamson&rsquo;s &ldquo;Little Lens Starter
Tutorial&rdquo;</a> or the really technical <a href="https://artyom.me/#lens-over-tea">Artyom&rsquo;s &ldquo;lens over tea&rdquo;</a>.  For
instance, here&rsquo;s a simple lens that just returns or sets the <code>games</code>
field of a record:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">games_lens</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> get <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">r</span> <span style="color: #a52a2a;">-&gt;</span> r.games<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">;</span> set <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">v r</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> r <span style="color: #a020f0;">with</span> games <span style="color: #a52a2a;">=</span> v <span style="color: #a52a2a;">})</span>
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
You don&rsquo;t even need a library for that!  Now you can do things like
<code>games_lens.get model</code> or <code>games_lens.set [] model</code>.  Okay, there is
not yet any benefit over just writing <code>model.games</code> or <code>{ model with games = [] }</code>, but bear with me and get the file <code>lens.ml</code> from <a href="https://github.com/pdonadeo/ocaml-lens">astrada&rsquo;s lens library</a> and put
in in your <code>src</code> directory.  This library gives you, among other
things, the function that we needed earlier, to modify the n-th item
of a list (it&rsquo;s <code>Lens.for_list</code>).
</p>

<p>
The nice thing about lenses is that they can
be composed.  This saves you from the nesting <code>{ x with y = { x.y with a
= b } }</code> ugliness.  For instance, we could compose <code>games_lens</code> with <code>Lens.for_list 10</code> to
obtain a list that accesses the 10th item of the <code>games</code> field
of whatever record it is applied to. (Check the source code of
<code>lens.ml</code> to see how composition works.)
</p>

<p>
In our app, we use a lens to track the game that we&rsquo;re currently
editing.  The lens
needs to be parameterized with the type that it works on,
and the type that it focuses on. 
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Lens</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Infix</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model list
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Game.</span>model<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Lens.</span>t
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Lichess.</span>model
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span><span style="color: #228b22;">Game.</span>init<span style="color: #a52a2a;">]</span>
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">Lens.</span>for_list 0
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">=</span> 0
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>init
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
The <code>|--</code> operator is defined by the <code>Lens.Infix</code> module and means &ldquo;compose&rdquo;.
So <code>game</code> will initially focus on item 0 in the list <code>model.games</code>.
</p>

<p>
Now we can use the lens to simplify some of our code.  Let&rsquo;s start
with the <code>view</code> function:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open! </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span> <span style="color: #a52a2a;">=</span> model <span style="color: #a52a2a;">|</span>. model.game <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">position</span> <span style="color: #a52a2a;">=</span> game.position <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">interactable</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status position <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Interactable</span> <span style="color: #a52a2a;">(</span>position.turn<span style="color: #a52a2a;">,</span> move_list<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_interactable</span> <span style="color: #000000; font-weight: bold;">in</span>
  main <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> section <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"board"</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> header_nav_view
        <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Board.</span>view interactable position.ar model.board
          <span style="color: #a52a2a;">|&gt;</span> map board_msg
        <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Game.</span>status_view position
        <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> map board_msg <span style="color: #228b22;">Board.</span>flip_button_view
               <span style="color: #a52a2a;">;</span> button
                   <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Random move!"</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">;</span> button
                   <span style="color: #a52a2a;">[</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Take back"</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> section <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"game"</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> nav <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> ul <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> li <span style="color: #a52a2a;">[]</span>
                             <span style="color: #a52a2a;">[</span> games_picker model.selected model.games <span style="color: #a52a2a;">]</span>
                         <span style="color: #a52a2a;">;</span> button
                             <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Reset_game</span> <span style="color: #a52a2a;">]</span>
                             <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"reset game"</span> <span style="color: #a52a2a;">]</span>
                         <span style="color: #a52a2a;">;</span> button
                             <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">New_game</span> <span style="color: #a52a2a;">]</span>
                             <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"new game"</span> <span style="color: #a52a2a;">]</span>
                         <span style="color: #a52a2a;">]</span>
                 <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">;</span> div <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"scroll"</span> <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Game.</span>view game <span style="color: #a52a2a;">|&gt;</span> map game_msg
            <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Lichess.</span>view model.lichess <span style="color: #a52a2a;">|&gt;</span> map lichess_msg
            <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Lines 2 and 3 are particularly instructive.  First of all, if we don&rsquo;t
put the asterisk after <code>open</code>, we will see a warning:
</p>

<pre class="example">
Warning 44: this open statement shadows the value identifier id (which is later used)
</pre>

<p>
Do take this seriously!  OCaml notices that <code>Lens</code> (which we opened
earlier) defines <code>id</code>, and so does <code>Tea.Html</code>.  Later on, we use <code>id</code>
so OCaml warns us that we need to be careful here because we could
have accidentally &ldquo;shadowed&rdquo; (made inaccessible) the <code>id</code> we really
wanted!  With the asterisk, we tell OCaml that we really want the <code>id</code>
from the <code>Html</code> module.
</p>

<p>
In line 3, we use another Lens infix operator.  The expression
<code>model |. model.game</code> is equivalent to <code>Lens._get model model.game</code>,
which in turn is just <code>model.game.get model</code>.  I like the way the
operator looks a little like array item access.
</p>

<p>
In the <code>update</code> function, we use the <code>game</code> lens as a setter:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Game.</span>update <span style="color: #a52a2a;">(</span>model <span style="color: #a52a2a;">|</span>. model.game<span style="color: #a52a2a;">)</span> msg <span style="color: #000000; font-weight: bold;">in</span>
    model <span style="color: #a52a2a;">|&gt;</span> model.game <span style="color: #a52a2a;">^=</span> game<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>map game_msg cmd
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_data</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> data<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Game.</span>game_of_pgn data <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> game <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> games <span style="color: #a52a2a;">=</span> game<span style="color: #a52a2a;">::</span>model.games
                                <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">Lens.</span>for_list 0
                     <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> alert <span style="color: #8b2252;">"Game could not be parsed!"</span><span style="color: #a52a2a;">;</span>
        model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">-&gt;</span>
    model<span style="color: #a52a2a;">,</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Chess.</span>game_status <span style="color: #a52a2a;">(</span>model <span style="color: #a52a2a;">|</span>. model.game<span style="color: #a52a2a;">)</span>.position <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> move_list <span style="color: #a52a2a;">-&gt;</span>
        move_list
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>length
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>int 0
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Random.</span>generate
          <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">random_number</span> <span style="color: #a52a2a;">-&gt;</span>
             <span style="color: #228b22;">List.</span>nth move_list random_number <span style="color: #a52a2a;">|&gt;</span> random_move<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Reset_game</span> <span style="color: #a52a2a;">-&gt;</span>
    model <span style="color: #a52a2a;">|&gt;</span> model.game <span style="color: #a52a2a;">^=</span> <span style="color: #228b22;">Game.</span>init<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">New_game</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Game.</span>init<span style="color: #a52a2a;">::</span>model.games
               <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">Lens.</span>for_list 0 <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Switch_game</span> i <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">Lens.</span>for_list i <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
Notice how the pattern in the <code>Games_msg</code> branch is a variation of the
pattern we used before.  First, we update the game by passing the current
game to <code>Game.update</code>, then we update it.  There&rsquo;s some nice syntactic
sugar here, so let&rsquo;s dissect the expression <code>model |&gt; model.game ^=
game</code>:
</p>

<ul class="org-ul">
<li><code>model |&gt; model.game ^= game</code> is equivalent to <code>(model.game ^= game)
  model</code></li>
<li>which in turn is equivalent to <code>Lens._set game model model.game</code></li>
<li>which is <code>model.game.set game model</code>!</li>
</ul>

<p>
I find the infix operator expression very pleasant to read (&ldquo;update
<code>model</code> at <code>model.game</code>&rsquo;s focus with <code>game</code>), but that&rsquo;s
just my subjective opinion.
</p>
</div>
</div>

<div id="outline-container-orgc850b58" class="outline-3">
<h3 id="orgc850b58">Modules and functors: Map</h3>
<div class="outline-text-3" id="text-orgc850b58">
<p>
Now if you would load thousands of games into the game picker, it
would get a little inefficient. Why? Because we&rsquo;re using linked lists,
and they were not made for random access.  Everytime we want to update
the n-th item in a list, we have to traverse the list up to item n.
Also, say we want to delete a game from the list.  Then all our
indices will change because we can&rsquo;t really have a &ldquo;gap&rdquo;.  Let&rsquo;s
change that.
</p>

<p>
We&rsquo;ll alleviate both problems at once by using a <i>key-value map</i>.  The
keys will be integer indices, and the values will be games. To find
the game for a given index only takes O(log n) as opposed to O(n)
time, and deleting a game doesn&rsquo;t affect the keys.  And of course
we&rsquo;ll use custom lenses!
</p>

<p>
OCaml offers maps, but for a beginner they are a little scary to work
with. First of all, the map implementation is super generic.  In fact,
there is no map module ready-made for you.  Instead, you need to create
your own by specifying the type of key you want to use.  OCaml gives
you a <i>functor</i> (that is, a parameterized module) that you
instantiate.  Here are two examples
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">IntT</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> <span style="color: #a52a2a;">=</span> int
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">compare</span> <span style="color: #a52a2a;">=</span> compare
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">IntMap</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Map.Make</span><span style="color: #a52a2a;">(</span><span style="color: #228b22;">IntT</span><span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
First, we define a module <code>IntT</code>, then we use the functor <code>Map.Make</code>
that takes this module and returns the new module <code>IntMap</code>. Of
course, just like function arguments must have a certain type, the
arguments of functors need to comply with certain expectations too:
the module needs to have the right <i>signature</i>, meaning it must define
certain types and functions.
</p>

<p>
Here&rsquo;s the signature of <code>Map.Make</code> (I obtained it by using Merlin):
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">functor</span> <span style="color: #a52a2a;">(</span><span style="color: #a0522d;">Ord</span> <span style="color: #a52a2a;">:</span><span style="color: #228b22;"> </span><span style="color: #228b22;">Map.</span><span style="color: #228b22;">OrderedType</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
  <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">key</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Ord.</span>t
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #a52a2a;">+</span><span style="color: #228b22;">'a t</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">empty</span> <span style="color: #a52a2a;">:</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">is_empty</span> <span style="color: #a52a2a;">:</span> 'a t <span style="color: #a52a2a;">-&gt;</span> bool
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">mem</span> <span style="color: #a52a2a;">:</span> key <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> bool
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">add</span> <span style="color: #a52a2a;">:</span> key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">singleton</span> <span style="color: #a52a2a;">:</span> key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">remove</span> <span style="color: #a52a2a;">:</span> key <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">merge</span> <span style="color: #a52a2a;">:</span>
      <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a option <span style="color: #a52a2a;">-&gt;</span> 'b option <span style="color: #a52a2a;">-&gt;</span> 'c option<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'b t <span style="color: #a52a2a;">-&gt;</span> 'c t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">compare</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>'a <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> int<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> int
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">equal</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>'a <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> bool<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> bool
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">iter</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> unit<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> unit
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">fold</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> 'b <span style="color: #a52a2a;">-&gt;</span> 'b<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'b <span style="color: #a52a2a;">-&gt;</span> 'b
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">for_all</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> bool<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> bool
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">exists</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> bool<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> bool
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">filter</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> bool<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">partition</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> bool<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">*</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">cardinal</span> <span style="color: #a52a2a;">:</span> 'a t <span style="color: #a52a2a;">-&gt;</span> int
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">bindings</span> <span style="color: #a52a2a;">:</span> 'a t <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">*</span> 'a<span style="color: #a52a2a;">)</span> list
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">min_binding</span> <span style="color: #a52a2a;">:</span> 'a t <span style="color: #a52a2a;">-&gt;</span> key <span style="color: #a52a2a;">*</span> 'a
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">max_binding</span> <span style="color: #a52a2a;">:</span> 'a t <span style="color: #a52a2a;">-&gt;</span> key <span style="color: #a52a2a;">*</span> 'a
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">choose</span> <span style="color: #a52a2a;">:</span> 'a t <span style="color: #a52a2a;">-&gt;</span> key <span style="color: #a52a2a;">*</span> 'a
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">split</span> <span style="color: #a52a2a;">:</span> key <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">*</span> 'a option <span style="color: #a52a2a;">*</span> 'a t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">find</span> <span style="color: #a52a2a;">:</span> key <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'a
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">map</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>'a <span style="color: #a52a2a;">-&gt;</span> 'b<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'b t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">mapi</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>key <span style="color: #a52a2a;">-&gt;</span> 'a <span style="color: #a52a2a;">-&gt;</span> 'b<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> 'a t <span style="color: #a52a2a;">-&gt;</span> 'b t
  <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
You see all the functions that will be exposed by the new module
returned by <code>Map.Make</code> (such as <code>add</code> and <code>find</code>), and you also see that it expects a module that complies with <code>Map.OrderedType</code>, which is
defined as:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">sig</span> <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">compare</span> <span style="color: #a52a2a;">:</span> t <span style="color: #a52a2a;">-&gt;</span> t <span style="color: #a52a2a;">-&gt;</span> int <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
And you see that&rsquo;s exactly what we implemented in <code>IntT</code>: an interface with a type <code>t</code> and a function <code>compare</code> that
takes two <code>t</code> arguments and returns an <code>int</code> to express which argument
is considered &ldquo;greater&rdquo;. (Key/value maps rely on an ordering of the keys.) We used the built-in
<code>compare</code> function that takes arbitrary types and compares them
structurally, but you could define your own if you wanted.
</p>

<p>
Let&rsquo;s take this one step further:  The Lens library doesn&rsquo;t supply any
lenses for <code>IntMap</code> and <code>StringMap</code>.  Let&rsquo;s roll our own functor:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">MapLens</span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">Key </span><span style="color: #a52a2a;">:</span><span style="color: #228b22;"> </span><span style="color: #228b22;">Map.</span><span style="color: #228b22;">OrderedType</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">for_key</span><span style="color: #a0522d;"> key</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">M</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Map.Make</span><span style="color: #a52a2a;">(</span><span style="color: #228b22;">Key</span><span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Lens</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> get <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">M.</span>find key
    <span style="color: #a52a2a;">;</span> set <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">M.</span>add key
    <span style="color: #a52a2a;">}</span>
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">IntMapLens</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">MapLens</span><span style="color: #a52a2a;">(</span><span style="color: #228b22;">IntT</span><span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
For any <code>Map.OrderedType</code> we can now derive a module <code>MapLens</code> with a
function <code>for_key</code> that returns a lens.  This example might seem a
little overengineered, but we will use it for great effect in today&rsquo;s
code, and it shows the power of <a href="http://lambdafoo.com/blog/2015/05/15/unreliable-guide-to-ocaml-modules/">OCaml&rsquo;s module system</a>.
</p>

<p>
I put all the code above in <code>src/Util.ml</code> so that I can use my maps
and lenses anywhere I like.
</p>
</div>
</div>

<div id="outline-container-org27bc922" class="outline-3">
<h3 id="org27bc922">Keeping track of games with a map</h3>
<div class="outline-text-3" id="text-org27bc922">
<p>
Let&rsquo;s start organizing our games in a map instead of a list:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Util</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">IntMap.</span>t
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Game.</span>model<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Lens.</span>t
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Lichess.</span>model
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>empty <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">IntMap.</span>add 1 <span style="color: #228b22;">Game.</span>init
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">IntMapLens.</span>for_key 1
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">=</span> 1
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>init
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
The games are now an <code>Game.model IntMap.t</code>.  This means the keys are
of type <code>int</code> and the values are of type <code>Game.model</code>.  The module
<code>IntMap</code> works for any value type &#x2013; for instance, <code>IntMap.empty</code> is
of the generic type <code>'a Util.IntMap.t</code> &#x2013; but once we commit to
storing a certain type of values, we can&rsquo;t change that.
</p>

<p>
On initialization, we add a single game with key 1 to an empty map. We
also set the lens to focus on that game by composing lenses. It works
like a charm! The beauty of the lens is that all our code that used
them as getters or setters can remain unchanged. You see, the lens
doesn&rsquo;t care about the type of the intermediate structure
<code>model.games</code>! It only cares about the types of the big structure
(<code>model</code>) and the focus (<code>Game.model</code>). Everything in between is just
a black box.
</p>

<p>
So all that we need to change is the code that deals with adding games
to the list (which is now a map).  Let&rsquo;s add a helper function that
puts a game in the map and updates the lens:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">add_game_update_lens</span><span style="color: #a0522d;"> game model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">key</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">IntMap.</span>max_binding model.games <span style="color: #a52a2a;">|&gt;</span> fst<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">games</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>add key game model.games <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> games
             <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">=</span> key
             <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">IntMapLens.</span>for_key key
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
The nifty trick here is to use the function <code>IntMap.max_binding</code> to
return the key/value pair with the biggest key (we only need the key,
so we pipe the pair through <code>fst</code> which returns the first item of a
pair), and adding 1 to it is guaranteed to be an unused key.  (Beware
that this will raise an exception on an empty map, but so far our
games map can never be empty.)  Then we add the game and return the
new model and that&rsquo;s already it!
</p>

<div class="exercise">
<p>
Exercise: update all the code that needs this function to work.  Add
a &ldquo;delete game&rdquo; button, but make sure if there is only one game in the
map, it can&rsquo;t be deleted.
</p>

</div>
</div>
</div>

<div id="outline-container-org2372d18" class="outline-3">
<h3 id="org2372d18">More maps: String maps</h3>
<div class="outline-text-3" id="text-org2372d18">
<p>
Let&rsquo;s use some more maps!  Right now, everytime you open a game from
Lichess, it will be downloaded.  How about we cache games that we
already downloaded in a map?  Lichess games have string IDs, so we
need a map module for string keys.  Easy:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">StringT</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> <span style="color: #a52a2a;">=</span> string
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">compare</span> <span style="color: #a52a2a;">=</span> compare
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">StringMap</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Map.Make</span><span style="color: #a52a2a;">(</span><span style="color: #228b22;">StringT</span><span style="color: #a52a2a;">)</span>
<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">StringMapLens</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">MapLens</span><span style="color: #a52a2a;">(</span><span style="color: #228b22;">StringT</span><span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
Again, OCaml already knows how to compare strings (it&rsquo;s built-in), so
there&rsquo;s not a lot of work to do.
</p>

<p>
I updated <code>src/Main.ml</code> with the new model:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">IntMap.</span>t
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Game.</span>model<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Lens.</span>t
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Lichess.</span>model
  <span style="color: #a52a2a;">;</span> lichess_games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">StringMap.</span>t
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>empty <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">IntMap.</span>add 1 <span style="color: #228b22;">Game.</span>init
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">IntMapLens.</span>for_key 1
  <span style="color: #a52a2a;">;</span> selected <span style="color: #a52a2a;">=</span> 1
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>init
  <span style="color: #a52a2a;">;</span> lichess_games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">StringMap.</span>empty
  <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
And now all we have to do is check the map when a Lichess game is
requested:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_game</span> id<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">StringMap.</span>find id model.lichess_games <span style="color: #000000; font-weight: bold;">in</span>
        add_game_update_lens game model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">lichess</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>update model.lichess <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_game</span> id<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> lichess <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>map lichess_msg cmd
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<div class="exercise">
<p>
Exercise:  This opens the game again, so you can have the same game
open multiple times for replaying and editing. Change it so that you
store the game number of open Lichess games and just switch to an
already open
game instead of opening a new game.  Also add &ldquo;revert&rdquo; functionality
to undo any changes to Lichess games.
</p>

</div>
</div>
</div>
</div>

<div id="outline-container-org863f295" class="outline-2">
<h2 id="part-vii"><a id="org863f295"></a>Part VII: Routing, local storage, computer matches</h2>
<div class="outline-text-2" id="text-part-vii">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-org9b66a71" class="outline-3">
<h3 id="org9b66a71">Client-side routing</h3>
<div class="outline-text-3" id="text-org9b66a71">
<p>
Just like an SPA isn&rsquo;t really an SPA without AJAX, it&rsquo;s not really an
SPA without client-side routing.  This means that the user should be
able to use the history buttons to navigate between different views,
and that the address bar should reflect what&rsquo;s currently on the
screen.  There are different ways to do this; we&rsquo;ll focus on <i>hash
routing</i> which uses the &ldquo;hash&rdquo; part after the page&rsquo;s address for
navigation, i.e. everything following the # symbol.
</p>

<p>
Let&rsquo;s define possible routes.  We can either show a game with an
integer ID, the tournament view or a Lichess game with a string ID
(this will allow &ldquo;deep links&rdquo; where the user requests a Lichess game
to be downloaded).
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">route</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> <span style="color: #a020f0;">of</span> int
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess</span> <span style="color: #a020f0;">of</span> string

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">IntMap.</span>t
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Game.</span>model<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Lens.</span>t
  <span style="color: #a52a2a;">;</span> route <span style="color: #a52a2a;">:</span> route
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Lichess.</span>model
  <span style="color: #a52a2a;">;</span> lichess_games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">StringMap.</span>t
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
So far, so self-explanatory.  However, when using routing, the
structure of the program changes significantly.  First of all, we need
to change <code>main</code>.  We now use a <code>Navigation.navigationProgram</code> that
will trigger a <code>Location_changed</code> message when the URL changes.
(Ignore <code>shutdown</code>.)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Location_changed</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Web.Location.</span>location
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">main</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Navigation.</span>navigationProgram location_changed
    <span style="color: #a52a2a;">{</span> init
    <span style="color: #a52a2a;">;</span> update
    <span style="color: #a52a2a;">;</span> view
    <span style="color: #a52a2a;">;</span> subscriptions
    <span style="color: #a52a2a;">;</span> shutdown <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">_</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
The <code>init</code> function will also receive the initial URL as a parameter,
so we can load our initial model and maybe update the route if needed:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init_model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>empty <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">IntMap.</span>add 1 <span style="color: #228b22;">Game.</span>init
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">IntMapLens.</span>for_key 1
  <span style="color: #a52a2a;">;</span> route <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> 1
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>init
  <span style="color: #a52a2a;">;</span> lichess_games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">StringMap.</span>empty
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span><span style="color: #a0522d;"> location</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">model</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span>
    route_of_location location <span style="color: #a52a2a;">|&gt;</span> update_route init_model <span style="color: #000000; font-weight: bold;">in</span>
  model<span style="color: #a52a2a;">,</span> cmd
</pre>
</div>

<p>
Here are some converters to switch between the &ldquo;hash&rdquo; representation
and the variant type, because we need to be able to listen on both
&ldquo;standard&rdquo; route changes and route changes through the URL:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">route_of_location</span><span style="color: #a0522d;"> location</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">route</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Js.String.</span>split <span style="color: #8b2252;">"/"</span> location.<span style="color: #228b22;">Web.Location.</span>hash <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a020f0;">match</span> route <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[|</span><span style="color: #8b2252;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">""</span><span style="color: #a52a2a;">|]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> 1
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[|</span><span style="color: #8b2252;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"tournament"</span><span style="color: #a52a2a;">|]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[|</span><span style="color: #8b2252;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"game"</span><span style="color: #a52a2a;">;</span> id<span style="color: #a52a2a;">|]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> <span style="color: #a52a2a;">(</span>int_of_string id<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[|</span><span style="color: #8b2252;">"#"</span><span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"lichess"</span><span style="color: #a52a2a;">;</span> id<span style="color: #a52a2a;">|]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess</span> id
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> 1  <span style="color: #b22222;">(* </span><span style="color: #b22222;">default route </span><span style="color: #b22222;">*)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">location_of_route</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> id <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"#/game/%d"</span> id
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess</span> id <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"#/lichess/%s"</span> id
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"#/tournament"</span>
</pre>
</div>

<div class="hint">
<p>
When we need to access a record field from a record that was defined
in another module, we use the funny-looking syntax above:
<code>location.Web.Location.hash</code>, where the module name is &ldquo;infixed&rdquo; into
the record and the field name.
</p>

</div>

<p>
Now we&rsquo;re ready to define what happens on a route change.  These were
previously handled in the <code>update</code> function.  Note how we
programmatically rewrite the URL when a Lichess game is opened as a
local game.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update_route</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> route <span style="color: #a020f0;">when</span> model.route <span style="color: #a52a2a;">=</span> route <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> id <span style="color: #a020f0;">as</span> route <span style="color: #a020f0;">when</span> <span style="color: #228b22;">IntMap.</span>mem id model.games <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span> <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">IntMapLens.</span>for_key id <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> route<span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> route <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> 1 <span style="color: #a52a2a;">},</span>
              location_of_route <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> 1<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Navigation.</span>modifyUrl
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> route <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_tournament</span><span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess</span> game_id <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">StringMap.</span>find game_id model.lichess_games <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">model</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> key</span> <span style="color: #a52a2a;">=</span> add_game_update_lens game model <span style="color: #000000; font-weight: bold;">in</span>
        model<span style="color: #a52a2a;">,</span>
        location_of_route <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> key<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Navigation.</span>modifyUrl
      <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span>
        model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_game</span> game_id<span style="color: #a52a2a;">))</span>
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
In the <code>update</code> function, we make sure that route changes are properly
handled.  For the messages involving switching to a game view, we just update the URL and let our app
pick up on the URL change to perform the actual action:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Lichess_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_data</span> <span style="color: #a52a2a;">(</span>game_id<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> data<span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Game.</span>game_of_pgn data <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> game <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">lichess_games</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">StringMap.</span>add game_id game model.lichess_games <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">model</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> key</span> <span style="color: #a52a2a;">=</span>
          <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> lichess_games <span style="color: #a52a2a;">}</span>
          <span style="color: #a52a2a;">|&gt;</span> add_game_update_lens game <span style="color: #000000; font-weight: bold;">in</span>
        model<span style="color: #a52a2a;">,</span> location_of_route <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> key<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Navigation.</span>modifyUrl
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> alert <span style="color: #8b2252;">"Game could not be parsed!"</span><span style="color: #a52a2a;">;</span>
        model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">New_game</span> <span style="color: #a52a2a;">-&gt;</span> 
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">model</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> key</span> <span style="color: #a52a2a;">=</span> add_game_update_lens <span style="color: #228b22;">Game.</span>init model <span style="color: #000000; font-weight: bold;">in</span>
    model<span style="color: #a52a2a;">,</span> location_of_route <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> key<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Navigation.</span>newUrl
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Switch_game</span> 0 <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span>
                     location_of_route <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Navigation.</span>newUrl
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Switch_game</span> i <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span>
                     location_of_route <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> i<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Navigation.</span>newUrl
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Location_changed</span> location <span style="color: #a52a2a;">-&gt;</span>
    route_of_location location <span style="color: #a52a2a;">|&gt;</span> update_route model
</pre>
</div>

<p>
Now we only need to make sure to show the appropriate view depending
on the route.  Let&rsquo;s just add the tournament view to the game picker
as &ldquo;Game 0&rdquo;.  Not very elegant, but for now it will do.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">games_picker</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">selected</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">match</span> model.route <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> id <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> id
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">option_view</span><span style="color: #a0522d;"> k _v acc</span> <span style="color: #a52a2a;">=</span>
    option' <span style="color: #a52a2a;">[</span> string_of_int k <span style="color: #a52a2a;">|&gt;</span> value
            <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Attributes.</span>selected <span style="color: #a52a2a;">(</span>selected <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> k<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"Game %d"</span> k <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]::</span>acc <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">options</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>fold option_view model.games <span style="color: #a52a2a;">[]</span>
                <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>rev <span style="color: #000000; font-weight: bold;">in</span>
  option' <span style="color: #a52a2a;">[</span> value <span style="color: #8b2252;">"0"</span>
          <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Attributes.</span>selected <span style="color: #a52a2a;">(</span>model.route <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Tournament"</span> <span style="color: #a52a2a;">]::</span>options
  <span style="color: #a52a2a;">|&gt;</span> select <span style="color: #a52a2a;">[</span> int_of_string <span style="color: #a52a2a;">&gt;&gt;</span> switch_game <span style="color: #a52a2a;">|&gt;</span> onChange <span style="color: #a52a2a;">]</span>


<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
        <span style="color: #a52a2a;">;</span> div <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"scroll"</span> <span style="color: #a52a2a;">]</span>
            <span style="color: #a52a2a;">[</span> <span style="color: #a020f0;">match</span> model.route <span style="color: #a020f0;">with</span>
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Game.</span>view game <span style="color: #a52a2a;">|&gt;</span> map game_msg
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Tournament</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Lichess.</span>view model.lichess <span style="color: #a52a2a;">|&gt;</span> map lichess_msg
              <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> noNode
            <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
I also changed the tournament view in <code>src/Lichess.ml</code> to use links
instead of messages:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_view</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">id</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> players</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
    td <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> a <span style="color: #a52a2a;">[</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"#/lichess/%s"</span> id <span style="color: #a52a2a;">|&gt;</span> href <span style="color: #a52a2a;">]</span>
              <span style="color: #a52a2a;">[</span> text id <span style="color: #a52a2a;">]</span>
          <span style="color: #a52a2a;">]::</span>
    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">player</span> <span style="color: #a52a2a;">-&gt;</span> td <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> text player <span style="color: #a52a2a;">])</span> players
    <span style="color: #a52a2a;">|&gt;</span> tr <span style="color: #a52a2a;">[]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
And there you have it &#x2013; client-side routing.  Now you can use the
forward and backward buttons of the browser, and you can use the &ldquo;deep
links&rdquo; starting with <code>#/lichess/</code> to automatically open a game even
when you copy-paste the URL into a new browser window.
</p>
</div>
</div>

<div id="outline-container-org926b372" class="outline-3">
<h3 id="org926b372">Using local storage</h3>
<div class="outline-text-3" id="text-org926b372">
<p>
Unfortunately, all your games will be lost when you close the browser
window.  Let&rsquo;s make them persistent in the local storage so that the
game links actually work across sessions.
</p>

<p>
First, I wrote a little function <code>Game.pgn_of_game</code> to serialize a
game into a simplified PGN format.  It skips move numbers and all
comments or variations, but it does the job reasonably well:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">pgn_of_game</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">past</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> future</span> <span style="color: #a52a2a;">=</span> model.moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">sans</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>rev_append past future
             <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">-&gt;</span> move.san<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">header</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #a0522d;">k</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> v</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"[%s \"%s\"]"</span> k v<span style="color: #a52a2a;">)</span> model.header
    <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">String.</span>concat <span style="color: #8b2252;">"\n"</span> <span style="color: #000000; font-weight: bold;">in</span>
  header <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">"\n\n"</span> <span style="color: #a52a2a;">^</span>
  <span style="color: #228b22;">String.</span>concat <span style="color: #8b2252;">" "</span> sans <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">" "</span> <span style="color: #a52a2a;">^</span>
  <span style="color: #a52a2a;">(</span>string_of_result model.result<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
Bucklescript-TEA provides access to the browser&rsquo;s local storage,
however local storage is a little cumbersome to work with.  In order
to enumerate all items in the storage, you need to first get the
length (that is the number of items), then you can enumerate the keys,
and finally you can enumerate the values.
</p>

<p>
Let&rsquo;s start a new file <code>src/Storage.ml</code> to tackle this problem.  We
need access to our <code>IntMap</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Util</span>
</pre>
</div>

<p>
Saving one game is easy:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">returns a task </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">save_game</span><span style="color: #a0522d;"> key game</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Game.</span>pgn_of_game game <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea.Ex.LocalStorage.</span>setItem key
</pre>
</div>

<p>
Loading one game is also easy:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">load_game</span><span style="color: #a0522d;"> key</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Tea.Ex.LocalStorage.</span>getItem key <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">value</span> <span style="color: #a52a2a;">-&gt;</span> key<span style="color: #a52a2a;">,</span> value<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
&#x2026;that is, until we realize that every interaction with the local
storage creates a <code>Tea_task.t</code>.  A <i>task</i>
is similar to a command in that it is just a recipe for a function that still needs to
be run eventually.  Unlike commands, tasks can be chained and their
results can be mapped.  In a way (insert the scary &ldquo;M&rdquo; word here),
they behave like the applicative parsers we encountered earlier.
</p>

<p>
When we&rsquo;re ready to launch a task, we turn it into a command and it
will come back with a message depending on whether the task failed or succeeded.
Saving all games will return a list of tasks that we will have to deal
with.
</p>

<p>
Loading a bunch of games is a little more complicated.  The local
storage API is somewhat clumsy, so we first have to ask for the
<i>length</i> of the storage (i.e., the number of items stored), then
acquire the <i>key</i> one by one, before we can access the <i>values</i>.  Note
how we chain the tasks with <code>andThen</code> (that&rsquo;s <code>&gt;&gt;=</code> in the context of
Opal parsers) and how we use <code>Tea_task.sequence</code> to combine a list of
tasks into one.  We return the scratch game (if found in the storage)
and a ready-to-use IntMap for the remaining games:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">save_games</span><span style="color: #a0522d;"> games</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">IntMap.</span>fold <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">key value acc</span> <span style="color: #a52a2a;">-&gt;</span>
      save_game <span style="color: #a52a2a;">(</span>string_of_int key<span style="color: #a52a2a;">)</span> value<span style="color: #a52a2a;">::</span>acc<span style="color: #a52a2a;">)</span>
    games
    <span style="color: #a52a2a;">[]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">load_games</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">Tea.Ex.LocalStorage.</span>length
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>andThen <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">length</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span><span style="color: #a0522d;"> i acc</span> <span style="color: #a52a2a;">=</span>
        <span style="color: #a020f0;">if</span> i <span style="color: #a52a2a;">&gt;=</span> 0 <span style="color: #a020f0;">then</span>
          loop <span style="color: #a52a2a;">(</span>i <span style="color: #a52a2a;">-</span> 1<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Tea.Ex.LocalStorage.</span>key i<span style="color: #a52a2a;">::</span>acc<span style="color: #a52a2a;">)</span>
        <span style="color: #a020f0;">else</span> acc <span style="color: #000000; font-weight: bold;">in</span>
      loop length <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>sequence
    <span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>andThen <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">keys</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">List.</span>map load_game keys
      <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>sequence<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">list</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #228b22;">List.</span>fold_left <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">acc </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">key</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> value</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
          <span style="color: #a020f0;">try</span> <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Game.</span>game_of_pgn value <span style="color: #a020f0;">with</span>
            <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> game <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">IntMap.</span>add <span style="color: #a52a2a;">(</span>int_of_string key<span style="color: #a52a2a;">)</span> game acc
            <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> acc
          <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span> acc<span style="color: #a52a2a;">)</span>
        <span style="color: #228b22;">IntMap.</span>empty
        list
    <span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
Here&rsquo;s how we trigger it in the <code>update</code> function.  Saving games
returns <code>()</code>, so <code>Games_saved</code> will get a list of units or an error
string back.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Save_games</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Clear_games</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Games_saved</span> <span style="color: #a020f0;">of</span> <span style="color: #a52a2a;">(</span>unit list<span style="color: #a52a2a;">,</span> string<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Result.</span>t
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Games_loaded</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Web.Location.</span>location <span style="color: #a52a2a;">*</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">IntMap.</span>t<span style="color: #a52a2a;">,</span> string<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Result.</span>t

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Save_games</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span>
                  <span style="color: #228b22;">Storage.</span>save_games model.games
                  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>sequence
                  <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Tea_task.</span>attempt games_saved
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Games_saved</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> alert <span style="color: #8b2252;">"games successfully saved"</span><span style="color: #a52a2a;">;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Games_saved</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> e<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"games couldn't be saved because of error %s"</span> e <span style="color: #a52a2a;">|&gt;</span> alert<span style="color: #a52a2a;">;</span>
    model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Clear_games</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Ex.LocalStorage.</span>clearCmd <span style="color: #a52a2a;">()</span>
</pre>
</div>

<p>
On startup, we want to load all games, if possible. Let&rsquo;s do that
before we update the route so we have a chance to load the games first
(otherwise, we might not be able to switch the view):
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span><span style="color: #a0522d;"> location</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">wait for games to be restored before the route is updated </span><span style="color: #b22222;">*)</span>
  init_model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Tea_task.</span>attempt <span style="color: #a52a2a;">(</span>games_loaded location<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Storage.</span>load_games
</pre>
</div>

<p>
We achieve this by including the <code>location</code> in the <code>Games_loaded</code>
message (that explains the funny type you saw above). When the games
come in, here&rsquo;s how we handle the situation.  We just update the route
with the location we received, based on the initial model with the
loaded games.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Games_loaded</span> <span style="color: #a52a2a;">(</span>location<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ok</span> games<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    route_of_location location
    <span style="color: #a52a2a;">|&gt;</span> update_route
      <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">if</span> games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>empty <span style="color: #a020f0;">then</span> model <span style="color: #a020f0;">else</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> games <span style="color: #a52a2a;">})</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Games_loaded</span> <span style="color: #a52a2a;">(</span>location<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Error</span> e<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"games couldn't be restored because of error %s"</span> e <span style="color: #a52a2a;">|&gt;</span> alert<span style="color: #a52a2a;">;</span>
    route_of_location location
    <span style="color: #a52a2a;">|&gt;</span> update_route model
</pre>
</div>

<div class="exercise">
<p>
Exercise:  Wire the buttons needed to interact with local storage.
You can also implement selective &ldquo;save&rdquo; and &ldquo;delete&rdquo; actions.
</p>

</div>
</div>
</div>

<div id="outline-container-org5513472" class="outline-3">
<h3 id="org5513472">Play against the computer</h3>
<div class="outline-text-3" id="text-org5513472">
<p>
Let&rsquo;s embed the world class chess engine <a href="http://www.stockfishchess.com/">Stockfish</a> into our app.
Download the Javascript port of Stockfish from <a href="https://github.com/nmrugg/stockfish.js/tree/master/src">nmrugg&rsquo;s repository</a> and
drop the file <code>stockfish.js</code> into the directory <code>release/js</code>.  The
challenge is to make Stockfish talk to Bucklescript.  Edit
your <code>release/index.html</code> to contain the following Javascript:
</p>

<div class="org-src-container">
<pre class="src src-html">  &lt;<span style="color: #0000ff;">script</span>&gt;
    var app;
    var stockfish_loader = function (handler) {
      stockfish = new Worker('js/stockfish.js');
      stockfish.onmessage = function(msg) {
        app.pushMsg(handler(msg.data));
      };
      return stockfish;
    };
    setTimeout(function() {
      app = starter.main(document.body);
    }, 1)
&lt;/<span style="color: #0000ff;">script</span>&gt;
</pre>
</div>

<p>
The key differences are that <code>app</code> is now a global variable, and <code>stockfish_loader</code> is also a global function that we can call from within Bucklescript.  When <code>stockfish_loader</code> is called with a <code>handler</code> function, it initializes a <i>Web worker</i> in the background that will pass messages into our message loop by using <code>app.pushMsg</code>.  All we have to do is to set up a function in Bucklescript that generates appropriate messages.
</p>

<p>
Change the model in <code>src/Main.ml</code>. We also add a declaration of the external function from the Javascript side.  Bucklescript will ensure that it can only be called with an argument that is a function from <code>string</code> to <code>msg</code> and assume it will get a <code>Stockfish.stockfish</code> back.  Just to be safe, because Javascript can throw <code>null</code> at us anytime, we wrap it into a special Bucklescript type <code>Js.nullable</code> that is similar to an <code>option</code>. 
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">IntMap.</span>t
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Game.</span>model<span style="color: #a52a2a;">)</span> <span style="color: #228b22;">Lens.</span>t
  <span style="color: #a52a2a;">;</span> route <span style="color: #a52a2a;">:</span> route
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Board.</span>model
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Lichess.</span>model
  <span style="color: #a52a2a;">;</span> lichess_games <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Game.</span>model <span style="color: #228b22;">StringMap.</span>t
  <span style="color: #a52a2a;">;</span> stockfish <span style="color: #a52a2a;">:</span> <span style="color: #228b22;">Stockfish.</span>model option
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_stockfish</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Stockfish_msg</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Stockfish.</span>msg
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">external</span> <span style="color: #0000ff;">stockfish_loader</span> <span style="color: #a52a2a;">:</span>
  <span style="color: #a52a2a;">(</span>string <span style="color: #a52a2a;">-&gt;</span> msg<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Stockfish.</span>stockfish <span style="color: #228b22;">Js.</span>nullable <span style="color: #a52a2a;">=</span>
  <span style="color: #8b2252;">"stockfish_loader"</span> <span style="color: #483d8b;">[@@bs.val]</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init_model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">IntMap.</span>empty <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">IntMap.</span>add 1 <span style="color: #228b22;">Game.</span>init
  <span style="color: #a52a2a;">;</span> game <span style="color: #a52a2a;">=</span> games_lens <span style="color: #a52a2a;">|--</span> <span style="color: #228b22;">IntMapLens.</span>for_key 1
  <span style="color: #a52a2a;">;</span> route <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game</span> 1
  <span style="color: #a52a2a;">;</span> board <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Board.</span>init
  <span style="color: #a52a2a;">;</span> lichess <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Lichess.</span>init
  <span style="color: #a52a2a;">;</span> lichess_games <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">StringMap.</span>empty
  <span style="color: #a52a2a;">;</span> stockfish <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
When the user wants to load Stockfish, the Javascript function is
called, and Stockfish might or might not be available.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> 
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_stockfish</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">f</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">string</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Stockfish.</span>data string <span style="color: #a52a2a;">|&gt;</span> stockfish_msg<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> stockfish_loader f <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Js.Nullable.</span>to_opt
      <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> alert <span style="color: #8b2252;">"Stockfish failed to load"</span><span style="color: #a52a2a;">;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> stockfish <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> stockfish <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Stockfish.</span>init stockfish<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Now start a file <code>src/Stockfish.ml</code>.  The first type declaration
creates a <a href="https://bucklescript.github.io/docs/en/object.html">Javascript object type</a> with the methods that we&rsquo;re
interested in.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Tea</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">stockfish</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span>
  postMessage <span style="color: #a52a2a;">:</span> string <span style="color: #a52a2a;">-&gt;</span> unit <span style="color: #483d8b;">[@bs.meth]</span><span style="color: #a52a2a;">;</span>
<span style="color: #a52a2a;">&gt;</span> <span style="color: #228b22;">Js.</span>t

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">status</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Thinking</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">msg</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Data</span> <span style="color: #a020f0;">of</span> string
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Pgn.</span>move
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ready</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Make_move</span> <span style="color: #a020f0;">of</span> string
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Set_autoplay</span> <span style="color: #a020f0;">of</span> bool
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Set_depth</span> <span style="color: #a020f0;">of</span> int
<span style="color: #483d8b;">[@@bs.deriving {accessors}]</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">parse</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parsed_move</span> <span style="color: #a020f0;">of</span> <span style="color: #228b22;">Pgn.</span>move
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parsed_ready</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> status <span style="color: #a52a2a;">:</span> status
  <span style="color: #a52a2a;">;</span> stockfish <span style="color: #a52a2a;">:</span> stockfish
  <span style="color: #a52a2a;">;</span> depth <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> autoplay <span style="color: #a52a2a;">:</span> bool
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">init</span><span style="color: #a0522d;"> stockfish</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> status <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span>
  <span style="color: #a52a2a;">;</span> stockfish <span style="color: #a52a2a;">=</span> stockfish
  <span style="color: #a52a2a;">;</span> depth <span style="color: #a52a2a;">=</span> 12
  <span style="color: #a52a2a;">;</span> autoplay <span style="color: #a52a2a;">=</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
When data comes in, wee need to parse the message from Stockfish.
Let&rsquo;s log the message also in the developer console so we can inspect
it.  We use parser combinators again.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Set_autoplay</span> autoplay <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> autoplay <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Set_depth</span> depth <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> depth <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Data</span> data <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Js.</span>log data<span style="color: #a52a2a;">;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Opal</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #483d8b;">parser</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"Stockfish"</span> <span style="color: #a52a2a;">&gt;&gt;</span> return <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parsed_ready</span><span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">&lt;|&gt;</span>
      <span style="color: #a52a2a;">(</span>token <span style="color: #8b2252;">"bestmove"</span> <span style="color: #a52a2a;">&gt;&gt;</span>
       lexeme <span style="color: #a52a2a;">(</span>many1 alpha_num<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&gt;&gt;</span> 
       token <span style="color: #8b2252;">"bestmoveSan"</span> <span style="color: #a52a2a;">&gt;&gt;</span>
       <span style="color: #228b22;">Pgn.</span>move <span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">&gt;&gt;=</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">-&gt;</span>
       exactly <span style="color: #8b2252;">' '</span> <span style="color: #a52a2a;">&gt;&gt;</span>
       return <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parsed_move</span> move<span style="color: #a52a2a;">))</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">LazyStream.</span>of_string data <span style="color: #a52a2a;">|&gt;</span> parse <span style="color: #483d8b;">parser</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> move <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parsed_ready</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span>model <span style="color: #a020f0;">with</span> status <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span><span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ready</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parsed_move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">{</span>model <span style="color: #a020f0;">with</span> status <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span><span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>msg <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Make_move</span> position <span style="color: #a52a2a;">-&gt;</span>
    model.stockfish<span style="color: #a52a2a;">##</span>postMessage <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">"position fen "</span> <span style="color: #a52a2a;">^</span> position<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">;</span>
    model.stockfish<span style="color: #a52a2a;">##</span>postMessage <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"go depth %d"</span> model.depth<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">;</span>
    <span style="color: #a52a2a;">{</span>model <span style="color: #a020f0;">with</span> status <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Thinking</span><span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> _ <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Ready</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>

<p>
When we receive the <code>Make_move</code> message, we give Stockfish the current
position and ask it to return a move (higher depth means a longer
think and a better move).  We need to use the ## syntax to call the
<code>postMessage</code> method.  Notice that it will return <code>()</code> and so can be
used to trigger a side effect.  This is the first time we&rsquo;re being
sneaky and perform a side effect other than <code>Js.log</code> and <code>alert</code>
outside of TEA. 
</p>

<div class="exercise">
<p>
Exercise: Use tasks instead.
</p>

</div>

<p>
Here&rsquo;s a simple view for Stockfish:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model position</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  p <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.status <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span> <span style="color: #a52a2a;">-&gt;</span> button
                    <span style="color: #a52a2a;">[</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Make_move</span> position <span style="color: #a52a2a;">|&gt;</span> onClick <span style="color: #a52a2a;">]</span>
                    <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"move, computer!"</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #8b2252;">"loading Stockfish"</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Thinking</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #8b2252;">"Stockfish is thinking"</span> <span style="color: #000000; font-weight: bold;">end</span>
    <span style="color: #a52a2a;">;</span> input' <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"autoplay"</span>
             <span style="color: #a52a2a;">;</span> type' <span style="color: #8b2252;">"checkbox"</span>
             <span style="color: #a52a2a;">;</span> onCheck set_autoplay
             <span style="color: #a52a2a;">;</span> checked model.autoplay
             <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">;</span> label <span style="color: #a52a2a;">[</span> for' <span style="color: #8b2252;">"autoplay"</span> <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"autoplay"</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">;</span> input' <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"depth"</span>
             <span style="color: #a52a2a;">;</span> type' <span style="color: #8b2252;">"number"</span>
             <span style="color: #a52a2a;">;</span> style <span style="color: #8b2252;">"width"</span> <span style="color: #8b2252;">"3em"</span>
             <span style="color: #a52a2a;">;</span> style <span style="color: #8b2252;">"margin-left"</span> <span style="color: #8b2252;">"1em"</span>
             <span style="color: #a52a2a;">;</span> onChange <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> int_of_string x <span style="color: #a52a2a;">|&gt;</span> set_depth<span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">;</span> value <span style="color: #a52a2a;">(</span>string_of_int model.depth<span style="color: #a52a2a;">)</span>
             <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Attributes.</span>min <span style="color: #8b2252;">"1"</span>
             <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Attributes.</span>max <span style="color: #8b2252;">"24"</span>
             <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">;</span> label <span style="color: #a52a2a;">[</span> for' <span style="color: #8b2252;">"depth"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"strength"</span> <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Now we only need to wire Stockfish properly in <code>src/Main.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Stockfish_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move'</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Pgn.</span>move_of_pgn_move
            <span style="color: #a52a2a;">((</span>model <span style="color: #a52a2a;">|</span>. model.game<span style="color: #a52a2a;">)</span>.position<span style="color: #a52a2a;">)</span> move <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span>
          <span style="color: #228b22;">Game.</span>update <span style="color: #a52a2a;">(</span>model <span style="color: #a52a2a;">|</span>. model.game<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Game.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move'<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        model <span style="color: #a52a2a;">|&gt;</span> model.game <span style="color: #a52a2a;">^=</span> game<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>map game_msg cmd
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Chess.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Illegal_move</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #b22222;">(* </span><span style="color: #b22222;">Stockfish rarely makes illegal moves, but just in case ;-) </span><span style="color: #b22222;">*)</span>
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Stockfish_msg</span> msg <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> model.stockfish <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> stockfish' <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">stockfish</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Stockfish.</span>update stockfish' msg <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span> stockfish <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> stockfish <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Cmd.</span>map stockfish_msg cmd
    <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">stockfish_view</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> model.stockfish <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> button
                       <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Load_stockfish</span> <span style="color: #a52a2a;">]</span>
                       <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"load Stockfish"</span> <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">]</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> stockfish <span style="color: #a52a2a;">-&gt;</span>
      p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> <span style="color: #a020f0;">match</span> stockfish.status <span style="color: #a020f0;">with</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Idle</span> <span style="color: #a52a2a;">-&gt;</span>
            <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> interactable <span style="color: #a020f0;">with</span>
              <span style="color: #a52a2a;">|</span> <span style="color: #228b22;">Board.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_interactable</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Game.</span>status_view position
              <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> button
                       <span style="color: #a52a2a;">[</span> game.position <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Chess.FEN.</span>fen_of_position
                         <span style="color: #a52a2a;">|&gt;</span> stockfish_move <span style="color: #a52a2a;">|&gt;</span> onClick <span style="color: #a52a2a;">]</span>
                       <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"move, computer!"</span> <span style="color: #a52a2a;">]</span>
            <span style="color: #000000; font-weight: bold;">end</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Loading</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #8b2252;">"loading Stockfish"</span>
          <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Thinking</span> <span style="color: #a52a2a;">-&gt;</span> text <span style="color: #8b2252;">"Stockfish is thinking"</span>
        <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

  main <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">[</span> section <span style="color: #a52a2a;">[</span> id <span style="color: #8b2252;">"board"</span> <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">[</span> header_nav_view
        <span style="color: #a52a2a;">;</span> <span style="color: #228b22;">Board.</span>view interactable position.ar model.board
          <span style="color: #a52a2a;">|&gt;</span> map board_msg
        <span style="color: #a52a2a;">;</span> p <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">[</span> map board_msg <span style="color: #228b22;">Board.</span>flip_button_view
               <span style="color: #a52a2a;">;</span> button
                   <span style="color: #a52a2a;">[</span> onClick <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_button</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Random move!"</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">;</span> button
                   <span style="color: #a52a2a;">[</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Game_msg</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
                   <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">"Take back"</span> <span style="color: #a52a2a;">]</span>
               <span style="color: #a52a2a;">]</span>
        <span style="color: #a52a2a;">;</span> stockfish_view
        <span style="color: #a52a2a;">]</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">... </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
At this point, we only need to take care of a small detail:  Stockfish
expects the current position in <a href="http://www.mychess.de/ChessNotation.htm">FEN notation</a>.  Here&rsquo;s the conversion
module, put it in <code>src/Chess.ml</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">FEN</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>

  <span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">Parse_error</span> <span style="color: #a52a2a;">=</span> <span style="color: #483d8b;">Invalid_argument</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fen_of_position</span><span style="color: #a0522d;"> position</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">coordinates</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span>7<span style="color: #a52a2a;">;</span> 6<span style="color: #a52a2a;">;</span> 5<span style="color: #a52a2a;">;</span> 4<span style="color: #a52a2a;">;</span> 3<span style="color: #a52a2a;">;</span> 2<span style="color: #a52a2a;">;</span> 1<span style="color: #a52a2a;">;</span> 0<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">char_of_empty</span><span style="color: #a0522d;"> i</span> <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"0123456789"</span>.<span style="color: #a52a2a;">[</span>i<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">rank</span><span style="color: #a0522d;"> n</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">acc</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> empty</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> acc<span style="color: #a52a2a;">,</span> empty
        <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>tl <span style="color: #a52a2a;">-&gt;</span> 
          <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> position.ar.<span style="color: #a52a2a;">(</span>hd<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>n<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">with</span>
            <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #a52a2a;">-&gt;</span> loop <span style="color: #a52a2a;">(</span>acc<span style="color: #a52a2a;">,</span> empty <span style="color: #a52a2a;">+</span> 1<span style="color: #a52a2a;">)</span> tl
            <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> piece <span style="color: #a52a2a;">-&gt;</span> 
              <span style="color: #a020f0;">if</span> empty <span style="color: #a52a2a;">&gt;</span> 0
              <span style="color: #a020f0;">then</span> loop <span style="color: #a52a2a;">(</span>char_of_piece piece<span style="color: #a52a2a;">::</span>char_of_empty empty<span style="color: #a52a2a;">::</span>acc<span style="color: #a52a2a;">,</span> 0<span style="color: #a52a2a;">)</span> tl
              <span style="color: #a020f0;">else</span> loop <span style="color: #a52a2a;">(</span>char_of_piece piece<span style="color: #a52a2a;">::</span>acc<span style="color: #a52a2a;">,</span> 0<span style="color: #a52a2a;">)</span> tl
          <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">acc</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> empty</span> <span style="color: #a52a2a;">=</span> loop <span style="color: #a52a2a;">([],</span> 0<span style="color: #a52a2a;">)</span> coordinates <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #228b22;">Opal.</span>implode <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">if</span> empty <span style="color: #a52a2a;">&gt;</span> 0 <span style="color: #a020f0;">then</span> char_of_empty empty<span style="color: #a52a2a;">::</span>acc <span style="color: #a020f0;">else</span> acc<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">board</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>map rank coordinates <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">String.</span>concat <span style="color: #8b2252;">"/"</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">full_move</span> <span style="color: #a52a2a;">=</span> position.number <span style="color: #a52a2a;">/</span> 2 <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">en_passant</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.en_passant <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"-"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> file <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%c%c"</span> <span style="color: #a52a2a;">(</span>char_of_file file<span style="color: #a52a2a;">)</span>
                       <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">if</span> position.turn <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a020f0;">then</span> <span style="color: #8b2252;">'6'</span> <span style="color: #a020f0;">else</span> <span style="color: #8b2252;">'3'</span><span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">castling_white</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.cas_w <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"KQ"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">false</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"Q"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">false</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"K"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">false</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">false</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">""</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">castling_black</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> position.cas_b <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"kq"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">true</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">false</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"q"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">false</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">"k"</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #008b8b;">false</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">false</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">""</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">castling</span> <span style="color: #a52a2a;">=</span> castling_white <span style="color: #a52a2a;">^</span> castling_black <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">turn</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">match</span> position.turn <span style="color: #a020f0;">with</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">'w'</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #8b2252;">'b'</span> <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%s %c %s %s %d %d"</span> board turn castling en_passant position.irr_change full_move

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">board_of_fen</span><span style="color: #a0522d;"> board</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ranks</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Js.String.</span>split <span style="color: #8b2252;">"/"</span> board <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a020f0;">match</span> <span style="color: #228b22;">Array.</span>length ranks <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> 8 <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ar</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Array.</span>make_matrix 8 8 <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Empty</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">king_w</span> <span style="color: #a52a2a;">=</span> <span style="color: #483d8b;">ref</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">king_b</span> <span style="color: #a52a2a;">=</span> <span style="color: #483d8b;">ref</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #228b22;">Array.</span>iteri
        <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">i rank_string</span> <span style="color: #a52a2a;">-&gt;</span>
           <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">rank</span> <span style="color: #a52a2a;">=</span> 7 <span style="color: #a52a2a;">-</span> i <span style="color: #000000; font-weight: bold;">in</span>
           <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">file</span> <span style="color: #a52a2a;">=</span> <span style="color: #483d8b;">ref</span> 0 <span style="color: #000000; font-weight: bold;">in</span>
           <span style="color: #228b22;">String.</span>iter
             <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">function</span>
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'0'</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">()</span>  <span style="color: #b22222;">(* </span><span style="color: #b22222;">non-standard but not harmful either </span><span style="color: #b22222;">*)</span>
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'1'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 1
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'2'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 2
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'3'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 3
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'4'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 4
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'5'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 5
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'6'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 6
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'7'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 7
               <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'8'</span> <span style="color: #a52a2a;">-&gt;</span> file <span style="color: #a52a2a;">:=</span> <span style="color: #a52a2a;">!</span>file <span style="color: #a52a2a;">+</span> 8
               <span style="color: #a52a2a;">|</span> piece <span style="color: #a52a2a;">-&gt;</span>
                 <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> piece <span style="color: #a020f0;">with</span>
                   <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'K'</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a020f0;">if</span> <span style="color: #a52a2a;">!</span>king_w <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a020f0;">then</span> king_w <span style="color: #a52a2a;">:=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(!</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>
                     <span style="color: #a020f0;">else</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"more than one white king"</span><span style="color: #a52a2a;">)</span>
                   <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">'k'</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a020f0;">if</span> <span style="color: #a52a2a;">!</span>king_b <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a020f0;">then</span> king_b <span style="color: #a52a2a;">:=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(!</span>file<span style="color: #a52a2a;">,</span> rank<span style="color: #a52a2a;">)</span>
                     <span style="color: #a020f0;">else</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"more than one black king"</span><span style="color: #a52a2a;">)</span>
                   <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">()</span>
                 <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #a52a2a;">;</span>
                 <span style="color: #000000; font-weight: bold;">begin</span>
                   <span style="color: #a020f0;">try</span> ar.<span style="color: #a52a2a;">(!</span>file<span style="color: #a52a2a;">)</span>.<span style="color: #a52a2a;">(</span>rank<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">&lt;-</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Piece</span> <span style="color: #a52a2a;">(</span>piece_of_char piece<span style="color: #a52a2a;">)</span>
                   <span style="color: #a020f0;">with</span>
                   <span style="color: #a52a2a;">|</span> <span style="color: #483d8b;">Invalid_argument</span> _ <span style="color: #a52a2a;">-&gt;</span>
                     <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"too many squares on one rank"</span><span style="color: #a52a2a;">)</span>
                   <span style="color: #a52a2a;">|</span> <span style="color: #483d8b;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span>
                     <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"not a piece"</span><span style="color: #a52a2a;">)</span>
                 <span style="color: #000000; font-weight: bold;">end</span> <span style="color: #a52a2a;">;</span>
                 incr file
             <span style="color: #a52a2a;">)</span> rank_string
        <span style="color: #a52a2a;">)</span> ranks <span style="color: #a52a2a;">;</span>
      <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> <span style="color: #a52a2a;">!</span>king_w<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">!</span>king_b <span style="color: #a020f0;">with</span>
        <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> king_w<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> king_b<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> ar<span style="color: #a52a2a;">,</span> king_w<span style="color: #a52a2a;">,</span> king_b
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"white king is missing"</span><span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> _<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"black king is missing"</span><span style="color: #a52a2a;">)</span>
        <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span><span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"both kings are missing"</span><span style="color: #a52a2a;">)</span>
      <span style="color: #000000; font-weight: bold;">end</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"not exactly 8 ranks"</span><span style="color: #a52a2a;">)</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">castling_of_turn</span><span style="color: #a0522d;"> castling</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a52a2a;">(</span><span style="color: #228b22;">String.</span>contains castling <span style="color: #8b2252;">'Q'</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">String.</span>contains castling <span style="color: #8b2252;">'K'</span><span style="color: #a52a2a;">),</span>
    <span style="color: #a52a2a;">(</span><span style="color: #228b22;">String.</span>contains castling <span style="color: #8b2252;">'q'</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">String.</span>contains castling <span style="color: #8b2252;">'q'</span><span style="color: #a52a2a;">)</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">turn_of_fen</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span> <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">"w"</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">"b"</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span>
                             <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"whose move is it?"</span><span style="color: #a52a2a;">)</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">en_passant_of_fen</span><span style="color: #a0522d;"> square</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> square <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #8b2252;">"-"</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>file_of_char square.<span style="color: #a52a2a;">[</span>0<span style="color: #a52a2a;">])</span> <span style="color: #a020f0;">with</span>
          _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"en passant square couldn't be parsed"</span><span style="color: #a52a2a;">)</span>
      <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">position_of_fen</span><span style="color: #a0522d;"> fen</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">fields</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Js.String.</span>split <span style="color: #8b2252;">" "</span> fen <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Array.</span>to_list <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a020f0;">match</span> fields <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[</span>board<span style="color: #a52a2a;">;</span> turn<span style="color: #a52a2a;">;</span> castling<span style="color: #a52a2a;">;</span> en_passant<span style="color: #a52a2a;">;</span> irr_change<span style="color: #a52a2a;">;</span> full_move<span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ar</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> king_w</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> king_b</span> <span style="color: #a52a2a;">=</span> board_of_fen board <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">cas_w</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cas_b</span> <span style="color: #a52a2a;">=</span> castling_of_turn castling <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">turn</span> <span style="color: #a52a2a;">=</span> turn_of_fen turn <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #a52a2a;">{</span> ar
      <span style="color: #a52a2a;">;</span> king_w
      <span style="color: #a52a2a;">;</span> king_b
      <span style="color: #a52a2a;">;</span> turn
      <span style="color: #a52a2a;">;</span> cas_w
      <span style="color: #a52a2a;">;</span> cas_b
      <span style="color: #a52a2a;">;</span> en_passant <span style="color: #a52a2a;">=</span> en_passant_of_fen en_passant
      <span style="color: #a52a2a;">;</span> irr_change <span style="color: #a52a2a;">=</span>
          <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">try</span> int_of_string irr_change <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span>
             <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"halfmove clock couldn't be parsed"</span><span style="color: #a52a2a;">))</span>
      <span style="color: #a52a2a;">;</span> number <span style="color: #a52a2a;">=</span>
          <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span>
              <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">number'</span> <span style="color: #a52a2a;">=</span> int_of_string full_move <span style="color: #a52a2a;">*</span> 2 <span style="color: #000000; font-weight: bold;">in</span>
              <span style="color: #a020f0;">match</span> turn <span style="color: #a020f0;">with</span>
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">White</span> <span style="color: #a52a2a;">-&gt;</span> number' <span style="color: #a52a2a;">-</span> 2
              <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Black</span> <span style="color: #a52a2a;">-&gt;</span> number' <span style="color: #a52a2a;">-</span> 1
            <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span>
              <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"fullmove clock couldn't be parsed"</span><span style="color: #a52a2a;">)</span>
          <span style="color: #000000; font-weight: bold;">end</span>
      <span style="color: #a52a2a;">;</span> prev <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span>
      <span style="color: #a52a2a;">;</span> eval <span style="color: #a52a2a;">=</span> 0
      <span style="color: #a52a2a;">}</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #8b2252;">"too many or missing fields"</span><span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
To make autoplay work, send a <code>Make_move</code> message whenever the user
makes a move on the board:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Board_msg</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Random_move</span> move <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> cmd</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Game.</span>update <span style="color: #a52a2a;">(</span>model <span style="color: #a52a2a;">|</span>. model.game<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Game.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">autoplay_cmd</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> model.stockfish<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Chess.</span>game_status game.position <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> stockfish<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Play</span> _ <span style="color: #a020f0;">when</span> stockfish.autoplay <span style="color: #a52a2a;">-&gt;</span>
        game.position
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Chess.FEN.</span>fen_of_position
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Stockfish.</span>make_move
        <span style="color: #a52a2a;">|&gt;</span> stockfish_msg
        <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Cmd.</span>msg
      <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Cmd.</span>none <span style="color: #000000; font-weight: bold;">in</span>
    model <span style="color: #a52a2a;">|&gt;</span> model.game <span style="color: #a52a2a;">^=</span> game<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>batch <span style="color: #a52a2a;">[</span><span style="color: #228b22;">Cmd.</span>map game_msg cmd<span style="color: #a52a2a;">;</span> autoplay_cmd<span style="color: #a52a2a;">]</span>
</pre>
</div>

<p>
Enjoy your games against the computer!
</p>
</div>
</div>
</div>

<div id="outline-container-org9618de5" class="outline-2">
<h2 id="part-viii"><a id="org9618de5"></a>Part VIII: A move tree view</h2>
<div class="outline-text-2" id="text-part-viii">
<p>
<p class="up"><a href="#">up</a></p>
</p>
</div>
<div id="outline-container-orgb2b7cbd" class="outline-3">
<h3 id="orgb2b7cbd">Fully functional: Tree zippers!</h3>
<div class="outline-text-3" id="text-orgb2b7cbd">
<p>
Let&rsquo;s finally turn our move list into a move tree. Since we have been using list
zippers to make navigation easier, we will implement tree zippers now.
Tree zippers are much like list zippers in that they are a pair of a
context and an inner tree.  (Remember that list zippers were a pair of
a context [&ldquo;past&rdquo;] and a list [&ldquo;future&rdquo;].)  For trees, the situation
is a little trickier.  We will first examine our data structure and
then derive a custom zipper structure for it.  There is a general
approach of viewing <a href="https://pavpanchekha.com/blog/zippers/derivative.html">zippers as derivatives</a>, a technique first
described <a href="http://strictlypositive.org/diff.pdf">by Conor McBride</a>.
</p>

<p>
Let&rsquo;s first see what a game tree should look like:  A node of this
tree is a move together with a list of alternative variations.  A
variation is a move together with a list of followup moves. Taken
together, this gives us a recursive type:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a node</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a020f0;">of</span> 'a <span style="color: #a52a2a;">*</span> 'a variation list
<span style="color: #000000; font-weight: bold;">and</span> 'a variation <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a020f0;">of</span> 'a <span style="color: #a52a2a;">*</span> 'a line
<span style="color: #000000; font-weight: bold;">and</span> 'a line <span style="color: #a52a2a;">=</span> 'a node list
</pre>
</div>

<p>
A tree context is a context that points to the beginning of a line (a
<i>line context</i>),
together with a context within that line (the <i>past</i>).  A line context
tells you what line you&rsquo;re in: it&rsquo;s either the main line of the game,
or a pointer to a node (that&rsquo;s a tree context), plus the future that
would follow that context (including the main line move), and then we
dive into the variations, zipping the variations before and the
variations after. I&rsquo;ll make an illustration one day, I promise :-)
Until then, you need to make do with <a href="http://blog.ezyang.com/2010/04/you-could-have-invented-zippers/">&ldquo;You could have invented
zippers&rdquo;</a>, which discusses tree zippers for a slightly simpler tree structure.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a tree_context</span> <span style="color: #a52a2a;">=</span> 'a line_context  <span style="color: #b22222;">(* </span><span style="color: #b22222;">outer context </span><span style="color: #b22222;">*)</span>
                       <span style="color: #a52a2a;">*</span> 'a line        <span style="color: #b22222;">(* </span><span style="color: #b22222;">past </span><span style="color: #b22222;">*)</span>

<span style="color: #000000; font-weight: bold;">and</span> 'a line_context <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a020f0;">of</span> 'a tree_context       <span style="color: #b22222;">(* </span><span style="color: #b22222;">outer context with past </span><span style="color: #b22222;">*)</span>
                <span style="color: #a52a2a;">*</span> 'a                  <span style="color: #b22222;">(* </span><span style="color: #b22222;">main line move </span><span style="color: #b22222;">*)</span>
                <span style="color: #a52a2a;">*</span> 'a variation list   <span style="color: #b22222;">(* </span><span style="color: #b22222;">variations before </span><span style="color: #b22222;">*)</span>
                <span style="color: #a52a2a;">*</span> 'a                  <span style="color: #b22222;">(* </span><span style="color: #b22222;">move starting this variation </span><span style="color: #b22222;">*)</span>
                <span style="color: #a52a2a;">*</span> 'a variation list   <span style="color: #b22222;">(* </span><span style="color: #b22222;">variations after </span><span style="color: #b22222;">*)</span>
                <span style="color: #a52a2a;">*</span> 'a line             <span style="color: #b22222;">(* </span><span style="color: #b22222;">future </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
Together, that defines our zipper:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a tree_zipper</span> <span style="color: #a52a2a;">=</span> 'a tree_context <span style="color: #a52a2a;">*</span> 'a line
</pre>
</div>

<p>
Some of the functions to navigate the tree zipper are surprisingly similar to
the list zipper:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">No_variations</span>
<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">No_next_variation</span>
<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">No_prev_variation</span>
<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">Not_in_variation</span>
<span style="color: #a020f0;">exception</span> <span style="color: #a0522d;">Not_beginning_of_list</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_fwd</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> future <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">End_of_list</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span><span style="color: #a52a2a;">(</span>item<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">as</span> hd<span style="color: #a52a2a;">::</span>future' <span style="color: #a52a2a;">-&gt;</span> item<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>context<span style="color: #a52a2a;">,</span> hd<span style="color: #a52a2a;">::</span>past<span style="color: #a52a2a;">),</span> future'<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_back</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> context<span style="color: #a52a2a;">,</span> past <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> context<span style="color: #a52a2a;">,</span> hd<span style="color: #a52a2a;">::</span>past' <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">(</span>context<span style="color: #a52a2a;">,</span> past'<span style="color: #a52a2a;">),</span> hd<span style="color: #a52a2a;">::</span>future
  <span style="color: #a52a2a;">|</span> _<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Beginning_of_list</span>

</pre>
</div>

<p>
The functions to move into a variation, out of a variation and to the
next and previous variation (provided one is at the start of a line)
come down to some intricate pattern matching.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">rewinds one step and jumps into the first variation </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_down</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> past <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Beginning_of_list</span>
  <span style="color: #a52a2a;">|</span> node<span style="color: #a52a2a;">::</span>past' <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #a020f0;">match</span> node <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>_<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[])</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_variations</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>main<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>var<span style="color: #a52a2a;">,</span> line<span style="color: #a52a2a;">)::</span>variations<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">context'</span> <span style="color: #a52a2a;">=</span>
        <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">((</span>context<span style="color: #a52a2a;">,</span> past'<span style="color: #a52a2a;">),</span> main<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[],</span> var<span style="color: #a52a2a;">,</span> variations<span style="color: #a52a2a;">,</span> future<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
      var<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>context'<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> line<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_next</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> past<span style="color: #a52a2a;">,</span> context <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_next_variation</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>_<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[],</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_next_variation</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>context'<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span> left<span style="color: #a52a2a;">,</span> var<span style="color: #a52a2a;">,</span>
                  <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>next<span style="color: #a52a2a;">,</span> line<span style="color: #a52a2a;">)::</span>right<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">var'</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span>
        <span style="color: #a52a2a;">(</span>context'<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>var<span style="color: #a52a2a;">,</span> future<span style="color: #a52a2a;">)::</span>left<span style="color: #a52a2a;">,</span> next<span style="color: #a52a2a;">,</span> right<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    next<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>var'<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> line<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_beginning_of_list</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_prev</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> past<span style="color: #a52a2a;">,</span> context <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_prev_variation</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>_<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[],</span> _<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_prev_variation</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>context'<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span>
                  <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>prev<span style="color: #a52a2a;">,</span> line<span style="color: #a52a2a;">)::</span>left<span style="color: #a52a2a;">,</span> var<span style="color: #a52a2a;">,</span> right<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">var'</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span>
        <span style="color: #a52a2a;">(</span>context'<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span> left<span style="color: #a52a2a;">,</span> prev<span style="color: #a52a2a;">,</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>var<span style="color: #a52a2a;">,</span> future<span style="color: #a52a2a;">)::</span>right<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    prev<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>var'<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> line<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_beginning_of_list</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_up</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> past<span style="color: #a52a2a;">,</span> context <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Not_in_variation</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[],</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">((</span>context'<span style="color: #a52a2a;">,</span> past'<span style="color: #a52a2a;">),</span> main<span style="color: #a52a2a;">,</span> left<span style="color: #a52a2a;">,</span> var<span style="color: #a52a2a;">,</span> right<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">variations</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>rev_append left <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>var<span style="color: #a52a2a;">,</span> future<span style="color: #a52a2a;">)::</span>right<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">main_node</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>main<span style="color: #a52a2a;">,</span> variations<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
    main<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>context'<span style="color: #a52a2a;">,</span> main_node<span style="color: #a52a2a;">::</span>past'<span style="color: #a52a2a;">),</span> future'<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> Not_beginning_of_list
</pre>
</div>

<p>
This is the trickiest: trying to insert a move into the zipper may
move within the existing line or jump into a variation. We return 0 or
1, respectively, if we want to keep track of the depth.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_fwd'</span><span style="color: #a0522d;"> item </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> future <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> 0<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>context<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>item<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[])::</span>past<span style="color: #a52a2a;">)),</span> <span style="color: #a52a2a;">[])</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>main<span style="color: #a52a2a;">,</span> _<span style="color: #a52a2a;">)</span> <span style="color: #a020f0;">as</span> hd<span style="color: #a52a2a;">::</span>future' <span style="color: #a020f0;">when</span> main <span style="color: #a52a2a;">=</span> item <span style="color: #a52a2a;">-&gt;</span>
    1<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">((</span>context<span style="color: #a52a2a;">,</span> hd<span style="color: #a52a2a;">::</span>past<span style="color: #a52a2a;">),</span> future'<span style="color: #a52a2a;">)</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>main<span style="color: #a52a2a;">,</span> variations<span style="color: #a52a2a;">)::</span>future' <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">tree_fwd_var</span><span style="color: #a0522d;"> item left right</span> <span style="color: #a52a2a;">=</span>
      <span style="color: #a020f0;">match</span> right <span style="color: #a020f0;">with</span>
      <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">inner_context</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>context<span style="color: #a52a2a;">,</span> past<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">context'</span> <span style="color: #a52a2a;">=</span>
          <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>inner_context<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span> left<span style="color: #a52a2a;">,</span> item<span style="color: #a52a2a;">,</span> right<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">(</span>context'<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> <span style="color: #a52a2a;">[]</span>
      <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>var<span style="color: #a52a2a;">,</span> line<span style="color: #a52a2a;">)::</span>right' <span style="color: #a020f0;">when</span> item <span style="color: #a52a2a;">=</span> var <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">inner_context</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>context<span style="color: #a52a2a;">,</span> past<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">context'</span> <span style="color: #a52a2a;">=</span>
          <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>inner_context<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span> left<span style="color: #a52a2a;">,</span> var<span style="color: #a52a2a;">,</span> right'<span style="color: #a52a2a;">,</span> future'<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #a52a2a;">(</span>context'<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> line
      <span style="color: #a52a2a;">|</span> variation<span style="color: #a52a2a;">::</span>right' <span style="color: #a52a2a;">-&gt;</span> tree_fwd_var item <span style="color: #a52a2a;">(</span>variation<span style="color: #a52a2a;">::</span>left<span style="color: #a52a2a;">)</span> right' <span style="color: #000000; font-weight: bold;">in</span>
    1<span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">(</span>tree_fwd_var item <span style="color: #a52a2a;">[]</span> variations<span style="color: #a52a2a;">)</span>
</pre>
</div>

<p>
Our tree zipper is ready to be used :-)
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">tree_init</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">()</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span><span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> <span style="color: #a52a2a;">[]</span>  <span style="color: #b22222;">(* </span><span style="color: #b22222;">outer context + past + future </span><span style="color: #b22222;">*)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org59c1833" class="outline-3">
<h3 id="org59c1833">Building a zipper recursively</h3>
<div class="outline-text-3" id="text-org59c1833">
<p>
Let&rsquo;s build a game zipper from a parsed PGN game.  This is basically
the same structure as the PGN parser itself, a group of mutually
recursive functions.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_of_pgn'</span><span style="color: #a0522d;"> pgn</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">line_of_pgn</span><span style="color: #a0522d;"> position</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">[]</span>
    <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>tl <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">node</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> position'</span> <span style="color: #a52a2a;">=</span> node_of_pgn position hd <span style="color: #000000; font-weight: bold;">in</span>
      node<span style="color: #a52a2a;">::</span>line_of_pgn position' tl
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">variation_of_pgn</span><span style="color: #a0522d;"> position</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
    <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>tl <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> position'</span> <span style="color: #a52a2a;">=</span> move_of_pgn position hd <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #228b22;">Zipper.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span> <span style="color: #a52a2a;">(</span>move<span style="color: #a52a2a;">,</span> line_of_pgn position' tl<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #228b22;">Pgn.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span>
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">move_of_pgn</span><span style="color: #a0522d;"> position pgn_move</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Pgn.</span>move_of_pgn_move position pgn_move.<span style="color: #228b22;">Pgn.</span>move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>san_of_move position move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> move
    <span style="color: #a52a2a;">;</span> san
    <span style="color: #a52a2a;">;</span> pre_comments <span style="color: #a52a2a;">=</span> pgn_move.pre_comments
    <span style="color: #a52a2a;">;</span> post_comments <span style="color: #a52a2a;">=</span> pgn_move.post_comments
    <span style="color: #a52a2a;">},</span> <span style="color: #228b22;">Chess.</span>make_move' position move
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">node_of_pgn</span><span style="color: #a0522d;"> position pgn_move</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">rav</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span>variation_of_pgn position<span style="color: #a52a2a;">)</span> pgn_move.<span style="color: #228b22;">Pgn.</span>rav <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> position'</span> <span style="color: #a52a2a;">=</span> move_of_pgn position pgn_move <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #228b22;">Zipper.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span> <span style="color: #a52a2a;">(</span>move<span style="color: #a52a2a;">,</span> rav<span style="color: #a52a2a;">),</span> position'

  <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game</span> <span style="color: #a52a2a;">=</span> 
    <span style="color: #a020f0;">try</span> <span style="color: #228b22;">Pgn.</span>parse_pgn pgn <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Option.</span>get
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Invalid_argument</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: #228b22;">Pgn.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Parse_error</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init_fen</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">try</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">List.</span>assoc <span style="color: #8b2252;">"FEN"</span> game.header<span style="color: #a52a2a;">)</span>
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Not_found</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">init_position</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #228b22;">Option.</span>default_map
      <span style="color: #228b22;">Chess.FEN.</span>position_of_fen <span style="color: #228b22;">Chess.</span>init_position init_fen <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span> line_of_pgn init_position game.moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span> position <span style="color: #a52a2a;">=</span> init_position
  <span style="color: #a52a2a;">;</span> header <span style="color: #a52a2a;">=</span> game.header
  <span style="color: #a52a2a;">;</span> moves <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">Zipper.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span><span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">[]),</span> moves
  <span style="color: #a52a2a;">;</span> result <span style="color: #a52a2a;">=</span> game.result
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_of_pgn</span><span style="color: #a0522d;"> pgn</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">try</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> <span style="color: #a52a2a;">(</span>game_of_pgn' pgn<span style="color: #a52a2a;">)</span>
  <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> 
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ce1bb6" class="outline-3">
<h3 id="org0ce1bb6">Inside-out folds</h3>
<div class="outline-text-3" id="text-org0ce1bb6">
<p>
Now let&rsquo;s tackle the other side of the coin, serialization of a zipper
and the move view.
We will try to abstract as much as possible in this section.  Since
both PGN serialization and the move tree view involve building the
tree structure that underlies the game zipper, we will implement a
generic tree zipper &ldquo;fold&rdquo;-like function that traverses and maps the
zipper.
</p>

<p>
First, let&rsquo;s write two helper functions.  These are similar to the
&ldquo;past&rdquo; and &ldquo;future&rdquo; folds that we implemented earlier, but take two
additional parameters: a second accumulator <code>c</code> that regardless of the
direction of the fold is carried along from the front of the list
(this will hold the state of the traversal, like the move number), and
a function <code>g</code> that computes the next state after each step.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">id</span><span style="color: #a0522d;"> x</span> <span style="color: #a52a2a;">=</span> x

<span style="color: #b22222;">(* </span><span style="color: #b22222;">fold_right' is like right fold, but carrying an additional </span>
<span style="color: #b22222;">   accumulator c that is updated by g and applied together with f </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fold_right'</span><span style="color: #a0522d;"> f g</span> <span style="color: #a52a2a;">=</span>  <span style="color: #b22222;">(* </span><span style="color: #b22222;">c l </span><span style="color: #b22222;">*)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span><span style="color: #a0522d;"> cont c</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
    <span style="color: #a52a2a;">|</span> hd<span style="color: #a52a2a;">::</span>tl <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">c'</span> <span style="color: #a52a2a;">=</span> g c <span style="color: #000000; font-weight: bold;">in</span>
      loop <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">acc'</span> <span style="color: #a52a2a;">-&gt;</span> cont <span style="color: #a52a2a;">(</span>f c hd<span style="color: #a52a2a;">::</span>acc'<span style="color: #a52a2a;">))</span> c' tl
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> cont <span style="color: #a52a2a;">[]</span>
  <span style="color: #000000; font-weight: bold;">in</span> loop id

<span style="color: #b22222;">(* </span><span style="color: #b22222;">fold_left' is like left fold, but carrying an additional </span>
<span style="color: #b22222;">   accumulator c that is updated by g and applied together with f </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fold_left'</span><span style="color: #a0522d;"> f g c l acc</span> <span style="color: #a52a2a;">=</span>  
  <span style="color: #228b22;">List.</span>fold_left
    <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #a0522d;">acc</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> c</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> item</span> <span style="color: #a52a2a;">-&gt;</span> f c item<span style="color: #a52a2a;">::</span>acc<span style="color: #a52a2a;">,</span> g c<span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">(</span>acc<span style="color: #a52a2a;">,</span> c<span style="color: #a52a2a;">)</span> l
</pre>
</div>

<p>
Now we&rsquo;re ready for the &ldquo;meat&rdquo; of this section, a general &ldquo;fold&rdquo;-like
function that turns a zipper into a tree, parameterized by the
following functions:
</p>

<ul class="org-ul">
<li><code>make_move</code> formats a move according to the &ldquo;state&rdquo; accumulator</li>
<li><code>make_line</code> maps a list of moves</li>
<li><code>make_variation</code> wraps a line that is a variation</li>
<li><code>make_variations</code> maps a list of variations</li>
<li><code>make_mainline</code> wraps the main line</li>
</ul>

<p>
Additionally, we supply the initial state accumulator and functions
that change the state accumulator on its way inside the zipper.
</p>

<p>
This function looks scary at first.  There are two different groups of
mutually recursive functions here.  The first group could be called
&ldquo;top-down&rdquo; functions since they operate on the tree (past/future) parts of the
zipper.  Similar to the mutually recursive PGN parser functions, they
build up the &ldquo;triad&rdquo; of moves, lines and variation lists.
</p>

<p>
The second group of functions is the &ldquo;bottom-up&rdquo; functions that build
up the context part of the zipper, branching out into the &ldquo;top-down&rdquo;
functions when needed.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">Generic map-fold catamorphism for move tree </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fold_zipper</span>
<span style="color: #a0522d;">    </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">make_mainline </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">make_line </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">make_variation </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">make_variations </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">make_move</span>
<span style="color: #a0522d;">    </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">acc </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">fwd </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">back </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">up </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">down </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">next </span><span style="color: #a52a2a;">~</span><span style="color: #a0522d;">prev </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">fold_node</span><span style="color: #a0522d;"> acc </span><span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Node</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> variations</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">=</span>
    fold_variations acc variations
    <span style="color: #a52a2a;">|&gt;</span> make_move acc move
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">fold_variations</span><span style="color: #a0522d;"> acc variations</span> <span style="color: #a52a2a;">=</span>
    fold_right' fold_variation next <span style="color: #a52a2a;">(</span>down acc<span style="color: #a52a2a;">)</span> variations
    <span style="color: #a52a2a;">|&gt;</span> make_variations
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">fold_variation</span><span style="color: #a0522d;"> acc </span><span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> line</span><span style="color: #a52a2a;">))</span> <span style="color: #a52a2a;">=</span>
    make_move acc move <span style="color: #a52a2a;">(</span>make_variations <span style="color: #a52a2a;">[])::</span>fold_future <span style="color: #a52a2a;">(</span>fwd acc<span style="color: #a52a2a;">)</span> line
    <span style="color: #a52a2a;">|&gt;</span> make_line
    <span style="color: #a52a2a;">|&gt;</span> make_variation
  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">fold_future</span><span style="color: #a0522d;"> acc list</span> <span style="color: #a52a2a;">=</span> fold_right' fold_node fwd acc list <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fold_past</span><span style="color: #a0522d;"> acc list</span> <span style="color: #a52a2a;">=</span> fold_left' fold_node back acc list <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">fold_tree_context</span><span style="color: #a0522d;"> acc </span><span style="color: #a52a2a;">((</span><span style="color: #a0522d;">context</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> past</span><span style="color: #a52a2a;">),</span><span style="color: #a0522d;"> future</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> inner</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">fold_acc</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> acc'</span> <span style="color: #a52a2a;">=</span>
      inner<span style="color: #a52a2a;">::</span>fold_future <span style="color: #a52a2a;">(</span>fwd acc<span style="color: #a52a2a;">)</span> future
      <span style="color: #a52a2a;">|&gt;</span> fold_past <span style="color: #a52a2a;">(</span>back acc<span style="color: #a52a2a;">)</span> past <span style="color: #000000; font-weight: bold;">in</span>
    fold_line_context acc' context fold_acc

  <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #0000ff;">fold_line_context</span><span style="color: #a0522d;"> acc context inner</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #a020f0;">match</span> context <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Main_line</span> <span style="color: #a52a2a;">-&gt;</span> make_mainline acc inner
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Var_line</span> <span style="color: #a52a2a;">(</span>context<span style="color: #a52a2a;">,</span> main<span style="color: #a52a2a;">,</span> left<span style="color: #a52a2a;">,</span> var_move<span style="color: #a52a2a;">,</span> right<span style="color: #a52a2a;">,</span> future<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">this_var</span> <span style="color: #a52a2a;">=</span> make_move acc var_move <span style="color: #a52a2a;">(</span>make_variations <span style="color: #a52a2a;">[])::</span>inner
                     <span style="color: #a52a2a;">|&gt;</span> make_line
                     <span style="color: #a52a2a;">|&gt;</span> make_variation <span style="color: #000000; font-weight: bold;">in</span>
      this_var<span style="color: #a52a2a;">::(</span>fold_right' fold_variation next <span style="color: #a52a2a;">(</span>next acc<span style="color: #a52a2a;">)</span> right<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">|&gt;</span> fold_left' fold_variation prev <span style="color: #a52a2a;">(</span>prev acc<span style="color: #a52a2a;">)</span> left
      <span style="color: #a52a2a;">|&gt;</span> fst
      <span style="color: #a52a2a;">|&gt;</span> make_variations
      <span style="color: #a52a2a;">|&gt;</span> make_move <span style="color: #a52a2a;">(</span>up acc<span style="color: #a52a2a;">)</span> main 
      <span style="color: #a52a2a;">|&gt;</span> fold_tree_context <span style="color: #a52a2a;">(</span>up acc<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(</span>context<span style="color: #a52a2a;">,</span> future<span style="color: #a52a2a;">)</span> <span style="color: #000000; font-weight: bold;">in</span>

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">fold_acc</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> acc'</span> <span style="color: #a52a2a;">=</span> fold_future <span style="color: #a52a2a;">(</span>fwd acc<span style="color: #a52a2a;">)</span> future
                       <span style="color: #a52a2a;">|&gt;</span> fold_past acc past <span style="color: #000000; font-weight: bold;">in</span>
  fold_line_context acc' context fold_acc
  <span style="color: #a52a2a;">|&gt;</span> make_line
</pre>
</div>
</div>
</div>

<div id="outline-container-org32fd650" class="outline-3">
<h3 id="org32fd650"><span class="todo TODO">TODO</span> Move tree view and proper PGN serialization</h3>
<div class="outline-text-3" id="text-org32fd650">
<p>
We can now use the generic tree zipper fold for both the move tree
view and PGN serialization, just by supplying the right functions:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">id</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">x</span> <span style="color: #a52a2a;">-&gt;</span> x<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">pgn_of_game</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">acc</span> <span style="color: #a52a2a;">=</span> model.position.number <span style="color: #a52a2a;">-</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fwd</span><span style="color: #a0522d;"> ply</span> <span style="color: #a52a2a;">=</span> ply <span style="color: #a52a2a;">+</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">back</span><span style="color: #a0522d;"> ply</span> <span style="color: #a52a2a;">=</span> ply <span style="color: #a52a2a;">-</span> 1 <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_line</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">String.</span>concat <span style="color: #8b2252;">" "</span> moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_variation</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"(%s)"</span> moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_variations</span><span style="color: #a0522d;"> var</span> <span style="color: #a52a2a;">=</span> var <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_comment</span><span style="color: #a0522d;"> comment</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"{%s}"</span> comment <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_move</span><span style="color: #a0522d;"> acc move variations</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">number</span> <span style="color: #a52a2a;">=</span> acc <span style="color: #a52a2a;">/</span> 2 <span style="color: #a52a2a;">+</span> 1
    <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">w_move</span> <span style="color: #a52a2a;">=</span> acc <span style="color: #a52a2a;">mod</span> 2 <span style="color: #a52a2a;">=</span> 0 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">pre_comments</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>map make_comment move.pre_comments <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">post_comments</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">List.</span>map make_comment move.post_comments <span style="color: #000000; font-weight: bold;">in</span>
    pre_comments <span style="color: #a52a2a;">@</span>
    <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">if</span> w_move <span style="color: #a020f0;">then</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%d."</span> number<span style="color: #a52a2a;">::</span>move.san<span style="color: #a52a2a;">::</span>post_comments
     <span style="color: #a020f0;">else</span> move.san<span style="color: #a52a2a;">::</span>post_comments<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">@</span> variations
    <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">String.</span>concat <span style="color: #8b2252;">" "</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_mainline</span><span style="color: #a0522d;"> _acc line</span> <span style="color: #a52a2a;">=</span> line <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">moves</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #228b22;">Zipper.</span>fold_zipper
      <span style="color: #a52a2a;">~</span>make_mainline <span style="color: #a52a2a;">~</span>make_line <span style="color: #a52a2a;">~</span>make_variation <span style="color: #a52a2a;">~</span>make_variations <span style="color: #a52a2a;">~</span>make_move
      <span style="color: #a52a2a;">~</span>acc <span style="color: #a52a2a;">~</span>fwd <span style="color: #a52a2a;">~</span>back <span style="color: #008b8b;">~up</span><span style="color: #a52a2a;">:</span>id <span style="color: #008b8b;">~down</span><span style="color: #a52a2a;">:</span>id <span style="color: #008b8b;">~next</span><span style="color: #a52a2a;">:</span>id <span style="color: #008b8b;">~prev</span><span style="color: #a52a2a;">:</span>id model.moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">headers</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #228b22;">List.</span>map <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a52a2a;">(</span><span style="color: #a0522d;">k</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> v</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"[%s \"%s\"]"</span> k v<span style="color: #a52a2a;">)</span> model.header
    <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">String.</span>concat <span style="color: #8b2252;">"\n"</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">Printf.</span>sprintf <span style="color: #8b2252;">"%s\n\n%s %s"</span> headers moves <span style="color: #a52a2a;">(</span>string_of_result model.result<span style="color: #a52a2a;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">move_list_view</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>ply <span style="color: #a52a2a;">=</span> model.position.number <span style="color: #a52a2a;">-</span> 1<span style="color: #a52a2a;">;</span> actions <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[]}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fwd</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>ply <span style="color: #a52a2a;">=</span> acc.ply <span style="color: #a52a2a;">+</span> 1<span style="color: #a52a2a;">;</span> actions <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Fwd</span><span style="color: #a52a2a;">::</span>acc.actions<span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">back</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>ply <span style="color: #a52a2a;">=</span> acc.ply <span style="color: #a52a2a;">-</span> 1<span style="color: #a52a2a;">;</span> actions <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Back</span><span style="color: #a52a2a;">::</span>acc.actions<span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">down</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>acc <span style="color: #a020f0;">with</span> actions <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Down</span><span style="color: #a52a2a;">::</span>acc.actions<span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">prev</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>acc <span style="color: #a020f0;">with</span> actions <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Prev</span><span style="color: #a52a2a;">::</span>acc.actions<span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">next</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>acc <span style="color: #a020f0;">with</span> actions <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Next</span><span style="color: #a52a2a;">::</span>acc.actions<span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">up</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">{</span>acc <span style="color: #a020f0;">with</span> actions <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Up</span><span style="color: #a52a2a;">::</span>acc.actions<span style="color: #a52a2a;">}</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">make_line</span> <span style="color: #a52a2a;">=</span> ul <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"moves"</span><span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_variation</span><span style="color: #a0522d;"> var</span> <span style="color: #a52a2a;">=</span> li <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"variation"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>var<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_variations</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
    <span style="color: #a52a2a;">|</span> <span style="color: #a52a2a;">[]</span> <span style="color: #a52a2a;">-&gt;</span> noNode
    <span style="color: #a52a2a;">|</span> variations <span style="color: #a52a2a;">-&gt;</span> ol <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"variations"</span><span style="color: #a52a2a;">]</span> variations <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_comment</span><span style="color: #a0522d;"> comment</span> <span style="color: #a52a2a;">=</span> span <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"comment"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span>text comment<span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_move</span><span style="color: #a0522d;"> acc move variations</span> <span style="color: #a52a2a;">=</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">number</span> <span style="color: #a52a2a;">=</span> acc.ply <span style="color: #a52a2a;">/</span> 2 <span style="color: #a52a2a;">+</span> 1
    <span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">w_move</span> <span style="color: #a52a2a;">=</span> acc.ply <span style="color: #a52a2a;">mod</span> 2 <span style="color: #a52a2a;">=</span> 0 <span style="color: #000000; font-weight: bold;">in</span>
    li <span style="color: #a52a2a;">[</span> classList
           <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"move"</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
           <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"white"</span><span style="color: #a52a2a;">,</span> w_move
           <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"black"</span><span style="color: #a52a2a;">,</span> <span style="color: #a52a2a;">not</span> w_move
           <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"variations"</span><span style="color: #a52a2a;">,</span> variations <span style="color: #a52a2a;">&lt;&gt;</span> noNode
           <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"highlight"</span><span style="color: #a52a2a;">,</span> acc.actions <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[]</span>
           <span style="color: #a52a2a;">]</span>
       <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> span <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"comments"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">List.</span>map make_comment move.pre_comments<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"number"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">[</span> string_of_int number <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">;</span> span
          <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"move"</span>
          <span style="color: #a52a2a;">;</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Jump</span> acc.actions<span style="color: #a52a2a;">)</span>
          <span style="color: #a52a2a;">]</span>
          <span style="color: #a52a2a;">[</span> move.san <span style="color: #a52a2a;">|&gt;</span> text <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">;</span> span <span style="color: #a52a2a;">[</span>class' <span style="color: #8b2252;">"comments"</span><span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">(</span><span style="color: #228b22;">List.</span>map make_comment move.post_comments<span style="color: #a52a2a;">)</span>
      <span style="color: #a52a2a;">;</span> variations <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">home_view</span><span style="color: #a0522d;"> acc</span> <span style="color: #a52a2a;">=</span>
    li <span style="color: #a52a2a;">[</span> classList <span style="color: #a52a2a;">[</span> <span style="color: #8b2252;">"move"</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"home"</span><span style="color: #a52a2a;">,</span> <span style="color: #008b8b;">true</span>
                   <span style="color: #a52a2a;">;</span> <span style="color: #8b2252;">"highlight"</span><span style="color: #a52a2a;">,</span> acc.actions <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[]</span>
                   <span style="color: #a52a2a;">]</span> <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">[</span> span
          <span style="color: #a52a2a;">[</span> class' <span style="color: #8b2252;">"move"</span>
          <span style="color: #a52a2a;">;</span> onClick <span style="color: #a52a2a;">(</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Jump</span> acc.actions<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span>
          <span style="color: #a52a2a;">[</span> text <span style="color: #8b2252;">{js|\u2302|js}</span> <span style="color: #a52a2a;">]</span>
      <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">make_mainline</span><span style="color: #a0522d;"> acc line</span> <span style="color: #a52a2a;">=</span> home_view acc<span style="color: #a52a2a;">::</span>line <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #228b22;">Zipper.</span>fold_zipper
    <span style="color: #a52a2a;">~</span>make_mainline <span style="color: #a52a2a;">~</span>make_line <span style="color: #a52a2a;">~</span>make_variation <span style="color: #a52a2a;">~</span>make_variations <span style="color: #a52a2a;">~</span>make_move
    <span style="color: #a52a2a;">~</span>acc <span style="color: #a52a2a;">~</span>fwd <span style="color: #a52a2a;">~</span>back <span style="color: #a52a2a;">~</span>up <span style="color: #a52a2a;">~</span>down <span style="color: #a52a2a;">~</span>next <span style="color: #a52a2a;">~</span>prev model.moves
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc2e6ab3" class="outline-3">
<h3 id="orgc2e6ab3"><span class="todo TODO">TODO</span> Navigating in a zipper</h3>
<div class="outline-text-3" id="text-orgc2e6ab3">
<p>
In order to navigate in a move tree view, we need to extend our
&ldquo;vocabulary&rdquo; of navigation primitives.  In a move list, all we needed
was the offset of how many moves we wanted to navigate forward or
backward.  Now, we will represent the path in the move tree by a list
of actions from a variant.  The type <code>acc</code> will serve to carry the
actions list and the move number along in the fold function.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">action</span> <span style="color: #a52a2a;">=</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Fwd</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Back</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Down</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Next</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Prev</span> <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Up</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">acc</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">{</span> ply <span style="color: #a52a2a;">:</span> int
  <span style="color: #a52a2a;">;</span> actions <span style="color: #a52a2a;">:</span> action list
  <span style="color: #a52a2a;">}</span>
</pre>
</div>

<p>
Navigation itself is not tricky:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_back</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">match</span> model.position.prev <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> position <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
                moves <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>tree_back model.moves
              <span style="color: #a52a2a;">;</span> position
              <span style="color: #a52a2a;">}</span>
      <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Zipper.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Beginning_of_list</span> <span style="color: #a52a2a;">-&gt;</span>
        <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
          moves <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>tree_up model.moves <span style="color: #a52a2a;">|&gt;</span> snd <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">Zipper.</span>tree_back
        <span style="color: #a52a2a;">;</span> position
        <span style="color: #a52a2a;">}</span>
    <span style="color: #000000; font-weight: bold;">end</span>
  <span style="color: #a52a2a;">|</span> _ <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_prev_position</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_fwd</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">try</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>tree_fwd model.moves <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
      position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move' model.position move.move
    <span style="color: #a52a2a;">;</span> moves
    <span style="color: #a52a2a;">}</span>
  <span style="color: #a020f0;">with</span> <span style="color: #228b22;">Zipper.</span><span style="color: mac:textColor; background-color: mac:textBackgroundColor;">End_of_list</span> <span style="color: #a52a2a;">-&gt;</span> model

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_make_move</span><span style="color: #a0522d;"> move model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">san</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>san_of_move model.position move <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">_</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Zipper.</span>tree_fwd' <span style="color: #a52a2a;">(</span>simple_move move san<span style="color: #a52a2a;">)</span> model.moves <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
    position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move' model.position move
  <span style="color: #a52a2a;">;</span> moves
  <span style="color: #a52a2a;">}</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">game_rewind_and_make_move</span><span style="color: #a0522d;"> f model</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a020f0;">try</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">move</span><span style="color: #a52a2a;">,</span><span style="color: #a0522d;"> moves</span> <span style="color: #a52a2a;">=</span> f model.moves <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a020f0;">match</span> model.position.prev <span style="color: #a020f0;">with</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Some</span> position <span style="color: #a52a2a;">-&gt;</span>
      <span style="color: #a52a2a;">{</span> model <span style="color: #a020f0;">with</span>
        position <span style="color: #a52a2a;">=</span> <span style="color: #228b22;">Chess.</span>make_move' position move.move
      <span style="color: #a52a2a;">;</span> moves
      <span style="color: #a52a2a;">}</span>
    <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #483d8b;">raise</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">No_prev_position</span>
  <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span> model

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game_next</span> <span style="color: #a52a2a;">=</span> game_rewind_and_make_move <span style="color: #228b22;">Zipper.</span>tree_next
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game_prev</span> <span style="color: #a52a2a;">=</span> game_rewind_and_make_move <span style="color: #228b22;">Zipper.</span>tree_prev
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game_down</span> <span style="color: #a52a2a;">=</span> game_rewind_and_make_move <span style="color: #228b22;">Zipper.</span>tree_down
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">game_up</span> <span style="color: #a52a2a;">=</span> game_rewind_and_make_move <span style="color: #228b22;">Zipper.</span>tree_up
</pre>
</div>

<p>
Here&rsquo;s how we obtain a single function from a list of actions: of
course, using a fold!
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fun_of_action</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Fwd</span> <span style="color: #a52a2a;">-&gt;</span> game_fwd
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Back</span> <span style="color: #a52a2a;">-&gt;</span> game_back
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Down</span> <span style="color: #a52a2a;">-&gt;</span> game_down
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Next</span> <span style="color: #a52a2a;">-&gt;</span> game_next
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Prev</span> <span style="color: #a52a2a;">-&gt;</span> game_prev
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Up</span> <span style="color: #a52a2a;">-&gt;</span> game_up

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a52a2a;">(&lt;&lt;&lt;)</span> f g x <span style="color: #a52a2a;">=</span> f <span style="color: #a52a2a;">(</span>g x<span style="color: #a52a2a;">)</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fun_of_actions</span><span style="color: #a0522d;"> actions</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #228b22;">List.</span>fold_left <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">acc a</span> <span style="color: #a52a2a;">-&gt;</span> acc <span style="color: #a52a2a;">&lt;&lt;&lt;</span> <span style="color: #a52a2a;">(</span>fun_of_action a<span style="color: #a52a2a;">))</span> id actions
</pre>
</div>

<p>
And finally, the <code>update</code> function of <code>Game.ml</code> becomes super easy
because everything has been factored out:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">update</span><span style="color: #a0522d;"> model</span> <span style="color: #a52a2a;">=</span> <span style="color: #a020f0;">function</span>
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Move</span> move <span style="color: #a52a2a;">-&gt;</span>
    game_make_move move model<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Take_back</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> game_back model <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span> model <span style="color: #000000; font-weight: bold;">end</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Forward</span> <span style="color: #a52a2a;">-&gt;</span>
    <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">try</span> game_fwd model <span style="color: #a020f0;">with</span> _ <span style="color: #a52a2a;">-&gt;</span> model <span style="color: #000000; font-weight: bold;">end</span><span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
  <span style="color: #a52a2a;">|</span> <span style="color: mac:textColor; background-color: mac:textBackgroundColor;">Jump</span> actions <span style="color: #a52a2a;">-&gt;</span>
    model <span style="color: #a52a2a;">|&gt;</span> fun_of_actions actions<span style="color: #a52a2a;">,</span> <span style="color: #228b22;">Cmd.</span>none
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb101770" class="outline-3">
<h3 id="orgb101770"><span class="todo TODO">TODO</span> The final touches (CSS)</h3>
<div class="outline-text-3" id="text-orgb101770">
<p>
Let&rsquo;s add some CSS to make the move tree look nice.  We&rsquo;ll make
subvariations a little smaller and assign different list styles.  Also
note the various CSS selector tricks to show the move numbers at the
beginning of a variation and after a variation.
</p>

<div class="org-src-container">
<pre class="src src-css">li.move.home + li.move &gt; span.number,
li.move.white &gt; span.number,
ul.moves &gt; li:first-child &gt; span.number,
<span style="color: #0000ff;">li.move.variations + li.move &gt; span.number </span>{
    <span style="color: #a020f0;">display</span>: inline;
}

<span style="color: #0000ff;">span.comment </span>{
  <span style="color: #a020f0;">color</span>: <span style="color: #ffffff; background-color: #008000;">#008000</span>;
}


<span style="color: #0000ff;">ul.moves </span>{
    <span style="color: #a020f0;">margin</span>: .25em;
    <span style="color: #a020f0;">padding</span>: .25em;
    <span style="color: #a020f0;">list-style-type</span>: none;
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #ffffff;">#ffffff</span>;
}
<span style="color: #0000ff;">ol.variations </span>{
    <span style="color: #a020f0;">list-style-type</span>: upper-latin;
    <span style="color: #a020f0;">padding-left</span>: 20px;
}
<span style="color: #0000ff;">ol.variations ul.moves </span>{
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #f0f0f0;">#f0f0f0</span>;
}
<span style="color: #0000ff;">ol.variations ol.variations </span>{
    <span style="color: #a020f0;">list-style-type</span>: upper-roman;
    <span style="color: #a020f0;">font-size</span>: small;
}
<span style="color: #0000ff;">ol.variations ol.variations ul.moves </span>{
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #ffffff;">#ffffff</span>;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations </span>{
    <span style="color: #a020f0;">list-style-type</span>: lower-latin;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ul.moves </span>{
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #f0f0f0;">#f0f0f0</span>;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ol.variations </span>{
    <span style="color: #a020f0;">list-style-type</span>: lower-roman;
    <span style="color: #a020f0;">font-size</span>: x-small;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ol.variations ul.moves </span>{
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #ffffff;">#ffffff</span>;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ol.variations ol.variations </span>{
    <span style="color: #a020f0;">list-style-type</span>: lower-greek;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ol.variations ol.variations ul.moves </span>{
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #f0f0f0;">#f0f0f0</span>;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ol.variations ol.variations ol.variations </span>{
    <span style="color: #a020f0;">list-style-type</span>: circle;
    <span style="color: #a020f0;">font-size</span>: xx-small;
}
<span style="color: #0000ff;">ol.variations ol.variations ol.variations ol.variations ol.variations ol.variations ul.moves </span>{
    <span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #ffffff;">#ffffff</span>;
}
</pre>
</div>

<p>
THE END :-)
</p>
</div>
</div>
</div>
</div>
</body>
</html>
